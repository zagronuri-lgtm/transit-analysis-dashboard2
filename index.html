<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ (Offline-First)</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#4b5563;
      --line:rgba(17,24,39,.14);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#10b981;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background:#ffffff;
      color:var(--text);
      min-height:100vh;
    }
    a{color:#5b21b6}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:16px 16px;border:1px solid var(--line);border-radius:18px;
      background:#ffffff;
      box-shadow: 0 10px 24px rgba(17,24,39,.08);
    }
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#f9fafb;
      font-size:12px;color:var(--muted)
    }
    .pill b{color:var(--text)}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid.cols2{grid-template-columns:1.2fr .8fr} }
    @media(min-width:980px){ .grid.cols3{grid-template-columns:1fr 1fr 1fr} }
    @media(min-width:980px){ .grid.cols4{grid-template-columns:repeat(4, 1fr)} }
    .card{
      background:#ffffff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(17,24,39,.08);
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      cursor:pointer;
      border:1px solid rgba(17,24,39,.18);
      background:#ffffff;
      color:#111827;
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      transition: transform .08s ease, background .12s ease, box-shadow .12s ease;
      user-select:none;
      box-shadow: 0 4px 10px rgba(17,24,39,.06);
      text-decoration:none;
    }
    .btn:hover{background:#f9fafb}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(124,58,237,.10); border-color: rgba(124,58,237,.35)}
    .btn.green{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.35)}
    .btn.red{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.35)}
    .btn.small{padding:7px 10px;border-radius:12px;font-size:12px}
    .drop{
      padding:18px;
      border-radius:18px;
      border:2px dashed rgba(17,24,39,.20);
      background:#ffffff;
      text-align:center;
    }
    .drop.drag{border-color: rgba(124,58,237,.8); background:#f5f3ff}
    .drop p{margin:6px 0;color:var(--muted)}
    input, select{
      background:#ffffff;
      border:1px solid rgba(17,24,39,.20);
      color:#111827;
      border-radius:12px;
      padding:9px 10px;
      outline:none;
      min-height:38px;
    }
    input[type="date"]{color-scheme: light;}
    input[type="range"]{width:220px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .field{min-width:170px}
    .mono{font-family:var(--mono)}
    .kpi{
      padding:12px;border-radius:18px;border:1px solid var(--line);
      background:#ffffff;
      box-shadow: 0 10px 24px rgba(17,24,39,.06);
    }
    .kpi .v{font-size:22px;font-weight:900;line-height:1.1}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:5px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:#f9fafb;
      font-size:12px;color:var(--muted)
    }
    .badge.good{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .badge.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .badge.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .badge.purp{background:#f5f3ff;border-color:#ddd6fe;color:#5b21b6}
    .tableWrap{overflow:auto;max-height:440px;border-radius:16px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(17,24,39,.08);text-align:right;white-space:nowrap}
    th{position:sticky;top:0;background:#f3f4f6;z-index:1;color:#111827}
    tr:hover td{background:#f9fafb}
    .twoCanv{display:grid;gap:12px}
    @media(min-width:980px){ .twoCanv{grid-template-columns:1fr 1fr} }
    canvas{width:100%;height:280px;background:#ffffff;border:1px solid var(--line);border-radius:16px}
    .hr{height:1px;background: var(--line);margin:10px 0}
    .modalBack{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(0,0,0,.35);z-index:9999;padding:16px;
    }
    .modal{
      width:min(980px, 100%);
      max-height: min(85vh, 900px);
      overflow:auto;
      background: #ffffff;
      border:1px solid rgba(17,24,39,.14);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
    }
    .modal h3{margin:0 0 10px}
    .modal p{color:var(--muted);line-height:1.55}
    .modal ul{color:var(--muted);line-height:1.6}
    .modal .x{float:left}
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.6
    }
    .smallNote{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ â€” Offline-First ğŸšŒ</h1>
      <p>×˜×•×¢×Ÿ CSV ××§×•××™×ª (Drag&Drop ××• ×‘×—×™×¨×”), ×¡×™× ×•× ×™×, × ×™×§×•×™ ×—×¨×™×’×™×, ××—×•×–×•× ×™× ×“×™× ××™×™×, Top-10 ×‘×¢×™×™×ª×™×™×/××¦×˜×™×™× ×™×, ×•×™×™×¦×•×.</p>
    </div>
    <div class="row">
      <div class="pill"><span class="mono">v24</span> <b>×§×•×‘×¥ ××—×“</b></div>
      <button id="btnHelp" class="btn primary">××“×¨×™×š ×§×¦×¨</button>
    </div>
  </header>

  <div class="grid cols2" style="margin-top:12px">
    <div class="card">
      <h2>1) ×˜×¢×™× ×ª × ×ª×•× ×™×</h2>
      <div id="drop" class="drop">
        <div class="row" style="justify-content:center">
          <!-- FIX: label-for-file (×—×¡×™×Ÿ ×™×•×ª×¨ ××›×¤×ª×•×¨+JS) -->
          <label id="btnPick" for="file" class="btn green" style="display:inline-flex;align-items:center;justify-content:center;">
            ×‘×—×¨ ×§×‘×¦×™× (Multiple)
          </label>
          <button id="btnReset" class="btn red">××™×¤×•×¡</button>
        </div>
        <p>××¤×©×¨ ×œ×’×¨×•×¨ ×œ×›××Ÿ ×§×‘×¦×™ CSV (××—×“ ××• ×™×•×ª×¨). ×›×œ ×”×§×‘×¦×™× ×™×ª××—×“×•.</p>
        <p class="smallNote">×˜×™×¤: ××œ ×ª×¤×ª×— ×‘Ö¾Preview ×©×œ Gmail/Drive. ×”×•×¨×“ ×œ××—×©×‘ ×•×¤×ª×— ×‘-Chrome/Edge.</p>

        <input id="file" type="file" accept=".csv,text/csv" multiple
               style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
      </div>

      <div id="loadState" class="row" style="margin-top:10px;display:none">
        <span class="badge purp mono">×˜×•×¢×Ÿâ€¦</span>
        <span id="loadMsg" class="muted">××¢×‘×“ × ×ª×•× ×™×â€¦</span>
      </div>

      <div id="depState" class="hint" style="margin-top:10px"></div>
      <div id="err" class="badge bad" style="display:none;margin-top:10px"></div>
      <div id="warn" class="badge warn" style="display:none;margin-top:10px"></div>

      <div class="hr"></div>
      <div class="row">
        <span class="badge">×§×‘×¦×™×: <b id="filesCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×’×•×œ××™×•×ª: <b id="rawCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×ª×§×™× ×•×ª: <b id="okCount">0</b></span>
        <span class="badge">×—×¨×™×’×™× ×©× ×•×§×•: <b id="outCount">0</b></span>
      </div>
      <div id="filesList" class="hint" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>2) ××™×¤×•×™ ×¢××•×“×•×ª (Auto + Override)</h2>
      <div class="hint">×”××¢×¨×›×ª ×× ×¡×” ×œ×–×”×•×ª ×¢××•×“×•×ª ××•×˜×•××˜×™×ª. ×× ××©×”×• ×œ× ××¡×ª×“×¨ â€” ×‘×—×¨ ×™×“× ×™×ª ×•××– ×œ×—×¥ â€œ×™×™×©×â€.</div>

      <div class="grid cols3" style="margin-top:10px">
        <div class="field">
          <label>×ª××¨×™×š (date)</label>
          <select id="mDate"></select>
        </div>
        <div class="field">
          <label>×©×¢×ª ×™×¦×™××” (departure_time / hour)</label>
          <select id="mTime"></select>
        </div>
        <div class="field">
          <label>××©×š ×‘×¤×•×¢×œ (actual_duration)</label>
          <select id="mDur"></select>
        </div>

        <div class="field">
          <label>××©×›×•×œ (cluster)</label>
          <select id="mCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×• (makt)</label>
          <select id="mMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×• (route_num)</label>
          <select id="mRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ (direction)</label>
          <select id="mDir"></select>
        </div>
        <div class="field">
          <label>×ª×›× ×•×Ÿ (planned_duration) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mPlan"></select>
        </div>
        <div class="field">
          <label>WeekDay (1â€“7) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mWD"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>×™×—×™×“×•×ª ××©×š</label>
          <select id="durUnit">
            <option value="auto">Auto</option>
            <option value="sec">×©× ×™×•×ª</option>
            <option value="min">×“×§×•×ª</option>
            <option value="hhmmss">HH:MM:SS</option>
            <option value="hhmm">HH:MM</option>
          </select>
        </div>
        <div class="field">
          <label>×¨×–×•×œ×•×¦×™×™×ª ×ª×§×Ÿ</label>
          <select id="gran">
            <option value="window">×—×œ×•×Ÿ ×–××Ÿ</option>
            <option value="hour">×©×¢×”</option>
          </select>
        </div>
        <div class="field">
          <label>× ×™×§×•×™ ×—×¨×™×’×™×</label>
          <select id="outMode">
            <option value="mad">Robust MAD</option>
            <option value="iqr">IQR</option>
            <option value="off">×œ×œ×</option>
          </select>
        </div>
        <div class="field">
          <label>×¡×£ ××™× ×™××•× ×“×’×™××•×ª (N)</label>
          <input id="minN" type="number" min="3" step="1" value="10"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnApplyMap" class="btn primary">×™×™×©× ××™×¤×•×™ + ×—×©×‘</button>
        <span class="hint">××—×¨×™ ×©×™× ×•×™ ××™×¤×•×™/×™×—×™×“×•×ª â€” ×œ×—×¥ â€œ×™×™×©×â€.</span>
      </div>
    </div>
  </div>

  <div id="main" style="display:none; margin-top:12px" class="grid">
    <div class="card">
      <h2>3) ×¡×™× ×•× ×™× + ×ª××¨×™×›×™×/×”×—×¨×’×•×ª</h2>
      <div class="grid cols3">
        <div class="field">
          <label>××©×›×•×œ</label>
          <select id="fCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×•</label>
          <select id="fMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×•</label>
          <select id="fRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ</label>
          <select id="fDir"></select>
        </div>
        <div class="field">
          <label>×¡×•×’ ×™×•×</label>
          <select id="fDay"></select>
        </div>
        <div class="field">
          <label>×—×œ×•×Ÿ ×–××Ÿ</label>
          <select id="fWin"></select>
        </div>

        <div class="field">
          <label>×©×¢×” ×¡×¤×¦×™×¤×™×ª</label>
          <select id="fHour"></select>
        </div>
        <div class="field">
          <label>×˜×•×•×— ×ª××¨×™×›×™× (×›×•×œ×œ)</label>
          <div class="row" style="gap:8px">
            <input id="fFrom" type="date"/>
            <input id="fTo" type="date"/>
          </div>
        </div>
        <div class="field">
          <label>×”×—×¨×’×ª ×˜×•×•×—×™ ×ª××¨×™×›×™× (×œ××©×œ ×”×¤×’× ×•×ª/×—×•×¨×£)</label>
          <div class="row" style="gap:8px">
            <input id="exFrom" type="date"/>
            <input id="exTo" type="date"/>
            <button id="btnAddEx" class="btn small">×”×•×¡×£</button>
          </div>
          <div id="exList" class="hint" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="field" style="min-width:360px">
          <label>××“×™× ×™×•×ª ××—×•×–×•× ×™×</label>
          <select id="policy">
            <option value="dynamic">×“×™× ××™: ×©×™×=P90, ×©×¤×œ=P85 + ×”×ª×××•×ª ×œ×¤×™ CV/N</option>
            <option value="manual">×™×“× ×™: ××—×•×–×•×Ÿ ×§×‘×•×¢ ×œ×›×œ ×”××¦×‘×™×</option>
          </select>
        </div>
        <div class="field" id="manualBox" style="display:none">
          <label>××—×•×–×•×Ÿ ×™×“× ×™</label>
          <div class="row">
            <input id="pct" type="range" min="50" max="99" value="85"/>
            <span class="badge purp mono"><b id="pctTxt">P85</b></span>
          </div>
        </div>
        <button id="btnExport" class="btn green">×™×™×¦×•× CSV</button>
        <button id="btnExportJSON" class="btn">JSON</button>
        <button id="btnExportYAML" class="btn">YAML</button>
      </div>
      <div class="hint" style="margin-top:8px">âœ… ×›×œ ×©×™× ×•×™ ×‘×¡×™× ×•× ×™×/××“×™× ×™×•×ª/×ª××¨×™×›×™× ××¢×“×›×Ÿ ××™×“ ××ª ×”×˜×‘×œ××•×ª, ×”×’×¨×¤×™× ×•×”-Top10.</div>
    </div>

    <div class="grid cols4">
      <div class="kpi">
        <div class="v mono" id="kN">â€”</div>
        <div class="l">×“×’×™××•×ª (××—×¨×™ × ×™×§×•×™)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kMean">â€”</div>
        <div class="l">×××•×¦×¢ (×“×§×•×ª)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kRec">â€”</div>
        <div class="l">×ª×§×Ÿ ××•××œ×¥ <span class="badge purp mono" id="kPct">â€”</span></div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kCV">â€”</div>
        <div class="l">CV (×©×•× ×•×ª ×™×—×¡×™×ª)</div>
      </div>
    </div>

    <div class="twoCanv">
      <div class="card">
        <h2>4) ×”×™×¡×˜×•×’×¨× â€” ×”×ª×¤×œ×’×•×ª ×–×× ×™ × ×¡×™×¢×”</h2>
        <canvas id="cvHist" width="900" height="280"></canvas>
        <div class="hint">×¦×™×¨ X = ×–××Ÿ × ×¡×™×¢×” (×“×§×•×ª), ×¦×™×¨ Y = ×›××•×ª × ×¡×™×¢×•×ª ×‘×›×œ ×˜×•×•×—. ×§×• ×¡×’×•×œ = ×ª×§×Ÿ ××•××œ×¥.</div>
      </div>
      <div class="card">
        <h2>5) ××’××” ×œ×¤×™ ×©×¢×” â€” ×××•×¦×¢ ××•×œ ×ª×§×Ÿ</h2>
        <canvas id="cvTrend" width="900" height="280"></canvas>
        <div class="hint">×××•×¦×¢ (×§×• ×©×—×•×¨) ××•×œ ×ª×§×Ÿ (×¡×’×•×œ) ×œ×›×œ ×©×¢×”. ×× ××™×Ÿ × ×ª×•× ×™× ×‘×©×¢×” â€” ×”×™× ×ª×™×©××¨ ×¨×™×§×”.</div>
      </div>
    </div>

    <div class="grid cols2">
      <div class="card">
        <h2>6) Top-10 â€œ×‘×¢×™×™×ª×™×™×â€ (×—×•×¡×¨ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th>Rec</th><th class="mono">×¤×¢×¨</th><th>Risk</th><th class="mono">×—×•×¡×¨</th>
              </tr>
            </thead>
            <tbody id="topWorst"></tbody>
          </table>
        </div>
        <div class="hint">â€œ×—×•×¡×¨â€ = (Rec âˆ’ Planned) ×›×©×—×™×•×‘×™. ×× ××™×Ÿ ×ª×›× ×•×Ÿ ×‘×§×‘×¦×™× â€” ×”×¨×©×™××” ×ª×™×©××¨ ×¨×™×§×”.</div>
      </div>

      <div class="card">
        <h2>7) Top-10 â€œ××¦×˜×™×™× ×™×â€ (×¢×•×“×£ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th>Rec</th><th class="mono">×¤×¢×¨</th><th>Risk</th><th class="mono">×¢×•×“×£</th>
              </tr>
            </thead>
            <tbody id="topBest"></tbody>
          </table>
        </div>
        <div class="hint">â€œ×¢×•×“×£â€ = (Planned âˆ’ Rec) ×›×©×—×™×•×‘×™.</div>
      </div>
    </div>

    <div class="card">
      <h2>8) ×˜×‘×œ×ª ×ª×§× ×™× ××•××œ×¦×™×</h2>
      <div class="row">
        <span class="badge">×¢××•×“×•×ª <b>Rec</b> + <b>Pct</b> ××¦×™×’×•×ª ××ª ×”×ª×§×Ÿ ×•×”××—×•×–×•×Ÿ ×©×‘×××ª ×”×•×¤×¢×œ (×“×™× ××™/×™×“× ×™).</span>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
              <th class="mono">N (raw)</th><th class="mono">N (used)</th><th class="mono">Removed</th>
              <th class="mono">Mean</th><th class="mono">Median</th><th class="mono">STD</th><th class="mono">CV</th>
              <th class="mono">P85</th><th class="mono">P90</th><th class="mono">P95</th>
              <th class="mono">Planned</th><th class="mono">Gap</th>
              <th>Rec</th><th class="mono">Pct</th><th>Risk</th><th>×¡×˜×˜×•×¡</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>×”××œ×¦×•×ª ××•×¤×¨×˜×™×‘×™×•×ª ×œ××—×¨ ×‘×‘×•×§×¨</h2>
      <ul id="ops" class="muted" style="margin:8px 0 0 0; padding-right:18px"></ul>
      <div class="hint" style="margin-top:8px">× ×‘× ×” ××•×˜×•××˜×™×ª ××”×˜×‘×œ××•×ª: Risk ×’×‘×•×” + ×—×•×¡×¨ ×ª×§×Ÿ ×‘×©×™×/×©×¢×” ×¦×¤×•×¤×”.</div>
    </div>
  </div>

  <footer class="hint" style="margin:14px 4px 6px">
    ×§×•×‘×¥ ×™×—×™×“. ×¢×•×‘×“ ×’× ×‘×œ×™ ××™× ×˜×¨× ×˜. ×›×“×™ ×œ×”×¤×•×š ×œ×“×£ ××™× ×˜×¨× ×˜: ×”×¢×œ×” ×œ-GitHub Pages / Netlify ×›-HTML ×¡×˜×˜×™.
  </footer>
</div>

<!-- Modal -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <button class="btn x" id="btnClose">×¡×’×•×¨ âœ•</button>
    <h3>××“×¨×™×š ×§×¦×¨ â€” ×‘×©×¤×” ×¤×©×•×˜×”</h3>

    <p><b>××” ×–×” â€œ×–××Ÿ ×ª×§×Ÿâ€ ×›××Ÿ?</b> ×–×” ×”×–××Ÿ ×©×× ×—× ×• ×¨×•×¦×™× ×œ×”×’×“×™×¨ ×‘×œ×•×´×– ×›×“×™ ×©×”× ×¡×™×¢×” ×ª×¢××•×“ ×‘×¨×•×‘ ×”××§×¨×™× ×‘×–××Ÿ ×•×œ× ×ª×™×™×¦×¨ ××™×—×•×¨×™×.</p>

    <ul>
      <li><b>Histogram (×”×™×¡×˜×•×’×¨×)</b>: ×›××” × ×¡×™×¢×•×ª ×”×™×• ×‘×›×œ ×˜×•×•×— ×“×§×•×ª.</li>
      <li><b>××—×•×–×•×Ÿ (P85/P90â€¦)</b>: P90 ××•××¨: 90% ××”× ×¡×™×¢×•×ª ×”×™×• â‰¤ ×”×–××Ÿ ×”×–×”.</li>
      <li><b>Mean / Median</b>: ×××•×¦×¢ ××•×œ ×—×¦×™×•×Ÿ (×”×—×¦×™×•×Ÿ ×™×¦×™×‘ ×™×•×ª×¨).</li>
      <li><b>STD</b>: ×¡×˜×™×™×ª ×ª×§×Ÿ â€” ×¤×™×–×•×¨ ×”×–×× ×™×.</li>
      <li><b>CV</b>: ×©×•× ×•×ª ×™×—×¡×™×ª (STD/Mean). ××¢×œ ~0.25 ×œ×¨×•×‘ ××¦×‘×™×¢ ×¢×œ ×©×•× ×•×ª ×’×‘×•×”×”.</li>
      <li><b>Planned</b>: ×–××Ÿ ×ª×›× ×•×Ÿ ××”×§×•×‘×¥ (×× ×§×™×™×).</li>
      <li><b>Gap</b>: Rec âˆ’ Planned. ×—×™×•×‘×™ = ×—×¡×¨ ×ª×§×Ÿ, ×©×œ×™×œ×™ = ×¢×•×“×£.</li>
      <li><b>Risk</b>: ×¦×™×•×Ÿ 0â€“100 ×©××“×¨×’ ××™×¤×” ×”×›×™ â€œ×›×•××‘â€. ××©×§×œ×œ CV, ×’×•×“×œ ×¤×¢×¨, ×•×›××•×ª × ×ª×•× ×™×.</li>
    </ul>

    <div class="hr"></div>
    <h3>FAQ ×§×¦×¨</h3>
    <p><b>1) ×œ××” Top-10 ×¨×™×§?</b> ××™×Ÿ Planned ×‘×§×‘×¦×™× ××• ×œ× ×–×•×”×”. ×¢×“×™×™×Ÿ ×™×© Rec ×œ×¤×™ ××—×•×–×•× ×™×.</p>
    <p><b>2) ×œ××” ×–×” ×œ× ×‘×•×—×¨ ×§×‘×¦×™×?</b> ×× ×¤×ª×—×ª ×‘-Preview (Gmail/Drive/SharePoint preview) â€” ×–×” ×—×•×¡×. ×¤×ª×— ××ª ×”-URL ×”×™×©×™×¨ ×©×œ ×”××ª×¨.</p>
    <p><b>3) ×œ××” ×”× ×ª×•× ×™× ×œ× ××©×ª× ×™×?</b> ×‘×’×¨×¡×” ×”×–×• ×”× ××©×ª× ×™× ××•×˜×•××˜×™×ª ×‘×›×œ ×©×™× ×•×™ ×¡×™× ×•×Ÿ/××“×™× ×™×•×ª.</p>
  </div>
</div>

<script>
/* =======================
   Offline-first JS (no CDN) â€” v24
   ======================= */

/* ---------- DOM ---------- */
const el = {
  drop: document.getElementById('drop'),
  file: document.getElementById('file'),
  btnPick: document.getElementById('btnPick'),
  btnReset: document.getElementById('btnReset'),
  loadState: document.getElementById('loadState'),
  loadMsg: document.getElementById('loadMsg'),
  depState: document.getElementById('depState'),
  err: document.getElementById('err'),
  warn: document.getElementById('warn'),
  filesCount: document.getElementById('filesCount'),
  filesList: document.getElementById('filesList'),
  rawCount: document.getElementById('rawCount'),
  okCount: document.getElementById('okCount'),
  outCount: document.getElementById('outCount'),

  // mapping
  mDate: document.getElementById('mDate'),
  mTime: document.getElementById('mTime'),
  mDur: document.getElementById('mDur'),
  mCluster: document.getElementById('mCluster'),
  mMakt: document.getElementById('mMakt'),
  mRoute: document.getElementById('mRoute'),
  mDir: document.getElementById('mDir'),
  mPlan: document.getElementById('mPlan'),
  mWD: document.getElementById('mWD'),
  durUnit: document.getElementById('durUnit'),
  gran: document.getElementById('gran'),
  outMode: document.getElementById('outMode'),
  minN: document.getElementById('minN'),
  btnApplyMap: document.getElementById('btnApplyMap'),

  main: document.getElementById('main'),

  // filters
  fCluster: document.getElementById('fCluster'),
  fMakt: document.getElementById('fMakt'),
  fRoute: document.getElementById('fRoute'),
  fDir: document.getElementById('fDir'),
  fDay: document.getElementById('fDay'),
  fWin: document.getElementById('fWin'),
  fHour: document.getElementById('fHour'),
  fFrom: document.getElementById('fFrom'),
  fTo: document.getElementById('fTo'),

  exFrom: document.getElementById('exFrom'),
  exTo: document.getElementById('exTo'),
  btnAddEx: document.getElementById('btnAddEx'),
  exList: document.getElementById('exList'),

  policy: document.getElementById('policy'),
  manualBox: document.getElementById('manualBox'),
  pct: document.getElementById('pct'),
  pctTxt: document.getElementById('pctTxt'),

  btnExport: document.getElementById('btnExport'),
  btnExportJSON: document.getElementById('btnExportJSON'),
  btnExportYAML: document.getElementById('btnExportYAML'),

  // KPI
  kN: document.getElementById('kN'),
  kMean: document.getElementById('kMean'),
  kRec: document.getElementById('kRec'),
  kPct: document.getElementById('kPct'),
  kCV: document.getElementById('kCV'),

  // canvases
  cvHist: document.getElementById('cvHist'),
  cvTrend: document.getElementById('cvTrend'),

  // tables
  tbl: document.getElementById('tbl'),
  topWorst: document.getElementById('topWorst'),
  topBest: document.getElementById('topBest'),
  ops: document.getElementById('ops'),

  // modal
  btnHelp: document.getElementById('btnHelp'),
  modalBack: document.getElementById('modalBack'),
  btnClose: document.getElementById('btnClose'),
};

/* ---------- State ---------- */
let FILES = [];
let ALL_ROWS = [];      // raw parsed objects from CSV(s)
let HEADERS = [];       // union headers
let M = null;           // mapping
let DATA = [];          // normalized records
let EX_RANGES = [];     // [{fromISO,toISO}]
let LAST_TABLE = [];    // current computed table (after filters)
let DROPPED = {missing:0, invalid:0, parse:0, excluded:0, outlier:0};

/* ---------- Utility ---------- */
const pad2 = (n)=> String(n).padStart(2,'0');
const clamp = (x,a,b)=> Math.max(a, Math.min(b, x));
const escapeHtml = (s)=> String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function showError(msg){ el.err.style.display='inline-flex'; el.err.textContent = msg; }
function hideError(){ el.err.style.display='none'; el.err.textContent=''; }
function showWarn(msg){ el.warn.style.display='inline-flex'; el.warn.textContent = msg; }
function hideWarn(){ el.warn.style.display='none'; el.warn.textContent=''; }
function setLoading(on, msg){
  el.loadState.style.display = on ? 'flex' : 'none';
  el.loadMsg.textContent = msg || '';
}
function updateDepState(){
  el.depState.innerHTML = `
    <div><b>×¡×˜×˜×•×¡:</b> Offline-First. ××™×Ÿ ×ª×œ×•×ª ×‘-CDN.</div>
    <div class="smallNote">×× ×¤×ª×—×ª ×‘-Preview (Gmail/Drive/SharePoint) â€” JavaScript/×‘×—×™×¨×ª ×§×‘×¦×™× ×¢×œ×•×œ×™× ×œ×”×™×—×¡×. ×¤×ª×— ×‘×“×¤×“×¤×Ÿ ×™×©×™×¨×•×ª.</div>
  `;
}

/* ---------- CSV Parsing ---------- */
function detectDelimiter(headerLine){
  const cands=[',',';','\t','|'];
  let best=',', bestCount=-1;
  for(const c of cands){
    const cnt=(headerLine.split(c).length-1);
    if(cnt>bestCount){ best=c; bestCount=cnt; }
  }
  return best;
}
function splitCsvLine(line, delim){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else { inQ = !inQ; }
    } else if(ch === delim && !inQ){
      out.push(cur); cur='';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCsvText(text){
  text = String(text||'').replace(/^\uFEFF/,'');
  const lines = text.split(/\r\n|\n|\r/).filter(l => String(l||'').trim().length>0);
  if(!lines.length) return [];
  const delim = detectDelimiter(lines[0]);
  const headers = splitCsvLine(lines[0], delim).map(h=>String(h||'').trim());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cols = splitCsvLine(lines[i], delim);
    if(!cols.some(c=>String(c||'').trim().length)) continue;
    const r={};
    for(let j=0;j<headers.length;j++){
      r[headers[j]] = (cols[j]===undefined ? '' : String(cols[j]).trim());
    }
    rows.push(r);
  }
  return rows;
}
function readFileText(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||''));
    fr.onerror = ()=>reject(fr.error || new Error('FileReader error'));
    fr.readAsText(file, 'utf-8');
  });
}
async function parseFiles(files){
  ALL_ROWS=[]; HEADERS=[]; DROPPED = {missing:0, invalid:0, parse:0, excluded:0, outlier:0};
  const fileArr = Array.from(files||[]);
  FILES = fileArr.map(f=>f.name);
  el.filesCount.textContent = String(FILES.length);
  el.filesList.innerHTML = FILES.length ? ("<b>× ×˜×¢× ×•:</b> " + FILES.map(escapeHtml).join(" â€¢ ")) : "";

  let raw=0;
  for(const f of fileArr){
    try{
      const txt = await readFileText(f);
      const rows = parseCsvText(txt);
      raw += rows.length;
      ALL_ROWS = ALL_ROWS.concat(rows);
      for(const r of rows){
        for(const k of Object.keys(r||{})){
          if(k && !HEADERS.includes(k)) HEADERS.push(k);
        }
      }
    }catch(e){
      console.error(e);
      DROPPED.parse++;
    }
  }
  el.rawCount.textContent = String(raw);
}

/* ---------- Mapping ---------- */
const SYN = {
  date: ['date','Date','×ª××¨×™×š','TripSourceDate','service_date','TripDate','Date_'],
  time: ['departure_time','Time','×©×¢×”','TripSourceTime','DepartureTime','Planned_Start_Time','start_time','TripStartTime','hour'],
  dur:  ['actual_duration','Duration','Actual_Duration','ActualDuration','××©×š','TravelTime','duration','travel_time','ActualDurationSeconds','ActualDurationMinutes'],
  cluster:['cluster','Cluster','ClusterName','××©×›×•×œ','Depot','Region','cluster_name'],
  makt: ['makt','××§×˜','××§×´×˜','RouteMakt','LineMakt','MaktLine','RouteMakat'],
  route: ['route','Route','RouteId','RouteShortName','Line','line_id','×§×•','××¡×¤×¨ ×§×•','RouteNumber','LineNumber','route_num'],
  dir:  ['direction','Direction','×›×™×•×•×Ÿ','dir','DirectionId'],
  plan: ['planned_duration','PlannedDuration','planned','Planned_Time','ScheduleDuration','ScheduledDuration','PlannedDurationMin','planned_minutes'],
  wd:   ['WeekDay','weekday','day_of_week','DOW','×™×•× ×‘×©×‘×•×¢']
};
function bestHeader(headers, keys){
  const lower = headers.map(h=>String(h||'').toLowerCase());
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.indexOf(kk);
    if(idx>=0) return headers[idx];
  }
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.findIndex(h => h.includes(kk));
    if(idx>=0) return headers[idx];
  }
  return '';
}
function fillSelectHeaders(sel, headers, autoPick){
  const prev = sel.value;
  sel.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = 'â€” (×œ×œ×) â€”';
  sel.appendChild(opt0);
  for(const h of headers){
    const o = document.createElement('option');
    o.value = h; o.textContent = h;
    sel.appendChild(o);
  }
  if(prev && headers.includes(prev)) sel.value = prev;
  else if(autoPick) sel.value = autoPick;
}
function buildMappingUI(){
  const h = HEADERS.slice();
  fillSelectHeaders(el.mDate, h, bestHeader(h, SYN.date));
  fillSelectHeaders(el.mTime, h, bestHeader(h, SYN.time));
  fillSelectHeaders(el.mDur,  h, bestHeader(h, SYN.dur));
  fillSelectHeaders(el.mCluster, h, bestHeader(h, SYN.cluster));
  fillSelectHeaders(el.mMakt, h, bestHeader(h, SYN.makt));
  fillSelectHeaders(el.mRoute, h, bestHeader(h, SYN.route));
  fillSelectHeaders(el.mDir,  h, bestHeader(h, SYN.dir));
  fillSelectHeaders(el.mPlan, h, bestHeader(h, SYN.plan));
  fillSelectHeaders(el.mWD,   h, bestHeader(h, SYN.wd));
}

/* ---------- Parsing values ---------- */
function toISODate(s){
  const v = String(s||'').trim();
  if(!v) return '';
  // yyyy-mm-dd
  const m1 = v.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
  if(m1){
    const y=m1[1], mo=pad2(m1[2]), d=pad2(m1[3]);
    return `${y}-${mo}-${d}`;
  }
  // dd/mm/yyyy
  const m2 = v.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})/);
  if(m2){
    const d=pad2(m2[1]), mo=pad2(m2[2]), y=m2[3];
    return `${y}-${mo}-${d}`;
  }
  // try Date()
  const dt = new Date(v);
  if(!isNaN(dt.getTime())){
    const y=dt.getFullYear();
    const mo=pad2(dt.getMonth()+1);
    const d=pad2(dt.getDate());
    return `${y}-${mo}-${d}`;
  }
  return '';
}
function weekdayFromISO(iso){
  if(!iso) return 0;
  const dt = new Date(iso+'T00:00:00');
  if(isNaN(dt.getTime())) return 0;
  // JS: 0=Sun...6=Sat -> map to 1..7 (Mon=1)
  const js = dt.getDay(); // 0 Sun
  const map = {1:1,2:2,3:3,4:4,5:5,6:6,0:7}; // Mon..Sat, Sun->7
  return map[js] || 0;
}
function dayTypeFromWD(wd){
  if(wd>=1 && wd<=5) return '×-×”';
  if(wd===6) return '×•';
  if(wd===7) return '×©×‘×ª';
  return '×œ× ×™×“×•×¢';
}
function parseTimeToHourMin(s){
  const v = String(s||'').trim();
  if(!v) return null;
  if(v.includes(':')){
    const parts = v.split(':').map(x=>x.trim());
    const hh = parseInt(parts[0],10);
    const mm = parseInt(parts[1]||'0',10);
    if(isFinite(hh) && isFinite(mm) && hh>=0 && hh<=48) return {h: clamp(hh,0,23), m: clamp(mm,0,59)};
  }
  // 730 / 0730 / 7
  const dig = v.replace(/\D/g,'');
  if(dig.length===4){
    const hh = parseInt(dig.slice(0,2),10);
    const mm = parseInt(dig.slice(2,4),10);
    if(isFinite(hh) && isFinite(mm)) return {h: clamp(hh,0,23), m: clamp(mm,0,59)};
  }
  if(dig.length===3){
    const hh = parseInt(dig.slice(0,1),10);
    const mm = parseInt(dig.slice(1,3),10);
    if(isFinite(hh) && isFinite(mm)) return {h: clamp(hh,0,23), m: clamp(mm,0,59)};
  }
  if(dig.length<=2 && dig.length>0){
    const hh = parseInt(dig,10);
    if(isFinite(hh)) return {h: clamp(hh,0,23), m: 0};
  }
  return null;
}
function windowFromHour(h){
  if(h>=0 && h<=4) return '×œ×™×œ×” (00-04)';
  if(h>=5 && h<=9) return '×©×™× ×‘×•×§×¨ (05-09)';
  if(h>=10 && h<=14) return '×©×¤×œ ×™×•× (10-14)';
  if(h>=15 && h<=19) return '×©×™× ××—×”×´×¦ (15-19)';
  return '×¢×¨×‘ (20-23)';
}
function parseDurationToMin(value, unit){
  const v = String(value||'').trim();
  if(!v) return null;

  const asNum = ()=>{
    const n = parseFloat(v.replace(/,/g,'.'));
    return (isFinite(n) ? n : null);
  };

  const fromHHMMSS = (txt)=>{
    const p = txt.split(':').map(x=>x.trim());
    if(p.length<2) return null;
    const hh = parseFloat(p[0]||'0');
    const mm = parseFloat(p[1]||'0');
    const ss = parseFloat(p[2]||'0');
    if(!isFinite(hh) || !isFinite(mm) || !isFinite(ss)) return null;
    return hh*60 + mm + ss/60;
  };

  if(unit === 'hhmmss' || unit === 'hhmm'){
    if(v.includes(':')) return fromHHMMSS(v);
    return null;
  }
  if(unit === 'sec'){
    const n = asNum(); if(n===null) return null;
    return n/60;
  }
  if(unit === 'min'){
    const n = asNum(); if(n===null) return null;
    return n;
  }

  // auto:
  if(v.includes(':')){
    const m = fromHHMMSS(v);
    if(m!==null) return m;
  }
  const n = asNum();
  if(n===null) return null;

  // heuristics: large numbers are seconds
  if(n > 500) return n/60; // seconds
  return n; // minutes
}

/* ---------- Stats ---------- */
function mean(arr){
  if(!arr.length) return null;
  let s=0; for(const x of arr) s+=x;
  return s/arr.length;
}
function median(arr){
  if(!arr.length) return null;
  const a = arr.slice().sort((x,y)=>x-y);
  const mid = Math.floor(a.length/2);
  return (a.length%2 ? a[mid] : (a[mid-1]+a[mid])/2);
}
function std(arr){
  if(arr.length<2) return 0;
  const m = mean(arr);
  let s=0;
  for(const x of arr) s += (x-m)*(x-m);
  return Math.sqrt(s/(arr.length-1));
}
function percentile(arr, p){
  if(!arr.length) return null;
  const a = arr.slice().sort((x,y)=>x-y);
  const pos = (p/100)*(a.length-1);
  const lo = Math.floor(pos), hi = Math.ceil(pos);
  if(lo===hi) return a[lo];
  const w = pos-lo;
  return a[lo]*(1-w)+a[hi]*w;
}
function removeOutliers(values, mode){
  if(mode==='off') return {used: values.slice(), removed:0};
  const a = values.slice().filter(v => isFinite(v));
  if(a.length<4) return {used:a, removed: values.length-a.length};
  let used=a;

  if(mode==='iqr'){
    const q1 = percentile(a,25);
    const q3 = percentile(a,75);
    const iqr = (q3-q1);
    const lo = q1 - 1.5*iqr;
    const hi = q3 + 1.5*iqr;
    used = a.filter(x => x>=lo && x<=hi);
  } else { // mad
    const med = median(a);
    const dev = a.map(x => Math.abs(x-med));
    const mad = median(dev) || 0;
    if(mad===0){
      used = a;
    } else {
      // modified z-score
      used = a.filter(x => Math.abs(0.6745*(x-med)/mad) <= 3.5);
    }
  }
  return {used, removed: a.length-used.length};
}
function fmt(x, d=1){
  if(x===null || x===undefined || !isFinite(x)) return 'â€”';
  return Number(x).toFixed(d);
}
function isPeak(winOrHour){
  // supports window label or numeric hour
  if(typeof winOrHour === 'number'){
    const h=winOrHour;
    return (h>=5 && h<=9) || (h>=15 && h<=19);
  }
  const s = String(winOrHour||'');
  return s.includes('×©×™× ×‘×•×§×¨') || s.includes('×©×™× ××—×”×´×¦');
}
function pickPctForRow(row){
  const pol = el.policy.value;
  if(pol === 'manual'){
    return clamp(parseInt(el.pct.value,10)||85,50,99);
  }
  // dynamic:
  let base = isPeak(row.winOrHour) ? 90 : 85;

  // adjustments by CV / N
  const cv = row.cv ?? 0;
  const n  = row.nUsed ?? 0;
  if(cv > 0.45) base += 5;
  else if(cv > 0.35) base += 3;
  else if(cv > 0.25) base += 1;

  if(n>0 && n < 20) base += 2;
  if(n>0 && n < 12) base += 2;

  return clamp(base,50,99);
}
function riskScore(cv, gapMin, nUsed, meanMin){
  const cvN = clamp((cv||0)/0.6, 0, 1);                 // 0..~0.6
  const gapN = (meanMin && isFinite(meanMin)) ? clamp(Math.abs(gapMin||0)/(meanMin*0.4), 0, 1) : 0; // 40% of mean
  const nN = nUsed>0 ? clamp(1/Math.sqrt(nUsed), 0, 1) : 1;
  const r = 0.50*cvN + 0.35*gapN + 0.15*nN;
  return Math.round(100*clamp(r,0,1));
}

/* ---------- Normalize DATA ---------- */
function getMap(){
  return {
    date: el.mDate.value,
    time: el.mTime.value,
    dur:  el.mDur.value,
    cluster: el.mCluster.value,
    makt: el.mMakt.value,
    route: el.mRoute.value,
    dir: el.mDir.value,
    plan: el.mPlan.value,
    wd: el.mWD.value,
    durUnit: el.durUnit.value,
  };
}
function normalizeAllRows(){
  DROPPED = {missing:0, invalid:0, parse:0, excluded:0, outlier:0};
  const map = getMap();
  M = map;

  if(!map.date || !map.time || !map.dur){
    showError('×—×•×‘×” ×œ××¤×•×ª: ×ª××¨×™×š + ×©×¢×ª ×™×¦×™××” + ××©×š ×‘×¤×•×¢×œ. ×‘×—×¨ ×¢××•×“×•×ª ×•××– ×œ×—×¥ â€œ×™×™×©×â€.');
    return false;
  }
  hideError();
  hideWarn();

  const out = [];
  for(const r of ALL_ROWS){
    const iso = toISODate(r[map.date]);
    const tm = parseTimeToHourMin(r[map.time]);
    const durMin = parseDurationToMin(r[map.dur], map.durUnit);

    if(!iso || !tm || durMin===null || !isFinite(durMin)){
      DROPPED.invalid++;
      continue;
    }

    const wd = map.wd ? parseInt(String(r[map.wd]||'').trim(),10) : weekdayFromISO(iso);
    const dayType = dayTypeFromWD(wd);

    const cluster = map.cluster ? String(r[map.cluster]||'').trim() : '';
    const makt = map.makt ? String(r[map.makt]||'').trim() : '';
    const route = map.route ? String(r[map.route]||'').trim() : '';
    const dir = map.dir ? String(r[map.dir]||'').trim() : '';

    const plannedMin = map.plan ? parseDurationToMin(r[map.plan], map.durUnit) : null;

    const hour = tm.h;
    const win = windowFromHour(hour);

    out.push({
      cluster, makt, route, dir,
      dateISO: iso,
      wd: (isFinite(wd) ? wd : 0),
      dayType,
      hour,
      win,
      durMin,
      plannedMin: (plannedMin!==null && isFinite(plannedMin) ? plannedMin : null),
    });
  }

  DATA = out;
  el.okCount.textContent = String(DATA.length);
  return true;
}

/* ---------- Filters UI ---------- */
function uniqSorted(arr){
  return Array.from(new Set(arr.filter(x=>String(x||'').trim().length>0))).sort((a,b)=>String(a).localeCompare(String(b),'he'));
}
function fillFilterSelect(sel, values, titleAll='×”×›×œ'){
  const prev = sel.value;
  sel.innerHTML = '';
  const oAll = document.createElement('option');
  oAll.value = '';
  oAll.textContent = `â€” ${titleAll} â€”`;
  sel.appendChild(oAll);
  for(const v of values){
    const o=document.createElement('option');
    o.value=v; o.textContent=v;
    sel.appendChild(o);
  }
  if(prev && values.includes(prev)) sel.value = prev;
  else sel.value = '';
}
function populateFilterOptions(){
  fillFilterSelect(el.fCluster, uniqSorted(DATA.map(x=>x.cluster)), '×›×œ ×”××©×›×•×œ×•×ª');
  fillFilterSelect(el.fMakt,    uniqSorted(DATA.map(x=>x.makt)), '×›×œ ×”××§×´×˜×™×');
  fillFilterSelect(el.fRoute,   uniqSorted(DATA.map(x=>x.route)), '×›×œ ×”×§×•×•×™×');
  fillFilterSelect(el.fDir,     uniqSorted(DATA.map(x=>x.dir)), '×›×œ ×”×›×™×•×•× ×™×');
  fillFilterSelect(el.fDay,     uniqSorted(DATA.map(x=>x.dayType)), '×›×œ ×¡×•×’×™ ×”×™××™×');
  fillFilterSelect(el.fWin,     uniqSorted(DATA.map(x=>x.win)), '×›×œ ×”×—×œ×•× ×•×ª');

  const hours = uniqSorted(DATA.map(x=>pad2(x.hour)+':00'));
  fillFilterSelect(el.fHour, hours, '×›×œ ×”×©×¢×•×ª');

  // default date range
  const dates = uniqSorted(DATA.map(x=>x.dateISO));
  if(dates.length){
    el.fFrom.value = dates[0];
    el.fTo.value = dates[dates.length-1];
  }
}
function renderExList(){
  if(!EX_RANGES.length){
    el.exList.innerHTML = '××™×Ÿ ×˜×•×•×—×™× ××•×—×¨×’×™×.';
    return;
  }
  el.exList.innerHTML = EX_RANGES.map((r,idx)=>`
    <div class="row" style="justify-content:space-between;gap:8px;margin:6px 0;">
      <span class="badge mono">${escapeHtml(r.fromISO)} â†’ ${escapeHtml(r.toISO)}</span>
      <button class="btn small red" data-ex="${idx}">×”×¡×¨</button>
    </div>
  `).join('');
  el.exList.querySelectorAll('button[data-ex]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = parseInt(btn.getAttribute('data-ex'),10);
      EX_RANGES.splice(i,1);
      renderExList();
      refreshAll(); // auto update
    });
  });
}

/* ---------- Apply current filters ---------- */
function inRangeISO(d, from, to){
  if(from && d < from) return false;
  if(to && d > to) return false;
  return true;
}
function isExcluded(iso){
  for(const r of EX_RANGES){
    if(iso >= r.fromISO && iso <= r.toISO) return true;
  }
  return false;
}
function currentFilters(){
  return {
    cluster: el.fCluster.value,
    makt: el.fMakt.value,
    route: el.fRoute.value,
    dir: el.fDir.value,
    dayType: el.fDay.value,
    win: el.fWin.value,
    hour: el.fHour.value, // "HH:00"
    from: el.fFrom.value,
    to: el.fTo.value,
  };
}
function filterRecords(){
  const f = currentFilters();
  const out = [];
  let excluded=0;

  for(const r of DATA){
    if(f.cluster && r.cluster !== f.cluster) continue;
    if(f.makt && r.makt !== f.makt) continue;
    if(f.route && r.route !== f.route) continue;
    if(f.dir && r.dir !== f.dir) continue;
    if(f.dayType && r.dayType !== f.dayType) continue;
    if(f.win && r.win !== f.win) continue;
    if(f.hour){
      const hh = pad2(r.hour)+':00';
      if(hh !== f.hour) continue;
    }
    if((f.from || f.to) && !inRangeISO(r.dateISO, f.from, f.to)) continue;
    if(isExcluded(r.dateISO)){ excluded++; continue; }

    out.push(r);
  }
  DROPPED.excluded = excluded;
  return out;
}

/* ---------- Compute table (grouping) ---------- */
function groupKey(rec){
  const gran = el.gran.value;
  const t = (gran==='hour') ? (pad2(rec.hour)+':00') : rec.win;
  return [
    rec.cluster||'',
    rec.makt||'',
    rec.route||'',
    rec.dir||'',
    rec.dayType||'',
    t
  ].join('||');
}
function computeTable(records){
  const groups = new Map();
  const gran = el.gran.value;

  for(const rec of records){
    const t = (gran==='hour') ? (pad2(rec.hour)+':00') : rec.win;
    const key = groupKey(rec);
    let g = groups.get(key);
    if(!g){
      g = {
        cluster: rec.cluster||'',
        makt: rec.makt||'',
        route: rec.route||'',
        dir: rec.dir||'',
        dayType: rec.dayType||'',
        winOrHour: t,
        durs: [],
        plans: [],
      };
      groups.set(key,g);
    }
    g.durs.push(rec.durMin);
    if(rec.plannedMin!==null && isFinite(rec.plannedMin)) g.plans.push(rec.plannedMin);
  }

  const minN = clamp(parseInt(el.minN.value,10)||10, 3, 999999);
  const outMode = el.outMode.value;

  const rows = [];
  let outRemovedTotal = 0;

  for(const g of groups.values()){
    const nRaw = g.durs.length;
    const cleaned = removeOutliers(g.durs, outMode);
    const used = cleaned.used;
    const removed = cleaned.removed;
    outRemovedTotal += removed;

    const nUsed = used.length;

    const m = mean(used);
    const med = median(used);
    const sd = std(used);
    const cv = (m && m>0) ? (sd/m) : 0;

    const p85 = percentile(used,85);
    const p90 = percentile(used,90);
    const p95 = percentile(used,95);

    const planned = g.plans.length ? median(g.plans) : null;

    const pctApplied = pickPctForRow({winOrHour: g.winOrHour, cv, nUsed});
    const rec = percentile(used, pctApplied);

    const gap = (planned!==null && rec!==null) ? (rec - planned) : null;
    const risk = riskScore(cv, (gap??0), nUsed, (m??null));

    const status = (nUsed < minN) ? 'N × ××•×š' : 'OK';

    rows.push({
      cluster:g.cluster, makt:g.makt, route:g.route, dir:g.dir,
      winOrHour:g.winOrHour,
      nRaw, nUsed, removed,
      mean:m, median:med, std:sd, cv,
      p85, p90, p95,
      planned,
      gap,
      rec,
      pctApplied,
      risk,
      status,
      dayType:g.dayType,
    });
  }

  el.outCount.textContent = String(outRemovedTotal);
  return rows.sort((a,b)=> (b.risk||0)-(a.risk||0));
}

/* ---------- Render UI ---------- */
function clearCanvas(cnv){
  const ctx = cnv.getContext('2d');
  ctx.clearRect(0,0,cnv.width,cnv.height);
  // background white
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,cnv.width,cnv.height);
  return ctx;
}
function drawHistogram(cnv, values, rec){
  const ctx = clearCanvas(cnv);
  const w=cnv.width, h=cnv.height;
  const pad=28;

  const arr = values.slice().filter(x=>isFinite(x));
  if(arr.length<3){
    ctx.fillStyle='#6b7280';
    ctx.font='14px system-ui';
    ctx.fillText('××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×œ×”×™×¡×˜×•×’×¨×', pad, 40);
    return;
  }

  const min = Math.min(...arr);
  const max = Math.max(...arr);
  const bins = 18;
  const bw = (max-min)/bins || 1;
  const counts = new Array(bins).fill(0);
  for(const x of arr){
    let i = Math.floor((x-min)/bw);
    if(i<0) i=0;
    if(i>=bins) i=bins-1;
    counts[i]++;
  }
  const cMax = Math.max(...counts);

  // axes
  ctx.strokeStyle='rgba(17,24,39,.18)';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(pad, h-pad);
  ctx.lineTo(w-pad, h-pad);
  ctx.lineTo(w-pad, pad);
  ctx.stroke();

  // bars
  const innerW = (w-2*pad);
  const innerH = (h-2*pad);
  const barW = innerW/bins;

  ctx.fillStyle='rgba(17,24,39,.12)';
  for(let i=0;i<bins;i++){
    const bh = (counts[i]/cMax)*innerH;
    const x = pad + i*barW;
    const y = (h-pad) - bh;
    ctx.fillRect(x+1, y, barW-2, bh);
  }

  // rec line
  if(rec!==null && isFinite(rec)){
    const x = pad + ((rec-min)/(max-min||1))*innerW;
    ctx.strokeStyle='rgba(124,58,237,.95)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(x, pad);
    ctx.lineTo(x, h-pad);
    ctx.stroke();

    ctx.fillStyle='rgba(124,58,237,.95)';
    ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace';
    ctx.fillText('Rec', Math.min(w-pad-26, x+6), pad+14);
  }
}
function drawTrend(cnv, byHourMean, byHourRec){
  const ctx = clearCanvas(cnv);
  const w=cnv.width, h=cnv.height;
  const pad=28;

  // collect y scale
  const ys=[];
  for(let i=0;i<24;i++){
    if(isFinite(byHourMean[i])) ys.push(byHourMean[i]);
    if(isFinite(byHourRec[i])) ys.push(byHourRec[i]);
  }
  if(ys.length<3){
    ctx.fillStyle='#6b7280';
    ctx.font='14px system-ui';
    ctx.fillText('××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×œ××’××” ×œ×¤×™ ×©×¢×”', pad, 40);
    return;
  }
  const yMin = Math.min(...ys);
  const yMax = Math.max(...ys);
  const innerW = (w-2*pad);
  const innerH = (h-2*pad);

  // axes
  ctx.strokeStyle='rgba(17,24,39,.18)';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(pad, h-pad);
  ctx.lineTo(w-pad, h-pad);
  ctx.lineTo(w-pad, pad);
  ctx.stroke();

  const xFor = (i)=> pad + (i/23)*innerW;
  const yFor = (v)=> (h-pad) - ((v - yMin)/(yMax - yMin || 1))*innerH;

  // mean line (black)
  ctx.strokeStyle='rgba(17,24,39,.95)';
  ctx.lineWidth=2;
  ctx.beginPath();
  let started=false;
  for(let i=0;i<24;i++){
    const v = byHourMean[i];
    if(!isFinite(v)) { started=false; continue; }
    const x=xFor(i), y=yFor(v);
    if(!started){ ctx.moveTo(x,y); started=true; }
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // rec line (purple)
  ctx.strokeStyle='rgba(124,58,237,.95)';
  ctx.lineWidth=2;
  ctx.beginPath();
  started=false;
  for(let i=0;i<24;i++){
    const v = byHourRec[i];
    if(!isFinite(v)) { started=false; continue; }
    const x=xFor(i), y=yFor(v);
    if(!started){ ctx.moveTo(x,y); started=true; }
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // x labels sparse
  ctx.fillStyle='rgba(17,24,39,.65)';
  ctx.font='11px system-ui';
  for(let i=0;i<24;i+=3){
    const x=xFor(i);
    ctx.fillText(String(i), x-3, h-10);
  }
}
function setKPI(kN, kMean, kRec, kPct, kCV){
  el.kN.textContent = kN;
  el.kMean.textContent = kMean;
  el.kRec.textContent = kRec;
  el.kPct.textContent = kPct;
  el.kCV.textContent = kCV;
}
function renderMain(records){
  // overall KPI (on filtered records)
  const durs = records.map(r=>r.durMin);
  const cleaned = removeOutliers(durs, el.outMode.value);
  const used = cleaned.used;
  const m = mean(used);
  const sd = std(used);
  const cv = (m && m>0) ? (sd/m) : 0;

  // pct for overall: treat as peak if user filtered to peak window/hour; else off-peak
  const f = currentFilters();
  const hintPeak = (f.win && isPeak(f.win)) || (f.hour && isPeak(parseInt(f.hour,10)));
  const pctApplied = (el.policy.value==='manual') ? (parseInt(el.pct.value,10)||85)
                    : clamp((hintPeak?90:85) + (cv>0.35?3: cv>0.25?1:0) + (used.length<20?2:0), 50, 99);
  const rec = percentile(used, pctApplied);

  setKPI(
    String(used.length),
    fmt(m,1),
    fmt(rec,1),
    'P'+String(pctApplied),
    fmt(cv,2)
  );

  // table by group
  LAST_TABLE = computeTable(records);

  // main table
  el.tbl.innerHTML = LAST_TABLE.map(r=>{
    const gap = (r.gap===null || !isFinite(r.gap)) ? null : r.gap;
    const gapTxt = (gap===null) ? 'â€”' : fmt(gap,1);
    const plannedTxt = (r.planned===null) ? 'â€”' : fmt(r.planned,1);
    const riskBadge = r.risk>=75 ? 'bad' : r.risk>=55 ? 'warn' : 'good';
    const statusBadge = r.status==='OK' ? 'good' : 'warn';
    return `
      <tr>
        <td>${escapeHtml(r.cluster)}</td>
        <td>${escapeHtml(r.makt)}</td>
        <td>${escapeHtml(r.route)}</td>
        <td>${escapeHtml(r.dir)}</td>
        <td>${escapeHtml(r.winOrHour)}</td>
        <td class="mono">${r.nRaw}</td>
        <td class="mono">${r.nUsed}</td>
        <td class="mono">${r.removed}</td>
        <td class="mono">${fmt(r.mean,1)}</td>
        <td class="mono">${fmt(r.median,1)}</td>
        <td class="mono">${fmt(r.std,1)}</td>
        <td class="mono">${fmt(r.cv,2)}</td>
        <td class="mono">${fmt(r.p85,1)}</td>
        <td class="mono">${fmt(r.p90,1)}</td>
        <td class="mono">${fmt(r.p95,1)}</td>
        <td class="mono">${plannedTxt}</td>
        <td class="mono">${gapTxt}</td>
        <td><span class="badge purp mono">${fmt(r.rec,1)}</span></td>
        <td class="mono">P${r.pctApplied}</td>
        <td><span class="badge ${riskBadge}">${r.risk}</span></td>
        <td><span class="badge ${statusBadge}">${escapeHtml(r.status)}</span></td>
      </tr>
    `;
  }).join('');

  // Top worst/best
  const withPlan = LAST_TABLE.filter(r=>r.planned!==null && isFinite(r.planned) && r.rec!==null && isFinite(r.rec) && r.nUsed>0);
  const worst = withPlan.filter(r=>(r.rec-r.planned)>0).sort((a,b)=> (b.risk)-(a.risk)).slice(0,10);
  const best  = withPlan.filter(r=>(r.planned-r.rec)>0).sort((a,b)=> (b.risk)-(a.risk)).slice(0,10);

  el.topWorst.innerHTML = worst.map(r=>{
    const diff = r.rec - r.planned;
    return `
      <tr>
        <td>${escapeHtml(r.cluster)}</td><td>${escapeHtml(r.makt)}</td><td>${escapeHtml(r.route)}</td><td>${escapeHtml(r.dir)}</td><td>${escapeHtml(r.winOrHour)}</td>
        <td class="mono">${r.nUsed}</td><td class="mono">${fmt(r.planned,1)}</td><td class="mono">${fmt(r.cv,2)}</td>
        <td class="mono">${fmt(r.rec,1)}</td><td class="mono">${fmt(diff,1)}</td>
        <td><span class="badge bad">${r.risk}</span></td>
        <td class="mono">${fmt(diff,1)}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="12" class="muted">××™×Ÿ ××¡×¤×™×§ Planned/×¤×¢×¨ ×—×™×•×‘×™ ×œ×”×¦×’×”.</td></tr>`;

  el.topBest.innerHTML = best.map(r=>{
    const diff = r.planned - r.rec;
    return `
      <tr>
        <td>${escapeHtml(r.cluster)}</td><td>${escapeHtml(r.makt)}</td><td>${escapeHtml(r.route)}</td><td>${escapeHtml(r.dir)}</td><td>${escapeHtml(r.winOrHour)}</td>
        <td class="mono">${r.nUsed}</td><td class="mono">${fmt(r.planned,1)}</td><td class="mono">${fmt(r.cv,2)}</td>
        <td class="mono">${fmt(r.rec,1)}</td><td class="mono">${fmt(r.rec-r.planned,1)}</td>
        <td><span class="badge warn">${r.risk}</span></td>
        <td class="mono">${fmt(diff,1)}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="12" class="muted">××™×Ÿ ××¡×¤×™×§ Planned/×¢×•×“×£ ×—×™×•×‘×™ ×œ×”×¦×’×”.</td></tr>`;

  // Charts
  drawHistogram(el.cvHist, used, rec);

  // trend by hour
  const byHourVals = Array.from({length:24}, ()=>[]);
  for(const r of records){
    if(isFinite(r.durMin) && r.hour>=0 && r.hour<=23) byHourVals[r.hour].push(r.durMin);
  }
  const byHourMean = new Array(24).fill(null);
  const byHourRec  = new Array(24).fill(null);

  for(let h=0;h<24;h++){
    const cleanedH = removeOutliers(byHourVals[h], el.outMode.value);
    const usedH = cleanedH.used;
    if(usedH.length>=3){
      const mH = mean(usedH);
      const cvH = (mH && mH>0) ? (std(usedH)/mH) : 0;
      byHourMean[h] = mH;

      const pctH = (el.policy.value==='manual') ? (parseInt(el.pct.value,10)||85)
        : clamp((isPeak(h)?90:85) + (cvH>0.35?3: cvH>0.25?1:0) + (usedH.length<20?2:0), 50, 99);
      byHourRec[h] = percentile(usedH, pctH);
    }
  }
  drawTrend(el.cvTrend, byHourMean, byHourRec);

  // Ops list
  const ops = worst
    .filter(r=>r.risk>=60 && (r.rec-r.planned)>=2)
    .slice(0,8)
    .map(r=>{
      const add = Math.ceil(r.rec - r.planned);
      return `×‘Ö¾${r.cluster||'â€”'} | ××§×´×˜ ${r.makt||'â€”'} | ×§×• ${r.route||'â€”'} | ×›×™×•×•×Ÿ ${r.dir||'â€”'} | ${r.winOrHour}: ×œ×”×•×¡×™×£ ~${add} ×“×§×³ (Risk ${r.risk}, CV ${fmt(r.cv,2)}, N=${r.nUsed}).`;
    });

  el.ops.innerHTML = ops.length ? ops.map(x=>`<li>${escapeHtml(x)}</li>`).join('') : `<li class="muted">××™×Ÿ ×›×¨×’×¢ â€œ×—×•×¡×¨ ×ª×§×Ÿâ€ ××•×‘×”×§ ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×”× ×•×›×—×™.</li>`;
}

/* ---------- Refresh (AUTO update on every change) ---------- */
function refreshAll(){
  if(!DATA.length) return;
  const recs = filterRecords();
  if(!recs.length){
    showWarn('××™×Ÿ × ×ª×•× ×™× ××—×¨×™ ×”×¡×™× ×•×Ÿ/×”×—×¨×’×•×ª. × ×¡×” ×œ×”×¨×—×™×‘ ×˜×•×•×— ×ª××¨×™×›×™× ××• ×œ×”×¡×™×¨ ×”×—×¨×’×•×ª.');
    setKPI('0','â€”','â€”','â€”','â€”');
    el.tbl.innerHTML = '';
    el.topWorst.innerHTML = '';
    el.topBest.innerHTML = '';
    el.ops.innerHTML = '<li class="muted">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</li>';
    clearCanvas(el.cvHist);
    clearCanvas(el.cvTrend);
    return;
  }
  hideWarn();
  renderMain(recs);
}

/* ---------- Export ---------- */
function downloadBlob(filename, blob){
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}
function tableToCSV(rows){
  const cols = [
    'cluster','makt','route','dir','dayType','winOrHour',
    'nRaw','nUsed','removed',
    'mean','median','std','cv',
    'p85','p90','p95',
    'planned','gap','rec','pctApplied','risk','status'
  ];
  const esc = (x)=>{
    const s = (x===null || x===undefined) ? '' : String(x);
    if(/[,"\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };
  const head = cols.join(',');
  const lines = rows.map(r => cols.map(c => {
    const v = r[c];
    if(typeof v === 'number') return esc(Number(v).toFixed(4));
    return esc(v);
  }).join(','));
  return [head].concat(lines).join('\n');
}
function toYAML(rows){
  const q = (v)=>{
    if(v===null || v===undefined) return 'null';
    if(typeof v === 'number') return (isFinite(v)? String(v) : 'null');
    const s = String(v);
    if(s==='' ) return '""';
    if(/[:\-\#\{\}\[\]\n\r]/.test(s) || s.includes('"') || s.includes("'")){
      return `"${s.replace(/\\/g,'\\\\').replace(/"/g,'\\"')}"`;
    }
    return s;
  };
  const cols = [
    'cluster','makt','route','dir','dayType','winOrHour',
    'nRaw','nUsed','removed',
    'mean','median','std','cv',
    'p85','p90','p95',
    'planned','gap','rec','pctApplied','risk','status'
  ];
  return rows.map(r=>{
    let s = `- cluster: ${q(r.cluster)}\n`;
    for(const c of cols.slice(1)){
      s += `  ${c}: ${q(r[c])}\n`;
    }
    return s;
  }).join('');
}

/* ---------- Events & Init ---------- */
function resetAll(){
  FILES=[]; ALL_ROWS=[]; HEADERS=[]; DATA=[]; M=null; LAST_TABLE=[]; EX_RANGES=[];
  el.filesCount.textContent='0';
  el.filesList.innerHTML='';
  el.rawCount.textContent='0';
  el.okCount.textContent='0';
  el.outCount.textContent='0';
  hideError(); hideWarn();
  el.main.style.display='none';
  el.tbl.innerHTML='';
  el.topWorst.innerHTML='';
  el.topBest.innerHTML='';
  el.ops.innerHTML='';
  clearCanvas(el.cvHist);
  clearCanvas(el.cvTrend);
  renderExList();
}
async function handlePickedFiles(fileList){
  hideError(); hideWarn();
  if(!fileList || !fileList.length){
    showWarn('×œ× × ×‘×—×¨×• ×§×‘×¦×™×.');
    return;
  }
  setLoading(true, '×§×•×¨× ×•×××—×“ ×§×‘×¦×™×â€¦');
  await parseFiles(fileList);
  setLoading(false, '');

  if(!ALL_ROWS.length){
    showError('×œ× × ××¦××• ×©×•×¨×•×ª ×‘×§×‘×¦×™× ××• ×©×”×¤×•×¨××˜ ×œ× × ×§×¨×. × ×¡×” CSV ×××™×ª×™ (×œ× Excel/Preview).');
    return;
  }
  buildMappingUI();
  updateDepState();
  showWarn('×‘×—×¨/××©×¨ ××™×¤×•×™ ×•××– ×œ×—×¥ â€œ×™×™×©× ××™×¤×•×™ + ×—×©×‘â€.');
}
function init(){
  updateDepState();
  renderExList();

  // Drag & Drop
  el.drop.addEventListener('dragover', (e)=>{ e.preventDefault(); el.drop.classList.add('drag'); });
  el.drop.addEventListener('dragleave', ()=> el.drop.classList.remove('drag'));
  el.drop.addEventListener('drop', async (e)=>{
    e.preventDefault();
    el.drop.classList.remove('drag');
    const files = e.dataTransfer?.files;
    await handlePickedFiles(files);
  });

  // File input change
  el.file.addEventListener('change', async ()=>{
    await handlePickedFiles(el.file.files);
    // allow picking same file again
    el.file.value = '';
  });

  // Reset
  el.btnReset.addEventListener('click', resetAll);

  // Apply mapping
  el.btnApplyMap.addEventListener('click', ()=>{
    const ok = normalizeAllRows();
    if(!ok) return;
    el.main.style.display='grid';
    populateFilterOptions();
    refreshAll();
  });

  // Policy + pct
  el.policy.addEventListener('change', ()=>{
    el.manualBox.style.display = (el.policy.value==='manual') ? 'block' : 'none';
    refreshAll();
  });
  el.pct.addEventListener('input', ()=>{
    el.pctTxt.textContent = 'P'+el.pct.value;
    refreshAll();
  });

  // Ex ranges
  el.btnAddEx.addEventListener('click', ()=>{
    const from = el.exFrom.value;
    const to = el.exTo.value;
    if(!from || !to){
      showWarn('×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•× ×œ×”×—×¨×’×”.');
      return;
    }
    const a = (from<=to) ? {fromISO:from, toISO:to} : {fromISO:to, toISO:from};
    EX_RANGES.push(a);
    el.exFrom.value=''; el.exTo.value='';
    renderExList();
    refreshAll();
  });

  // Auto refresh for every filter control
  const autoControls = [
    el.fCluster, el.fMakt, el.fRoute, el.fDir, el.fDay, el.fWin, el.fHour,
    el.fFrom, el.fTo,
    el.gran, el.outMode, el.minN
  ];
  autoControls.forEach(c=>{
    c.addEventListener('change', refreshAll);
    c.addEventListener('input', refreshAll);
  });

  // Export
  el.btnExport.addEventListener('click', ()=>{
    if(!LAST_TABLE.length){ showWarn('××™×Ÿ ×˜×‘×œ×” ×œ×™×™×¦×•×. ×˜×¢×Ÿ ×§×‘×¦×™× ×•×—×©×‘.'); return; }
    const csv = tableToCSV(LAST_TABLE);
    downloadBlob('standards_export.csv', new Blob([csv], {type:'text/csv;charset=utf-8'}));
  });
  el.btnExportJSON.addEventListener('click', ()=>{
    if(!LAST_TABLE.length){ showWarn('××™×Ÿ ×˜×‘×œ×” ×œ×™×™×¦×•×.'); return; }
    const txt = JSON.stringify(LAST_TABLE, null, 2);
    downloadBlob('standards_export.json', new Blob([txt], {type:'application/json;charset=utf-8'}));
  });
  el.btnExportYAML.addEventListener('click', ()=>{
    if(!LAST_TABLE.length){ showWarn('××™×Ÿ ×˜×‘×œ×” ×œ×™×™×¦×•×.'); return; }
    const yml = toYAML(LAST_TABLE);
    downloadBlob('standards_export.yaml', new Blob([yml], {type:'text/yaml;charset=utf-8'}));
  });

  // Modal
  el.btnHelp.addEventListener('click', ()=>{ el.modalBack.style.display='flex'; });
  el.btnClose.addEventListener('click', ()=>{ el.modalBack.style.display='none'; });
  el.modalBack.addEventListener('click', (e)=>{
    if(e.target === el.modalBack) el.modalBack.style.display='none';
  });

  // initial pct label
  el.pctTxt.textContent = 'P'+el.pct.value;
}
init();
</script>
</body>
</html>
