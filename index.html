<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ (Offline-First)</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;     /* ×©×—×•×¨ */
      --muted:#4b5563;
      --line:rgba(17,24,39,.14);
      --accent:#7c3aed;
      --accent2:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#10b981;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}

    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:16px 16px;border:1px solid var(--line);border-radius:18px;
      background:#fff;
      box-shadow: 0 10px 24px rgba(17,24,39,.08);
    }
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#f9fafb;
      font-size:12px;color:var(--muted)
    }
    .pill b{color:var(--text)}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid.cols2{grid-template-columns:1.2fr .8fr} }
    @media(min-width:980px){ .grid.cols3{grid-template-columns:1fr 1fr 1fr} }
    @media(min-width:980px){ .grid.cols4{grid-template-columns:repeat(4, 1fr)} }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(17,24,39,.08);
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{background:#f9fafb}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(124,58,237,.10); border-color: rgba(124,58,237,.35)}
    .btn.green{background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.35)}
    .btn.red{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.35)}
    .btn.small{padding:7px 10px;border-radius:12px;font-size:12px}

    .drop{
      padding:18px;
      border-radius:18px;
      border:2px dashed rgba(17,24,39,.18);
      background:#fff;
      text-align:center;
    }
    .drop.drag{border-color: rgba(124,58,237,.8); background: rgba(124,58,237,.06)}
    .drop p{margin:6px 0;color:var(--muted)}

    input, select{
      background:#fff;
      border:1px solid rgba(17,24,39,.20);
      color:#111827; /* ×©×—×•×¨ ×‘×©×“×•×ª */
      border-radius:12px;
      padding:9px 10px;
      outline:none;
      min-height:38px;
    }
    input[type="date"]{color-scheme: light;}
    input[type="range"]{width:220px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .field{min-width:170px}
    .mono{font-family:var(--mono)}

    .kpi{
      padding:12px;border-radius:18px;border:1px solid var(--line);
      background:#fff;
    }
    .kpi .v{font-size:22px;font-weight:900;line-height:1.1}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:5px}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:#f9fafb;
      font-size:12px;color:var(--muted)
    }
    .badge.good{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .badge.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .badge.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
    .badge.purp{background:#f5f3ff;border-color:#ddd6fe;color:#5b21b6}

    .tableWrap{overflow:auto;max-height:440px;border-radius:16px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(17,24,39,.08);text-align:right;white-space:nowrap}
    th{position:sticky;top:0;background:#f3f4f6;z-index:1;color:#111827}
    tr:hover td{background:#f9fafb}

    .twoCanv{display:grid;gap:12px}
    @media(min-width:980px){ .twoCanv{grid-template-columns:1fr 1fr} }
    canvas{width:100%;height:280px;background:#fff;border:1px solid var(--line);border-radius:16px}

    .hr{height:1px;background: var(--line);margin:10px 0}
    .hint{color:var(--muted);font-size:12px;line-height:1.6}
    .smallNote{font-size:12px;color:var(--muted)}

    .modalBack{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(0,0,0,.55);z-index:9999;padding:16px;
    }
    .modal{
      width:min(980px, 100%);
      max-height: min(85vh, 900px);
      overflow:auto;
      background:#fff;
      border:1px solid rgba(17,24,39,.14);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
    }
    .modal h3{margin:0 0 10px}
    .modal p{color:var(--muted);line-height:1.55}
    .modal ul{color:var(--muted);line-height:1.6}
    .modal .x{float:left}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ â€” Offline-First ğŸšŒ</h1>
      <p>×˜×•×¢×Ÿ CSV ××§×•××™×ª, ×¡×™× ×•× ×™×, × ×™×§×•×™ ×—×¨×™×’×™×, ××—×•×–×•× ×™× ×“×™× ××™×™×, Top-10 ×•×™×™×¦×•×.</p>
    </div>
    <div class="row">
      <div class="pill"><span class="mono">v23.1</span> <b>Offline</b></div>
      <button id="btnHelp" class="btn primary">××“×¨×™×š ×§×¦×¨</button>
    </div>
  </header>

  <div class="grid cols2" style="margin-top:12px">
    <div class="card">
      <h2>1) ×˜×¢×™× ×ª × ×ª×•× ×™×</h2>
      <div id="drop" class="drop">
        <div class="row" style="justify-content:center">
          <button id="btnPick" class="btn green">×‘×—×¨ ×§×‘×¦×™× (Multiple)</button>
          <button id="btnReset" class="btn red">××™×¤×•×¡</button>
        </div>
        <p>××¤×©×¨ ×œ×’×¨×•×¨ ×œ×›××Ÿ ×§×‘×¦×™ CSV (××—×“ ××• ×™×•×ª×¨). ×›×œ ×”×§×‘×¦×™× ×™×ª××—×“×•.</p>
        <p class="smallNote">×× ×¤×ª×—×ª ×‘-Preview (Gmail/Drive) ×–×” ×¢×œ×•×œ ×œ×—×¡×•× JS. ×”×•×¨×“ ×œ××—×©×‘ ×•×¤×ª×— ×‘-Chrome/Edge.</p>
        <input id="file" type="file" accept=".csv,text/csv" multiple style="display:none"/>
      </div>

      <div id="loadState" class="row" style="margin-top:10px;display:none">
        <span class="badge purp mono">×˜×•×¢×Ÿâ€¦</span>
        <span id="loadMsg" class="muted">××¢×‘×“ × ×ª×•× ×™×â€¦</span>
      </div>

      <div id="depState" class="hint" style="margin-top:10px"></div>
      <div id="err" class="badge bad" style="display:none;margin-top:10px"></div>
      <div id="warn" class="badge warn" style="display:none;margin-top:10px"></div>

      <div class="hr"></div>
      <div class="row">
        <span class="badge">×§×‘×¦×™×: <b id="filesCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×’×•×œ××™×•×ª: <b id="rawCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×ª×§×™× ×•×ª: <b id="okCount">0</b></span>
        <span class="badge">×—×¨×™×’×™× ×©× ×•×§×•: <b id="outCount">0</b></span>
      </div>
      <div id="filesList" class="hint" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>2) ××™×¤×•×™ ×¢××•×“×•×ª (Auto + Override)</h2>
      <div class="hint">×”××¢×¨×›×ª ×× ×¡×” ×œ×–×”×•×ª ×¢××•×“×•×ª ××•×˜×•××˜×™×ª. ×× ××©×”×• ×œ× ××¡×ª×“×¨ â€” ×‘×—×¨ ×™×“× ×™×ª ×•××– ×œ×—×¥ â€œ×™×™×©×â€.</div>

      <div class="grid cols3" style="margin-top:10px">
        <div class="field">
          <label>×ª××¨×™×š (date)</label>
          <select id="mDate"></select>
        </div>
        <div class="field">
          <label>×©×¢×ª ×™×¦×™××” (departure_time / hour)</label>
          <select id="mTime"></select>
        </div>
        <div class="field">
          <label>××©×š ×‘×¤×•×¢×œ (actual_duration)</label>
          <select id="mDur"></select>
        </div>

        <div class="field">
          <label>××©×›×•×œ (cluster)</label>
          <select id="mCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×• (makt)</label>
          <select id="mMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×• (route_num)</label>
          <select id="mRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ (direction)</label>
          <select id="mDir"></select>
        </div>
        <div class="field">
          <label>×ª×›× ×•×Ÿ (planned_duration) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mPlan"></select>
        </div>
        <div class="field">
          <label>WeekDay (1â€“7) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mWD"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>×™×—×™×“×•×ª ××©×š</label>
          <select id="durUnit">
            <option value="auto">Auto</option>
            <option value="sec">×©× ×™×•×ª</option>
            <option value="min">×“×§×•×ª</option>
            <option value="hhmmss">HH:MM:SS</option>
            <option value="hhmm">HH:MM</option>
          </select>
        </div>
        <div class="field">
          <label>×¨×–×•×œ×•×¦×™×™×ª ×ª×§×Ÿ</label>
          <select id="gran">
            <option value="window">×—×œ×•×Ÿ ×–××Ÿ</option>
            <option value="hour">×©×¢×”</option>
          </select>
        </div>
        <div class="field">
          <label>× ×™×§×•×™ ×—×¨×™×’×™×</label>
          <select id="outMode">
            <option value="mad">Robust MAD</option>
            <option value="iqr">IQR</option>
            <option value="off">×œ×œ×</option>
          </select>
        </div>
        <div class="field">
          <label>×¡×£ ××™× ×™××•× ×“×’×™××•×ª (N)</label>
          <input id="minN" type="number" min="3" step="1" value="10"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnApplyMap" class="btn primary">×™×™×©× ××™×¤×•×™ + ×—×©×‘</button>
        <span class="hint">××—×¨×™ ×©×™× ×•×™ ××™×¤×•×™/×™×—×™×“×•×ª â€” ×œ×—×¥ â€œ×™×™×©×â€.</span>
      </div>
    </div>
  </div>

  <div id="main" style="display:none; margin-top:12px" class="grid">
    <div class="card">
      <h2>3) ×¡×™× ×•× ×™× + ×ª××¨×™×›×™×/×”×—×¨×’×•×ª</h2>
      <div class="grid cols3">
        <div class="field">
          <label>××©×›×•×œ</label>
          <select id="fCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×•</label>
          <select id="fMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×•</label>
          <select id="fRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ</label>
          <select id="fDir"></select>
        </div>
        <div class="field">
          <label>×¡×•×’ ×™×•×</label>
          <select id="fDay"></select>
        </div>
        <div class="field">
          <label>×—×œ×•×Ÿ ×–××Ÿ</label>
          <select id="fWin"></select>
        </div>

        <div class="field">
          <label>×©×¢×” ×¡×¤×¦×™×¤×™×ª</label>
          <select id="fHour"></select>
        </div>
        <div class="field">
          <label>×˜×•×•×— ×ª××¨×™×›×™× (×›×•×œ×œ)</label>
          <div class="row" style="gap:8px">
            <input id="fFrom" type="date"/>
            <input id="fTo" type="date"/>
          </div>
        </div>
        <div class="field">
          <label>×”×—×¨×’×ª ×˜×•×•×—×™ ×ª××¨×™×›×™×</label>
          <div class="row" style="gap:8px">
            <input id="exFrom" type="date"/>
            <input id="exTo" type="date"/>
            <button id="btnAddEx" class="btn small">×”×•×¡×£</button>
          </div>
          <div id="exList" class="hint" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="field" style="min-width:360px">
          <label>××“×™× ×™×•×ª ××—×•×–×•× ×™×</label>
          <select id="policy">
            <option value="dynamic">×“×™× ××™: ×©×™×=P90, ×©×¤×œ=P85 + ×”×ª×××•×ª ×œ×¤×™ CV/N</option>
            <option value="manual">×™×“× ×™: ××—×•×–×•×Ÿ ×§×‘×•×¢ ×œ×›×œ ×”××¦×‘×™×</option>
          </select>
        </div>
        <div class="field" id="manualBox" style="display:none">
          <label>××—×•×–×•×Ÿ ×™×“× ×™</label>
          <div class="row">
            <input id="pct" type="range" min="50" max="99" value="85"/>
            <span class="badge purp mono"><b id="pctTxt">P85</b></span>
          </div>
        </div>
        <button id="btnExport" class="btn green">×™×™×¦×•× CSV</button>
        <button id="btnExportJSON" class="btn">JSON</button>
        <button id="btnExportYAML" class="btn">YAML</button>
      </div>
    </div>

    <div class="grid cols4">
      <div class="kpi">
        <div class="v mono" id="kN">â€”</div>
        <div class="l">×“×’×™××•×ª (××—×¨×™ × ×™×§×•×™)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kMean">â€”</div>
        <div class="l">×××•×¦×¢ (×“×§×•×ª)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kRec">â€”</div>
        <div class="l">×ª×§×Ÿ ××•××œ×¥ <span class="badge purp mono" id="kPct">â€”</span></div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kCV">â€”</div>
        <div class="l">CV (×©×•× ×•×ª ×™×—×¡×™×ª)</div>
      </div>
    </div>

    <div class="twoCanv">
      <div class="card">
        <h2>4) ×”×™×¡×˜×•×’×¨× â€” ×”×ª×¤×œ×’×•×ª ×–×× ×™ × ×¡×™×¢×”</h2>
        <canvas id="cvHist" width="900" height="280"></canvas>
        <div class="hint">×¦×™×¨ X = ×–××Ÿ (×“×§×•×ª), ×¦×™×¨ Y = ×›××•×ª. ×”×§×• ×”×¡×’×•×œ = ×ª×§×Ÿ ××•××œ×¥.</div>
      </div>
      <div class="card">
        <h2>5) ××’××” ×œ×¤×™ ×©×¢×” â€” ×××•×¦×¢ ××•×œ ×ª×§×Ÿ</h2>
        <canvas id="cvTrend" width="900" height="280"></canvas>
        <div class="hint">×××•×¦×¢ ××•×œ ×ª×§×Ÿ ×œ×›×œ ×©×¢×”. ×× ××™×Ÿ × ×ª×•× ×™× ×‘×©×¢×” â€” ×™×”×™×” ×¨×™×§.</div>
      </div>
    </div>

    <div class="grid cols2">
      <div class="card">
        <h2>6) Top-10 â€œ×‘×¢×™×™×ª×™×™×â€ (×—×•×¡×¨ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th class="mono">Rec</th><th class="mono">Gap</th><th class="mono">Risk</th>
              </tr>
            </thead>
            <tbody id="topWorst"></tbody>
          </table>
        </div>
        <div class="hint">×× ××™×Ÿ ×¢××•×“×ª ×ª×›× ×•×Ÿ (Planned) ×‘×§×‘×¦×™× â€” ×”×˜×‘×œ×” ×ª×™×©××¨ ×¨×™×§×”.</div>
      </div>

      <div class="card">
        <h2>7) Top-10 â€œ××¦×˜×™×™× ×™×â€ (×¢×•×“×£ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th class="mono">Rec</th><th class="mono">Gap</th><th class="mono">Risk</th>
              </tr>
            </thead>
            <tbody id="topBest"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>8) ×˜×‘×œ×ª ×ª×§× ×™× ××•××œ×¦×™×</h2>
      <div class="row">
        <span class="badge">Rec = ×”×ª×§×Ÿ ×”××•××œ×¥ ×‘×¤×•×¢×œ, Pct = ×”××—×•×–×•×Ÿ ×©×”×•×¤×¢×œ (×“×™× ××™/×™×“× ×™).</span>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
              <th class="mono">N(raw)</th><th class="mono">N(used)</th><th class="mono">Removed</th>
              <th class="mono">Mean</th><th class="mono">Median</th><th class="mono">STD</th><th class="mono">CV</th>
              <th class="mono">P85</th><th class="mono">P90</th><th class="mono">P95</th>
              <th class="mono">Planned</th><th class="mono">Gap</th>
              <th class="mono">Rec</th><th class="mono">Pct</th><th class="mono">Risk</th><th>×¡×˜×˜×•×¡</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>×”××œ×¦×•×ª ××•×¤×¨×˜×™×‘×™×•×ª</h2>
      <ul id="ops" class="muted" style="margin:8px 0 0 0; padding-right:18px"></ul>
      <div class="hint" style="margin-top:8px">× ×‘× ×” ××•×˜×•××˜×™×ª ××”×˜×‘×œ×”: Risk ×’×‘×•×” + Gap ×—×™×•×‘×™.</div>
    </div>
  </div>

  <footer class="hint" style="margin:14px 4px 6px">
    ×§×•×‘×¥ ×™×—×™×“. ×¢×•×‘×“ ×’× ×‘×œ×™ ××™× ×˜×¨× ×˜. ×œ- GitHub Pages: ×”×¢×œ×” ×›- <span class="mono">index.html</span> ×•×”×¤×¢×œ Pages.
  </footer>
</div>

<!-- Modal -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <button class="btn x" id="btnClose">×¡×’×•×¨ âœ•</button>
    <h3>××“×¨×™×š ×§×¦×¨</h3>

    <p><b>××” ×–×” â€œ×–××Ÿ ×ª×§×Ÿâ€ ×›××Ÿ?</b> ×”×–××Ÿ ×©× ×¨×¦×” ×œ×”×’×“×™×¨ ×‘×œ×•×´×– ×›×“×™ ×œ×¢××•×“ ×‘×¨×•×‘ ×”××§×¨×™× ×‘×–××Ÿ.</p>

    <ul>
      <li><b>Histogram</b>: ×”×ª×¤×œ×’×•×ª ×–×× ×™ × ×¡×™×¢×”.</li>
      <li><b>P85/P90</b>: ××—×•×–×•×Ÿ. ×œ××©×œ P90 = 90% ××”× ×¡×™×¢×•×ª ×§×¦×¨×•×ª ××• ×©×•×•×ª ×œ×¢×¨×š ×”×–×”.</li>
      <li><b>CV</b>: ×©×•× ×•×ª ×™×—×¡×™×ª. ×’×‘×•×” = ×§×• â€œ×œ× ×™×¦×™×‘â€.</li>
      <li><b>Gap</b>: Rec âˆ’ Planned. ×—×™×•×‘×™ = ×—×¡×¨ ×ª×§×Ÿ. ×©×œ×™×œ×™ = ×¢×•×“×£ ×ª×§×Ÿ.</li>
      <li><b>Risk</b>: ×¦×™×•×Ÿ 0â€“100: ××©×§×œ×œ ×©×•× ×•×ª, ×¤×¢×¨, ×•××™×¢×•×˜ ×“×’×™××•×ª.</li>
    </ul>

    <div class="hr"></div>
    <h3>FAQ ×§×¦×¨</h3>
    <p><b>×œ××” Top-10 ×¨×™×§?</b> ××™×Ÿ Planned ×‘×§×‘×¦×™× ××• ×©×œ× ×–×•×”×” ×‘××™×¤×•×™.</p>
    <p><b>×œ××” â€œ×œ× × ×˜×¢×Ÿâ€?</b> ×‘×“×¨×š ×›×œ×œ ×¤×ª×™×—×” ×‘-Preview ×©×—×•×¡× JavaScript. ×”×•×¨×“ ×•×¤×ª×— ×‘×“×¤×“×¤×Ÿ.</p>
    <p><b>×œ××” ×”× ×ª×•× ×™× â€œ×œ× ×–×–×™×â€?</b> ×‘×’×¨×¡×” ×”×–×• ×›×œ ×©×™× ×•×™ ×‘×¡×™× ×•×Ÿ ××¨× ×“×¨ ××—×“×© ××•×˜×•××˜×™×ª.</p>
  </div>
</div>

<script>
/* =======================
   Offline-first JS (no CDN)
   ======================= */

/* ---------- DOM ---------- */
const el = {
  drop: document.getElementById('drop'),
  file: document.getElementById('file'),
  btnPick: document.getElementById('btnPick'),
  btnReset: document.getElementById('btnReset'),
  loadState: document.getElementById('loadState'),
  loadMsg: document.getElementById('loadMsg'),
  depState: document.getElementById('depState'),
  err: document.getElementById('err'),
  warn: document.getElementById('warn'),
  filesCount: document.getElementById('filesCount'),
  filesList: document.getElementById('filesList'),
  rawCount: document.getElementById('rawCount'),
  okCount: document.getElementById('okCount'),
  outCount: document.getElementById('outCount'),

  // mapping
  mDate: document.getElementById('mDate'),
  mTime: document.getElementById('mTime'),
  mDur: document.getElementById('mDur'),
  mCluster: document.getElementById('mCluster'),
  mMakt: document.getElementById('mMakt'),
  mRoute: document.getElementById('mRoute'),
  mDir: document.getElementById('mDir'),
  mPlan: document.getElementById('mPlan'),
  mWD: document.getElementById('mWD'),
  durUnit: document.getElementById('durUnit'),
  gran: document.getElementById('gran'),
  outMode: document.getElementById('outMode'),
  minN: document.getElementById('minN'),
  btnApplyMap: document.getElementById('btnApplyMap'),

  main: document.getElementById('main'),

  // filters
  fCluster: document.getElementById('fCluster'),
  fMakt: document.getElementById('fMakt'),
  fRoute: document.getElementById('fRoute'),
  fDir: document.getElementById('fDir'),
  fDay: document.getElementById('fDay'),
  fWin: document.getElementById('fWin'),
  fHour: document.getElementById('fHour'),
  fFrom: document.getElementById('fFrom'),
  fTo: document.getElementById('fTo'),

  exFrom: document.getElementById('exFrom'),
  exTo: document.getElementById('exTo'),
  btnAddEx: document.getElementById('btnAddEx'),
  exList: document.getElementById('exList'),

  policy: document.getElementById('policy'),
  manualBox: document.getElementById('manualBox'),
  pct: document.getElementById('pct'),
  pctTxt: document.getElementById('pctTxt'),

  btnExport: document.getElementById('btnExport'),
  btnExportJSON: document.getElementById('btnExportJSON'),
  btnExportYAML: document.getElementById('btnExportYAML'),

  // KPI
  kN: document.getElementById('kN'),
  kMean: document.getElementById('kMean'),
  kRec: document.getElementById('kRec'),
  kPct: document.getElementById('kPct'),
  kCV: document.getElementById('kCV'),

  // canvases
  cvHist: document.getElementById('cvHist'),
  cvTrend: document.getElementById('cvTrend'),

  // tables
  tbl: document.getElementById('tbl'),
  topWorst: document.getElementById('topWorst'),
  topBest: document.getElementById('topBest'),
  ops: document.getElementById('ops'),

  // modal
  btnHelp: document.getElementById('btnHelp'),
  modalBack: document.getElementById('modalBack'),
  btnClose: document.getElementById('btnClose'),
};

/* ---------- State ---------- */
let FILES = [];
let ALL_ROWS = [];
let HEADERS = [];

let M = null;           // mapping object
let DATA = [];          // normalized records
let EX_RANGES = [];     // [{fromISO,toISO}]
let LAST_TABLE = [];    // last computed summary table

let COUNTS = { raw:0, ok:0, out:0 };

/* ---------- Utilities ---------- */
const pad2 = (n)=> String(n).padStart(2,'0');
const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));
const escapeHtml = (s)=> String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function showError(msg){ el.err.style.display='inline-flex'; el.err.textContent = msg; }
function hideError(){ el.err.style.display='none'; el.err.textContent=''; }
function showWarn(msg){ el.warn.style.display='inline-flex'; el.warn.textContent = msg; }
function hideWarn(){ el.warn.style.display='none'; el.warn.textContent=''; }
function setLoading(on, msg){
  el.loadState.style.display = on ? 'flex' : 'none';
  el.loadMsg.textContent = msg || '';
}
function updateDepState(){
  el.depState.innerHTML = `
    <div><b>×¡×˜×˜×•×¡:</b> Offline-First ×¤×¢×™×œ. ××™×Ÿ ×ª×œ×•×ª ×‘-CDN.</div>
    <div class="smallNote">×× ×”×›×¤×ª×•×¨×™× ×œ× ××’×™×‘×™× â€” ×›× ×¨××” ×¤×ª×™×—×” ×‘-Preview ×©×—×•×¡× JavaScript. ×”×•×¨×“ ×œ××—×©×‘ ×•×¤×ª×— ×‘-Chrome/Edge.</div>
  `;
}

/* ---------- CSV parsing ---------- */
function detectDelimiter(headerLine){
  const cands=[',',';','\t','|'];
  let best=',', bestCount=-1;
  for(const c of cands){
    const cnt=(headerLine.split(c).length-1);
    if(cnt>bestCount){ best=c; bestCount=cnt; }
  }
  return best;
}
function splitCsvLine(line, delim){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else { inQ = !inQ; }
    } else if(ch === delim && !inQ){
      out.push(cur); cur='';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCsvText(text){
  text = String(text||'').replace(/^\uFEFF/,'');
  const lines = text.split(/\r\n|\n|\r/).filter(l => String(l||'').trim().length>0);
  if(!lines.length) return [];
  const delim = detectDelimiter(lines[0]);
  const headers = splitCsvLine(lines[0], delim).map(h=>String(h||'').trim());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const cols = splitCsvLine(lines[i], delim);
    if(!cols.some(c=>String(c||'').trim().length)) continue;
    const r={};
    for(let j=0;j<headers.length;j++){
      r[headers[j]] = (cols[j]===undefined ? '' : String(cols[j]).trim());
    }
    rows.push(r);
  }
  return rows;
}
function readFileText(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||''));
    fr.onerror = ()=>reject(fr.error || new Error('FileReader error'));
    fr.readAsText(file, 'utf-8');
  });
}
async function parseFiles(files){
  ALL_ROWS=[]; HEADERS=[];
  const fileArr = Array.from(files||[]);
  FILES = fileArr.map(f=>f.name);
  el.filesCount.textContent = String(FILES.length);
  el.filesList.innerHTML = FILES.length ? ("<b>× ×˜×¢× ×•:</b> " + FILES.map(escapeHtml).join(" â€¢ ")) : "";

  let raw=0;
  for(const f of fileArr){
    const txt = await readFileText(f);
    const rows = parseCsvText(txt);
    raw += rows.length;
    ALL_ROWS = ALL_ROWS.concat(rows);
    for(const r of rows){
      for(const k of Object.keys(r||{})){
        if(k && !HEADERS.includes(k)) HEADERS.push(k);
      }
    }
  }
  COUNTS.raw = raw;
  el.rawCount.textContent = String(raw);
}

/* ---------- Mapping helpers ---------- */
const SYN = {
  date: ['date','Date','×ª××¨×™×š','service_date','TripDate','TripSourceDate'],
  time: ['departure_time','Time','×©×¢×”','DepartureTime','start_time','TripStartTime','hour'],
  dur:  ['actual_duration','Duration','ActualDuration','××©×š','TravelTime','duration','travel_time'],
  cluster:['cluster','Cluster','××©×›×•×œ','Depot','Region','cluster_name'],
  makt: ['makt','××§×˜','××§×´×˜','RouteMakt','LineMakt','Makat'],
  route: ['route_num','route','Route','×§×•','××¡×¤×¨ ×§×•','LineNumber','RouteNumber'],
  dir:  ['direction','Direction','×›×™×•×•×Ÿ','dir','DirectionId'],
  plan: ['planned_duration','PlannedDuration','planned','ScheduleDuration','ScheduledDuration'],
  wd:   ['WeekDay','weekday','day_of_week','DOW','×™×•× ×‘×©×‘×•×¢']
};
function bestHeader(headers, keys){
  const lower = headers.map(h=>String(h||'').toLowerCase());
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.indexOf(kk);
    if(idx>=0) return headers[idx];
  }
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.findIndex(h => h.includes(kk));
    if(idx>=0) return headers[idx];
  }
  return '';
}
function fillSelect(selectEl, headers, selected){
  selectEl.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = 'â€”';
  selectEl.appendChild(opt0);

  for(const h of headers){
    const o = document.createElement('option');
    o.value = h;
    o.textContent = h;
    selectEl.appendChild(o);
  }
  selectEl.value = selected || '';
}
function autoFillMapping(){
  fillSelect(el.mDate, HEADERS, bestHeader(HEADERS, SYN.date));
  fillSelect(el.mTime, HEADERS, bestHeader(HEADERS, SYN.time));
  fillSelect(el.mDur, HEADERS, bestHeader(HEADERS, SYN.dur));
  fillSelect(el.mCluster, HEADERS, bestHeader(HEADERS, SYN.cluster));
  fillSelect(el.mMakt, HEADERS, bestHeader(HEADERS, SYN.makt));
  fillSelect(el.mRoute, HEADERS, bestHeader(HEADERS, SYN.route));
  fillSelect(el.mDir, HEADERS, bestHeader(HEADERS, SYN.dir));
  fillSelect(el.mPlan, HEADERS, bestHeader(HEADERS, SYN.plan));
  fillSelect(el.mWD, HEADERS, bestHeader(HEADERS, SYN.wd));
}

/* ---------- Parsing values ---------- */
function toNumber(x){
  const s = String(x??'').replace(/,/g,'').trim();
  if(!s) return NaN;
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}
function parseHHMMToHour(s){
  s = String(s??'').trim();
  if(!s) return null;

  // allow "HH:MM[:SS]" or "HHMM"
  if(s.includes(':')){
    const parts = s.split(':').map(p=>toNumber(p));
    const hh = parts[0];
    if(Number.isFinite(hh)) return clamp(Math.floor(hh),0,23);
    return null;
  }
  // digits
  const dig = s.replace(/\D/g,'');
  if(dig.length>=2){
    const hh = Number(dig.slice(0,2));
    if(Number.isFinite(hh)) return clamp(Math.floor(hh),0,23);
  }
  return null;
}
function parseDateAny(v){
  const s = String(v??'').trim();
  if(!s) return null;

  // try YYYY-MM-DD
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(iso){
    const d = new Date(`${iso[1]}-${iso[2]}-${iso[3]}T00:00:00`);
    if(!isNaN(d.getTime())) return `${iso[1]}-${iso[2]}-${iso[3]}`;
  }

  // try DD/MM/YYYY or DD.MM.YYYY
  const m = s.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{4})/);
  if(m){
    const dd = pad2(m[1]), mm = pad2(m[2]), yy = m[3];
    const d = new Date(`${yy}-${mm}-${dd}T00:00:00`);
    if(!isNaN(d.getTime())) return `${yy}-${mm}-${dd}`;
  }

  // fallback Date parse
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const yy = d.getFullYear();
    const mm = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    return `${yy}-${mm}-${dd}`;
  }
  return null;
}
function dayTypeFromISO(iso){
  // JS: 0=Sunday ... 6=Saturday
  const d = new Date(iso + 'T00:00:00');
  const dow = d.getDay();
  if(dow === 5) return '×•';
  if(dow === 6) return '×©×‘×ª';
  return '×-×”';
}
function windowFromHour(h){
  if(h===null || h===undefined) return 'â€”';
  if(h>=6 && h<=9) return '×©×™× ×‘×•×§×¨';
  if(h>=10 && h<=14) return '×‘×™× ×™×™×';
  if(h>=15 && h<=19) return '×©×™× ×¢×¨×‘';
  if(h>=20 && h<=23) return '×œ×™×œ×”';
  return '×œ×™×œ×”'; // 0-5
}
function parseDurationToMin(v, unitMode){
  const s = String(v??'').trim();
  if(!s) return NaN;

  // explicit modes
  if(unitMode === 'sec'){
    const n = toNumber(s);
    return Number.isFinite(n) ? n/60 : NaN;
  }
  if(unitMode === 'min'){
    const n = toNumber(s);
    return Number.isFinite(n) ? n : NaN;
  }
  if(unitMode === 'hhmm' || unitMode === 'hhmmss'){
    if(!s.includes(':')) return NaN;
    const parts = s.split(':').map(p=>toNumber(p));
    const hh = parts[0], mm = parts[1];
    const ss = parts[2] || 0;
    if(!Number.isFinite(hh) || !Number.isFinite(mm)) return NaN;
    return (hh*3600 + mm*60 + (Number.isFinite(ss)?ss:0))/60;
  }

  // auto mode
  if(s.includes(':')){
    const parts = s.split(':').map(p=>toNumber(p));
    const hh = parts[0], mm = parts[1];
    const ss = parts[2] || 0;
    if(Number.isFinite(hh) && Number.isFinite(mm)){
      return (hh*3600 + mm*60 + (Number.isFinite(ss)?ss:0))/60;
    }
  }
  const n = toNumber(s);
  if(!Number.isFinite(n)) return NaN;
  // heuristic: if huge number -> seconds
  if(n > 600) return n/60;
  return n;
}

/* ---------- Stats helpers ---------- */
function quantile(sortedArr, q){
  if(!sortedArr.length) return NaN;
  const pos = (sortedArr.length - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  if(sortedArr[base+1] !== undefined){
    return sortedArr[base] + rest * (sortedArr[base+1]-sortedArr[base]);
  }
  return sortedArr[base];
}
function mean(arr){
  if(!arr.length) return NaN;
  let s=0;
  for(const x of arr) s+=x;
  return s/arr.length;
}
function std(arr){
  if(arr.length<2) return 0;
  const m = mean(arr);
  let v=0;
  for(const x of arr){ const d=x-m; v += d*d; }
  return Math.sqrt(v/(arr.length-1));
}
function median(sortedArr){ return quantile(sortedArr, 0.5); }

function filterOutliers(values, mode){
  // expects raw numeric array
  if(mode === 'off') return { used: values.slice(), removed: 0 };
  if(values.length < 5) return { used: values.slice(), removed: 0 };

  const s = values.slice().sort((a,b)=>a-b);
  if(mode === 'iqr'){
    const q1 = quantile(s, 0.25);
    const q3 = quantile(s, 0.75);
    const iqr = q3-q1;
    const lo = q1 - 1.5*iqr;
    const hi = q3 + 1.5*iqr;
    const used = values.filter(x=>x>=lo && x<=hi);
    return { used, removed: values.length-used.length };
  }

  // MAD
  const med = quantile(s, 0.5);
  const absDev = values.map(x=>Math.abs(x-med)).sort((a,b)=>a-b);
  const mad = quantile(absDev, 0.5) || 0;
  if(mad === 0) return { used: values.slice(), removed: 0 };
  const k = 3.5; // robust threshold
  const lo = med - k*1.4826*mad;
  const hi = med + k*1.4826*mad;
  const used = values.filter(x=>x>=lo && x<=hi);
  return { used, removed: values.length-used.length };
}

/* ---------- Build normalized DATA ---------- */
function buildMappingFromUI(){
  return {
    date: el.mDate.value,
    time: el.mTime.value,
    dur: el.mDur.value,
    cluster: el.mCluster.value,
    makt: el.mMakt.value,
    route: el.mRoute.value,
    dir: el.mDir.value,
    plan: el.mPlan.value,
    wd: el.mWD.value,
    durUnit: el.durUnit.value,
    gran: el.gran.value,
    outMode: el.outMode.value,
    minN: clamp(parseInt(el.minN.value||'10',10) || 10, 3, 9999)
  };
}
function normalizeData(){
  hideError(); hideWarn();
  COUNTS.ok = 0;
  COUNTS.out = 0;

  M = buildMappingFromUI();

  if(!M.date || !M.time || !M.dur){
    showError('×—×¡×¨ ××™×¤×•×™ ×—×•×‘×”: ×ª××¨×™×š + ×©×¢×” + ××©×š ×‘×¤×•×¢×œ. ×‘×—×¨ ×™×“× ×™×ª ×•××– ×œ×—×¥ â€œ×™×™×©×â€.');
    return false;
  }

  DATA = [];
  for(const r of ALL_ROWS){
    const dateISO = parseDateAny(r[M.date]);
    const hour = parseHHMMToHour(r[M.time]);
    const durMin = parseDurationToMin(r[M.dur], M.durUnit);

    if(!dateISO || hour===null || !Number.isFinite(durMin) || durMin<=0){
      continue;
    }

    const cluster = (M.cluster ? String(r[M.cluster]??'').trim() : '') || 'â€”';
    const makt = (M.makt ? String(r[M.makt]??'').trim() : '') || 'â€”';
    const route = (M.route ? String(r[M.route]??'').trim() : '') || 'â€”';
    const dir = (M.dir ? String(r[M.dir]??'').trim() : '') || 'â€”';

    let plannedMin = NaN;
    if(M.plan){
      plannedMin = parseDurationToMin(r[M.plan], M.durUnit);
      if(!Number.isFinite(plannedMin) || plannedMin<=0) plannedMin = NaN;
    }

    const dayType = dayTypeFromISO(dateISO);
    const win = windowFromHour(hour);

    DATA.push({ cluster, makt, route, dir, dateISO, hour, win, dayType, durMin, plannedMin });
  }

  COUNTS.ok = DATA.length;
  el.okCount.textContent = String(COUNTS.ok);
  el.outCount.textContent = String(COUNTS.out);

  if(DATA.length === 0){
    showError('×œ× × ××¦××• ×©×•×¨×•×ª ×ª×§×™× ×•×ª ××—×¨×™ ××™×¤×•×™/×”××¨×”. ×‘×“×•×§ ××™×¤×•×™, ×¤×•×¨××˜ ×ª××¨×™×š, ×•×™×—×™×“×•×ª ××©×š.');
    return false;
  }
  return true;
}

/* ---------- Filters UI ---------- */
function uniq(arr){ return Array.from(new Set(arr)).sort((a,b)=>String(a).localeCompare(String(b),'he')); }
function fillFilterSelect(sel, values, allLabel='×”×›×•×œ'){
  sel.innerHTML = '';
  const optAll = document.createElement('option');
  optAll.value = '';
  optAll.textContent = allLabel;
  sel.appendChild(optAll);
  for(const v of values){
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  }
  sel.value = '';
}
function refreshFilterOptions(){
  fillFilterSelect(el.fCluster, uniq(DATA.map(d=>d.cluster)));
  fillFilterSelect(el.fMakt, uniq(DATA.map(d=>d.makt)));
  fillFilterSelect(el.fRoute, uniq(DATA.map(d=>d.route)));
  fillFilterSelect(el.fDir, uniq(DATA.map(d=>d.dir)));
  fillFilterSelect(el.fDay, uniq(DATA.map(d=>d.dayType)), '×”×›×•×œ');
  fillFilterSelect(el.fWin, uniq(DATA.map(d=>d.win)), '×”×›×•×œ');

  // hours 0-23 present
  const hours = uniq(DATA.map(d=>String(d.hour))).sort((a,b)=>Number(a)-Number(b));
  fillFilterSelect(el.fHour, hours, '×”×›×•×œ');

  // default date range
  const dates = uniq(DATA.map(d=>d.dateISO)).sort();
  el.fFrom.value = dates[0] || '';
  el.fTo.value = dates[dates.length-1] || '';
}
function renderExList(){
  if(!EX_RANGES.length){ el.exList.textContent = '××™×Ÿ ×”×—×¨×’×•×ª.'; return; }
  el.exList.innerHTML = EX_RANGES.map((x,idx)=>
    `<div class="row" style="justify-content:space-between">
      <span class="mono">${escapeHtml(x.fromISO)} â†’ ${escapeHtml(x.toISO)}</span>
      <button class="btn small red" data-exdel="${idx}">××—×§</button>
    </div>`
  ).join('');
  el.exList.querySelectorAll('button[data-exdel]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = Number(btn.getAttribute('data-exdel'));
      EX_RANGES.splice(i,1);
      renderExList();
      renderAll(); // live update
    });
  });
}

/* ---------- Filtering ---------- */
function isDateInRange(d, fromISO, toISO){
  if(fromISO && d < fromISO) return false;
  if(toISO && d > toISO) return false;
  return true;
}
function isExcluded(dateISO){
  for(const ex of EX_RANGES){
    if(dateISO >= ex.fromISO && dateISO <= ex.toISO) return true;
  }
  return false;
}
function getFilteredData(){
  const fc = el.fCluster.value;
  const fm = el.fMakt.value;
  const fr = el.fRoute.value;
  const fd = el.fDir.value;
  const fday = el.fDay.value;
  const fwin = el.fWin.value;
  const fhour = el.fHour.value;
  const fromISO = el.fFrom.value;
  const toISO = el.fTo.value;

  return DATA.filter(x=>{
    if(fc && x.cluster !== fc) return false;
    if(fm && x.makt !== fm) return false;
    if(fr && x.route !== fr) return false;
    if(fd && x.dir !== fd) return false;
    if(fday && x.dayType !== fday) return false;

    if(!isDateInRange(x.dateISO, fromISO, toISO)) return false;
    if(isExcluded(x.dateISO)) return false;

    if(el.gran.value === 'window'){
      if(fwin && x.win !== fwin) return false;
    } else {
      if(fhour && String(x.hour) !== String(fhour)) return false;
    }
    return true;
  });
}

/* ---------- Policy / Rec calc ---------- */
function isPeak(bucketLabel){
  return bucketLabel === '×©×™× ×‘×•×§×¨' || bucketLabel === '×©×™× ×¢×¨×‘';
}
function choosePct({bucket, cv, n}){
  if(el.policy.value === 'manual'){
    return clamp(parseInt(el.pct.value||'85',10)||85,50,99);
  }
  let p = isPeak(bucket) ? 90 : 85;
  if(cv >= 0.25) p += 2;
  if(cv >= 0.35) p += 2;
  if(n < (M?.minN||10)) p += 2;
  return clamp(p, 80, 95);
}
function riskScore({cv, gap, n}){
  // cv up to ~0.5 => 0..60
  const a = clamp(cv*140, 0, 70);
  const b = (Number.isFinite(gap) ? clamp(Math.abs(gap)*6, 0, 25) : 0);
  const c = (n < (M?.minN||10)) ? clamp((M.minN - n)*3, 0, 20) : 0;
  return Math.round(clamp(a+b+c, 0, 100));
}

/* ---------- Summaries ---------- */
function groupKey(x){
  const timeKey = (el.gran.value === 'window') ? x.win : String(x.hour);
  return [x.cluster, x.makt, x.route, x.dir, timeKey].join('||');
}
function summarize(filtered){
  const groups = new Map();
  for(const x of filtered){
    const k = groupKey(x);
    if(!groups.has(k)){
      groups.set(k, {
        cluster:x.cluster, makt:x.makt, route:x.route, dir:x.dir,
        bucket: (el.gran.value === 'window') ? x.win : String(x.hour),
        dur: [], plan: []
      });
    }
    const g = groups.get(k);
    g.dur.push(x.durMin);
    if(Number.isFinite(x.plannedMin)) g.plan.push(x.plannedMin);
  }

  const out=[];
  let totalRemoved=0;

  for(const g of groups.values()){
    const rawN = g.dur.length;
    const { used, removed } = filterOutliers(g.dur, el.outMode.value);
    totalRemoved += removed;

    const usedSorted = used.slice().sort((a,b)=>a-b);
    const usedN = usedSorted.length;
    if(usedN < (M?.minN||10)) continue;

    const mu = mean(us
