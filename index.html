<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ (Offline-First)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0e1830;
      --text:#e6eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#10b981;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background: radial-gradient(900px 400px at 80% -20%, rgba(124,58,237,.30), transparent 55%),
                  radial-gradient(900px 400px at 10% 0%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:#bfa7ff}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:16px 16px;border:1px solid var(--line);border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
    }
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;color:var(--muted)
    }
    .pill b{color:var(--text)}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid.cols2{grid-template-columns:1.2fr .8fr} }
    @media(min-width:980px){ .grid.cols3{grid-template-columns:1fr 1fr 1fr} }
    @media(min-width:980px){ .grid.cols4{grid-template-columns:repeat(4, 1fr)} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 16px 36px rgba(0,0,0,.20);
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(124,58,237,.35); border-color: rgba(124,58,237,.55)}
    .btn.green{background: rgba(34,197,94,.25); border-color: rgba(34,197,94,.45)}
    .btn.red{background: rgba(239,68,68,.22); border-color: rgba(239,68,68,.40)}
    .btn.small{padding:7px 10px;border-radius:12px;font-size:12px}
    .drop{
      padding:18px;
      border-radius:18px;
      border:2px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      text-align:center;
    }
    .drop.drag{border-color: rgba(124,58,237,.8); background: rgba(124,58,237,.10)}
    .drop p{margin:6px 0;color:var(--muted)}
    input, select{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      outline:none;
      min-height:38px;
    }
    input[type="date"]{color-scheme: dark;}
    input[type="range"]{width:220px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .field{min-width:170px}
    .mono{font-family:var(--mono)}
    .kpi{
      padding:12px;border-radius:18px;border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .kpi .v{font-size:22px;font-weight:900;line-height:1.1}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:5px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;color:var(--muted)
    }
    .badge.good{background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.35); color:#bff7e7}
    .badge.bad{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.38); color:#ffd0d0}
    .badge.warn{background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.35); color:#ffe6b3}
    .badge.purp{background: rgba(124,58,237,.20); border-color: rgba(124,58,237,.40); color:#e8dbff}
    .tableWrap{overflow:auto;max-height:440px;border-radius:16px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:right;white-space:nowrap}
    th{position:sticky;top:0;background: rgba(10,18,34,.96);backdrop-filter: blur(6px);z-index:1;color:#cfe0ff}
    tr:hover td{background: rgba(255,255,255,.03)}
    .twoCanv{display:grid;gap:12px}
    @media(min-width:980px){ .twoCanv{grid-template-columns:1fr 1fr} }
    canvas{width:100%;height:280px;background: rgba(255,255,255,.02);border:1px solid var(--line);border-radius:16px}
    .hr{height:1px;background: var(--line);margin:10px 0}
    .modalBack{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(0,0,0,.55);z-index:9999;padding:16px;
    }
    .modal{
      width:min(980px, 100%);
      max-height: min(85vh, 900px);
      overflow:auto;
      background: #0b1428;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
    }
    .modal h3{margin:0 0 10px}
    .modal p{color:var(--muted);line-height:1.55}
    .modal ul{color:var(--muted);line-height:1.6}
    .modal .x{float:left}
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.6
    }
    .smallNote{font-size:12px;color:var(--muted)}

    /* =========================
       LIGHT THEME OVERRIDES
       ========================= */
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#111827;
      --muted:#4b5563;
      --line:rgba(17,24,39,.14);
    }
    body{
      background:#ffffff !important;
      color:var(--text) !important;
    }
    header,.card{
      background:#ffffff !important;
      box-shadow: 0 10px 24px rgba(17,24,39,.08) !important;
    }
    .pill,.badge{
      background:#f9fafb !important;
      border-color: rgba(17,24,39,.14) !important;
      color: var(--muted) !important;
    }
    .pill b{color:var(--text)!important;}
    .badge.good{background:#ecfdf5!important;border-color:#a7f3d0!important;color:#065f46!important;}
    .badge.bad{background:#fef2f2!important;border-color:#fecaca!important;color:#991b1b!important;}
    .badge.warn{background:#fffbeb!important;border-color:#fde68a!important;color:#92400e!important;}
    .badge.purp{background:#f5f3ff!important;border-color:#ddd6fe!important;color:#5b21b6!important;}
    input,select{
      background:#ffffff !important;
      color:#111827 !important;
      border:1px solid rgba(17,24,39,.20) !important;
    }
    input[type="date"]{color-scheme: light;}
    th{
      background:#f3f4f6 !important;
      color:#111827 !important;
    }
    tr:hover td{background:#f9fafb !important;}
    .tableWrap{border-color: rgba(17,24,39,.14) !important;}
    .drop{background:#ffffff !important;}
    .drop.drag{background:#f5f3ff !important; border-color: rgba(124,58,237,.8) !important;}
    canvas{background:#ffffff !important;}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ â€” Offline-First ğŸšŒ</h1>
      <p>×˜×•×¢×Ÿ CSV ××§×•××™×ª (Drag&Drop ××• ×‘×—×™×¨×”), ×¡×™× ×•× ×™×, × ×™×§×•×™ ×—×¨×™×’×™×, ××—×•×–×•× ×™× ×“×™× ××™×™×, Top-10 ×‘×¢×™×™×ª×™×™×/××¦×˜×™×™× ×™×, ×•×™×™×¦×•×.</p>
    </div>
    <div class="row">
      <div class="pill"><span class="mono">v23</span> <b>×œ×œ× ×ª×œ×•×ª ×‘-CDN</b></div>
      <button id="btnHelp" class="btn primary">××“×¨×™×š ×§×¦×¨</button>
    </div>
  </header>

  <div class="grid cols2" style="margin-top:12px">
    <div class="card">
      <h2>1) ×˜×¢×™× ×ª × ×ª×•× ×™×</h2>
      <div id="drop" class="drop">
        <div class="row" style="justify-content:center">
          <button id="btnPick" class="btn green">×‘×—×¨ ×§×‘×¦×™× (Multiple)</button>
          <button id="btnReset" class="btn red">××™×¤×•×¡</button>
        </div>
        <p>××¤×©×¨ ×œ×’×¨×•×¨ ×œ×›××Ÿ ×§×‘×¦×™ CSV (××—×“ ××• ×™×•×ª×¨). ×›×œ ×”×§×‘×¦×™× ×™×ª××—×“×•.</p>
        <p class="smallNote">×˜×™×¤: ××œ ×ª×¤×ª×— ××ª ×”×§×•×‘×¥ ×‘Ö¾Preview ×©×œ Gmail/Drive. ×ª×•×¨×™×“ ×œ××—×©×‘ ×•×ª×¤×ª×— ×‘-Chrome/Edge.</p>
        <input id="file" type="file" accept=".csv,text/csv" multiple style="display:none"/>
      </div>

      <div id="loadState" class="row" style="margin-top:10px;display:none">
        <span class="badge purp mono">×˜×•×¢×Ÿâ€¦</span>
        <span id="loadMsg" class="muted">××¢×‘×“ × ×ª×•× ×™×â€¦</span>
      </div>

      <div id="depState" class="hint" style="margin-top:10px"></div>
      <div id="err" class="badge bad" style="display:none;margin-top:10px"></div>
      <div id="warn" class="badge warn" style="display:none;margin-top:10px"></div>

      <div class="hr"></div>
      <div class="row">
        <span class="badge">×§×‘×¦×™×: <b id="filesCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×’×•×œ××™×•×ª: <b id="rawCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×ª×§×™× ×•×ª: <b id="okCount">0</b></span>
        <span class="badge">×—×¨×™×’×™× ×©× ×•×§×•: <b id="outCount">0</b></span>
      </div>
      <div id="filesList" class="hint" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>2) ××™×¤×•×™ ×¢××•×“×•×ª (Auto + Override)</h2>
      <div class="hint">×”××¢×¨×›×ª ×× ×¡×” ×œ×–×”×•×ª ×¢××•×“×•×ª ××•×˜×•××˜×™×ª. ×× ××©×”×• ×œ× ××¡×ª×“×¨ â€” ×‘×—×¨ ×™×“× ×™×ª.</div>

      <div class="grid cols3" style="margin-top:10px">
        <div class="field">
          <label>×ª××¨×™×š (date)</label>
          <select id="mDate"></select>
        </div>
        <div class="field">
          <label>×©×¢×ª ×™×¦×™××” (departure_time / hour)</label>
          <select id="mTime"></select>
        </div>
        <div class="field">
          <label>××©×š ×‘×¤×•×¢×œ (actual_duration)</label>
          <select id="mDur"></select>
        </div>

        <div class="field">
          <label>××©×›×•×œ (cluster)</label>
          <select id="mCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×• (makt)</label>
          <select id="mMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×• (route_num)</label>
          <select id="mRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ (direction)</label>
          <select id="mDir"></select>
        </div>
        <div class="field">
          <label>×ª×›× ×•×Ÿ (planned_duration) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mPlan"></select>
        </div>
        <div class="field">
          <label>WeekDay (1â€“7) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mWD"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>×™×—×™×“×•×ª ××©×š</label>
          <select id="durUnit">
            <option value="auto">Auto</option>
            <option value="sec">×©× ×™×•×ª</option>
            <option value="min">×“×§×•×ª</option>
            <option value="hhmmss">HH:MM:SS</option>
            <option value="hhmm">HH:MM</option>
          </select>
        </div>
        <div class="field">
          <label>×¨×–×•×œ×•×¦×™×™×ª ×ª×§×Ÿ</label>
          <select id="gran">
            <option value="window">×—×œ×•×Ÿ ×–××Ÿ</option>
            <option value="hour">×©×¢×”</option>
          </select>
        </div>
        <div class="field">
          <label>× ×™×§×•×™ ×—×¨×™×’×™×</label>
          <select id="outMode">
            <option value="mad">Robust MAD</option>
            <option value="iqr">IQR</option>
            <option value="off">×œ×œ×</option>
          </select>
        </div>
        <div class="field">
          <label>×¡×£ ××™× ×™××•× ×“×’×™××•×ª (N)</label>
          <input id="minN" type="number" min="3" step="1" value="10"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnApplyMap" class="btn primary">×™×™×©× ××™×¤×•×™ + ×—×©×‘</button>
        <span class="hint">××—×¨×™ ×©×™× ×•×™ ××™×¤×•×™/×™×—×™×“×•×ª â€” ×œ×—×¥ â€œ×™×™×©×â€.</span>
      </div>
    </div>
  </div>

  <div id="main" style="display:none; margin-top:12px" class="grid">
    <div class="card">
      <h2>3) ×¡×™× ×•× ×™× + ×ª××¨×™×›×™×/×”×—×¨×’×•×ª</h2>
      <div class="grid cols3">
        <div class="field">
          <label>××©×›×•×œ</label>
          <select id="fCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×•</label>
          <select id="fMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×•</label>
          <select id="fRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ</label>
          <select id="fDir"></select>
        </div>
        <div class="field">
          <label>×¡×•×’ ×™×•×</label>
          <select id="fDay"></select>
        </div>
        <div class="field">
          <label>×—×œ×•×Ÿ ×–××Ÿ</label>
          <select id="fWin"></select>
        </div>

        <div class="field">
          <label>×©×¢×” ×¡×¤×¦×™×¤×™×ª</label>
          <select id="fHour"></select>
        </div>
        <div class="field">
          <label>×˜×•×•×— ×ª××¨×™×›×™× (×›×•×œ×œ)</label>
          <div class="row" style="gap:8px">
            <input id="fFrom" type="date"/>
            <input id="fTo" type="date"/>
          </div>
        </div>
        <div class="field">
          <label>×”×—×¨×’×ª ×˜×•×•×—×™ ×ª××¨×™×›×™× (×œ××©×œ ×”×¤×’× ×•×ª/×—×•×¨×£)</label>
          <div class="row" style="gap:8px">
            <input id="exFrom" type="date"/>
            <input id="exTo" type="date"/>
            <button id="btnAddEx" class="btn small">×”×•×¡×£</button>
          </div>
          <div id="exList" class="hint" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="field" style="min-width:360px">
          <label>××“×™× ×™×•×ª ××—×•×–×•× ×™×</label>
          <select id="policy">
            <option value="dynamic">×“×™× ××™: ×©×™×=P90, ×©×¤×œ=P85 + ×”×ª×××•×ª ×œ×¤×™ CV/N</option>
            <option value="manual">×™×“× ×™: ××—×•×–×•×Ÿ ×§×‘×•×¢ ×œ×›×œ ×”××¦×‘×™×</option>
          </select>
        </div>
        <div class="field" id="manualBox" style="display:none">
          <label>××—×•×–×•×Ÿ ×™×“× ×™</label>
          <div class="row">
            <input id="pct" type="range" min="50" max="99" value="85"/>
            <span class="badge purp mono"><b id="pctTxt">P85</b></span>
          </div>
        </div>
        <button id="btnExport" class="btn green">×™×™×¦×•× CSV</button>
        <button id="btnExportJSON" class="btn">JSON</button>
        <button id="btnExportYAML" class="btn">YAML</button>
      </div>
    </div>

    <div class="grid cols4">
      <div class="kpi">
        <div class="v mono" id="kN">â€”</div>
        <div class="l">×“×’×™××•×ª (××—×¨×™ × ×™×§×•×™)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kMean">â€”</div>
        <div class="l">×××•×¦×¢ (×“×§×•×ª)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kRec">â€”</div>
        <div class="l">×ª×§×Ÿ ××•××œ×¥ <span class="badge purp mono" id="kPct">â€”</span></div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kCV">â€”</div>
        <div class="l">CV (×©×•× ×•×ª ×™×—×¡×™×ª)</div>
      </div>
    </div>

    <div class="twoCanv">
      <div class="card">
        <h2>4) ×”×™×¡×˜×•×’×¨× â€” ×”×ª×¤×œ×’×•×ª ×–×× ×™ × ×¡×™×¢×”</h2>
        <canvas id="cvHist" width="900" height="280"></canvas>
        <div class="hint">×¦×™×¨ X = ×–××Ÿ × ×¡×™×¢×” (×“×§×•×ª), ×¦×™×¨ Y = ×›××” × ×¡×™×¢×•×ª × ×¤×œ×• ×‘×›×œ ×˜×•×•×—. ×”×§×• ×”×¡×’×•×œ = ×ª×§×Ÿ ××•××œ×¥.</div>
      </div>
      <div class="card">
        <h2>5) ××’××” ×œ×¤×™ ×©×¢×” â€” ×××•×¦×¢ ××•×œ ×ª×§×Ÿ</h2>
        <canvas id="cvTrend" width="900" height="280"></canvas>
        <div class="hint">××¦×™×’ ×××•×¦×¢ (×§×• ×‘×”×™×¨) ××•×œ ×ª×§×Ÿ (×¡×’×•×œ) ×œ×›×œ ×©×¢×”. ×× ××™×Ÿ × ×ª×•× ×™× ×‘×©×¢×” â€” ×–×” ×™×•×¤×™×¢ ×›×¨×™×§.</div>
      </div>
    </div>

    <div class="grid cols2">
      <div class="card">
        <h2>6) Top-10 â€œ×‘×¢×™×™×ª×™×™×â€ (×—×•×¡×¨ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th>Rec</th><th class="mono">×¤×¢×¨</th><th>Risk</th><th class="mono">×—×•×¡×¨</th>
              </tr>
            </thead>
            <tbody id="topWorst"></tbody>
          </table>
        </div>
        <div class="hint">â€œ×—×•×¡×¨â€ = (Rec âˆ’ Planned) ×›×©×—×™×•×‘×™. ×× ××™×Ÿ ×ª×›× ×•×Ÿ ×‘×§×‘×¦×™× â€” ×”×¨×©×™××” ×ª×™×©××¨ ×¨×™×§×”.</div>
      </div>

      <div class="card">
        <h2>7) Top-10 â€œ××¦×˜×™×™× ×™×â€ (×¢×•×“×£ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th>Rec</th><th class="mono">×¤×¢×¨</th><th>Risk</th><th class="mono">×¢×•×“×£</th>
              </tr>
            </thead>
            <tbody id="topBest"></tbody>
          </table>
        </div>
        <div class="hint">â€œ×¢×•×“×£â€ = (Planned âˆ’ Rec) ×›×©×—×™×•×‘×™. ×–×” ××§×•× ×œ×—×¡×•×š ×ª×§×Ÿ ×‘×œ×™ ×œ×¤×’×•×¢ ×‘×××™× ×•×ª (×‘×–×”×™×¨×•×ª!).</div>
      </div>
    </div>

    <div class="card">
      <h2>8) ×˜×‘×œ×ª ×ª×§× ×™× ××•××œ×¦×™× (×œ×¤×™ ×”×¨×–×•×œ×•×¦×™×” ×©× ×‘×—×¨×”)</h2>
      <div class="row">
        <span class="badge">×”×¢×¨×”: ×¢××•×“×•×ª <b>Rec</b> + <b>Pct</b> ××¦×™×’×•×ª ××ª ×”×ª×§×Ÿ ×•×”××—×•×–×•×Ÿ ×©×‘×××ª ×”×•×¤×¢×œ (×“×™× ××™/×™×“× ×™).</span>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
              <th class="mono">N (raw)</th><th class="mono">N (used)</th><th class="mono">Removed</th>
              <th class="mono">Mean</th><th class="mono">Median</th><th class="mono">STD</th><th class="mono">CV</th>
              <th class="mono">P85</th><th class="mono">P90</th><th class="mono">P95</th>
              <th class="mono">Planned</th><th class="mono">Gap</th>
              <th>Rec</th><th class="mono">Pct</th><th>Risk</th><th>×¡×˜×˜×•×¡</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>×”××œ×¦×•×ª ××•×¤×¨×˜×™×‘×™×•×ª ×œ××—×¨ ×‘×‘×•×§×¨</h2>
      <ul id="ops" class="muted" style="margin:8px 0 0 0; padding-right:18px"></ul>
      <div class="hint" style="margin-top:8px">×”×”××œ×¦×•×ª × ×‘× ×•×ª ××•×˜×•××˜×™×ª ××”×˜×‘×œ××•×ª: ××™×¤×” Risk ×’×‘×•×” + ×—×•×¡×¨ ×ª×§×Ÿ ×‘×©×™×/×©×¢×” ×¦×¤×•×¤×”.</div>
    </div>
  </div>

  <footer class="hint" style="margin:14px 4px 6px">
    ×§×•×‘×¥ ×™×—×™×“. ×¢×•×‘×“ ×’× ×‘×œ×™ ××™× ×˜×¨× ×˜. ×›×“×™ ×œ×”×¤×•×š ×œ×“×£ ××™× ×˜×¨× ×˜: ×”×¢×œ×” ×œ-GitHub Pages / Netlify / SharePoint ×›×§×•×‘×¥ HTML ×¡×˜×˜×™.
  </footer>
</div>

<!-- Modal -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <button class="btn x" id="btnClose">×¡×’×•×¨ âœ•</button>
    <h3>××“×¨×™×š ×§×¦×¨ â€” ×‘×©×¤×” ×¤×©×•×˜×”</h3>

    <p><b>××” ×–×” â€œ×–××Ÿ ×ª×§×Ÿâ€ ×›××Ÿ?</b> ×–×” ×”×–××Ÿ ×©×× ×—× ×• ×¨×•×¦×™× ×œ×”×’×“×™×¨ ×‘×œ×•×´×– ×›×“×™ ×©×”× ×¡×™×¢×” ×ª×¢××•×“ ×‘×¨×•×‘ ×”××§×¨×™× ×‘×–××Ÿ ×•×œ× ×ª×™×™×¦×¨ ××™×—×•×¨×™×.</p>

    <ul>
      <li><b>Histogram (×”×™×¡×˜×•×’×¨×)</b>: ××¨××” ×›××” × ×¡×™×¢×•×ª ×”×™×• ×‘×›×œ ×˜×•×•×— ×©×œ ×“×§×•×ª. ×× ×™×© â€œ×–× ×‘ ×™×× ×™â€ ××¨×•×š â€” ×™×© ×”×¨×‘×” × ×¡×™×¢×•×ª ××™×˜×™×•×ª ×œ×¤×¢××™×.</li>
      <li><b>××—×•×–×•×Ÿ (P85/P90â€¦)</b>: ×œ×“×•×’××” P90 ××•××¨: 90% ××”× ×¡×™×¢×•×ª ×”×™×• ×§×¦×¨×•×ª ××• ×©×•×•×ª ×œ×–××Ÿ ×”×–×”. ×–×” ×–××Ÿ ×ª×§×Ÿ â€œ×©××¨× ×™â€ ×™×•×ª×¨ ××××•×¦×¢.</li>
      <li><b>Mean / Median</b>: ×××•×¦×¢ ××•×œ ×—×¦×™×•×Ÿ. ×× ×”×—×¦×™×•×Ÿ × ××•×š ××”×××•×¦×¢ â€” ×›× ×¨××” ×©×™×© ×—×¨×™×’×™× ×©××•×©×›×™× ×œ××¢×œ×”.</li>
      <li><b>STD</b>: ×¡×˜×™×™×ª ×ª×§×Ÿ â€” ×›××” ×”×–×× ×™× â€œ××ª×¤×–×¨×™×â€. ×’×‘×•×” = ×”×¨×‘×” ×©×•× ×•×ª.</li>
      <li><b>CV</b>: ×¡×˜×™×™×ª ×ª×§×Ÿ ×™×—×¡×™×ª ×œ×××•×¦×¢. ×–×” ××“×“ ××¦×•×™×Ÿ ×œ×”×©×•×•××” ×‘×™×Ÿ ×§×•×•×™× ××¨×•×›×™× ×•×§×¦×¨×™×. ×›×œ×œ ××¦×‘×¢: ××¢×œ ~0.25 = ×©×•× ×•×ª ×’×‘×•×”×”.</li>
      <li><b>Planned</b>: ×–××Ÿ ×”×ª×›× ×•×Ÿ ×©×™×© ×œ×š ×‘×§×•×‘×¥ (×× ×™×©). ×× ×—× ×• ××¦×™×’×™× ××•×ª×• ×›-Median ×›×“×™ ×œ×”×™×•×ª ×™×¦×™×‘.</li>
      <li><b>Gap</b>: Rec âˆ’ Planned. <b>×—×™×•×‘×™</b> = ×—×¡×¨ ×ª×§×Ÿ (×ª×›× ×•×Ÿ ×§×¦×¨ ××“×™). <b>×©×œ×™×œ×™</b> = ×¢×•×“×£ ×ª×§×Ÿ.</li>
      <li><b>Risk</b>: ×¦×™×•×Ÿ 0â€“100 ×©××“×¨×’ ××™×¤×” ×”×›×™ â€œ×›×•××‘â€ ×œ×”×ª×¢×¨×‘. ××©×§×œ×œ: ×©×•× ×•×ª (CV), ×’×•×“×œ ×¤×¢×¨ ××•×œ ×ª×›× ×•×Ÿ, ×•×›××” ××¢×˜ × ×ª×•× ×™× ×™×©.</li>
    </ul>

    <p><b>××” ×œ×ª×§×Ÿ ×§×•×“×?</b> ×‘×“×¨×š ×›×œ×œ ××ª×—×™×œ×™× ××™×¤×” ×©×™×© <b>×—×•×¡×¨ ×ª×§×Ÿ</b> + <b>Risk ×’×‘×•×”</b> (×‘××™×•×—×“ ×‘×©×™×). ×©×•× ×•×ª ×’×‘×•×”×” ×œ×‘×“×” ×œ× ×ª××™×“ ××•××¨×ª ×©×¦×¨×™×š ×œ×”×•×¡×™×£ ×–××Ÿ â€” ×œ×¤×¢××™× ×–×” ×‘×¢×™×™×ª ×ª×¤×¢×•×œ/×¢×•××¡ × ×§×•×“×ª×™, ×•××– ×¦×¨×™×š ×˜×™×¤×•×œ ××—×¨ (×¤×™×§×•×—, × ×ª×´×¦, ×©×™× ×•×™ ×—×œ×•× ×•×ª).</p>

    <div class="hr"></div>
    <h3>FAQ ×§×¦×¨</h3>
    <p><b>1) ×œ××” ×™×© ×œ×™ â€œ×—×•×¡×¨ ×ª×§×Ÿâ€ ××‘×œ CV × ××•×š?</b> ×›× ×¨××” ×©×”×§×• ×¢×§×‘×™, ×¤×©×•×˜ ×”×ª×›× ×•×Ÿ ×§×¦×¨ ××“×™. ×§×œ ×œ×ª×§×Ÿ â€” ×œ×”×•×¡×™×£ ×“×§×•×ª ×‘×ª×§×•×¤×” ×”× ×›×•× ×” (×©×™×/×©×¢×”).</p>
    <p><b>2) ×œ××” ×™×© CV ×’×‘×•×” ××‘×œ Gap ×§×˜×Ÿ?</b> ×”×ª×›× ×•×Ÿ ××•×œ×™ ×‘×¡×“×¨ â€œ×‘×××•×¦×¢â€, ××‘×œ ×™×© ×™××™×/×©×¢×•×ª ×§×™×¦×•×Ÿ. ×¤×” ×›×“××™ ×œ×”×©×ª××© ×‘×”×—×¨×’×ª ×ª××¨×™×›×™×/×˜×•×•×—×™× ×•×œ×‘×“×•×§ ×× ×–×• ×ª×•×¤×¢×” ×§×‘×•×¢×” ××• ××™×¨×•×¢×™×.</p>
    <p><b>3) ×œ××” Top-10 ×¨×™×§?</b> ×›×™ ××™×Ÿ ×¢××•×“×ª ×ª×›× ×•×Ÿ ×‘×§×‘×¦×™× ××• ×©×œ× ×–×•×”×ª×”. ××¤×©×¨ ×¢×“×™×™×Ÿ ×œ×”××œ×™×¥ ×ª×§×Ÿ ×œ×¤×™ ××—×•×–×•× ×™×, ××‘×œ â€œ×—×•×¡×¨/×¢×•×“×£â€ ×¦×¨×™×š Planned.</p>
  </div>
</div>

<script>
/* =======================
   Offline-first JS (no CDN)
   ======================= */

/* ---------- DOM ---------- */
const el = {
  drop: document.getElementById('drop'),
  file: document.getElementById('file'),
  btnPick: document.getElementById('btnPick'),
  btnReset: document.getElementById('btnReset'),
  loadState: document.getElementById('loadState'),
  loadMsg: document.getElementById('loadMsg'),
  depState: document.getElementById('depState'),
  err: document.getElementById('err'),
  warn: document.getElementById('warn'),
  filesCount: document.getElementById('filesCount'),
  filesList: document.getElementById('filesList'),
  rawCount: document.getElementById('rawCount'),
  okCount: document.getElementById('okCount'),
  outCount: document.getElementById('outCount'),

  // mapping
  mDate: document.getElementById('mDate'),
  mTime: document.getElementById('mTime'),
  mDur: document.getElementById('mDur'),
  mCluster: document.getElementById('mCluster'),
  mMakt: document.getElementById('mMakt'),
  mRoute: document.getElementById('mRoute'),
  mDir: document.getElementById('mDir'),
  mPlan: document.getElementById('mPlan'),
  mWD: document.getElementById('mWD'),
  durUnit: document.getElementById('durUnit'),
  gran: document.getElementById('gran'),
  outMode: document.getElementById('outMode'),
  minN: document.getElementById('minN'),
  btnApplyMap: document.getElementById('btnApplyMap'),

  main: document.getElementById('main'),

  // filters
  fCluster: document.getElementById('fCluster'),
  fMakt: document.getElementById('fMakt'),
  fRoute: document.getElementById('fRoute'),
  fDir: document.getElementById('fDir'),
  fDay: document.getElementById('fDay'),
  fWin: document.getElementById('fWin'),
  fHour: document.getElementById('fHour'),
  fFrom: document.getElementById('fFrom'),
  fTo: document.getElementById('fTo'),

  exFrom: document.getElementById('exFrom'),
  exTo: document.getElementById('exTo'),
  btnAddEx: document.getElementById('btnAddEx'),
  exList: document.getElementById('exList'),

  policy: document.getElementById('policy'),
  manualBox: document.getElementById('manualBox'),
  pct: document.getElementById('pct'),
  pctTxt: document.getElementById('pctTxt'),

  btnExport: document.getElementById('btnExport'),
  btnExportJSON: document.getElementById('btnExportJSON'),
  btnExportYAML: document.getElementById('btnExportYAML'),

  // KPI
  kN: document.getElementById('kN'),
  kMean: document.getElementById('kMean'),
  kRec: document.getElementById('kRec'),
  kPct: document.getElementById('kPct'),
  kCV: document.getElementById('kCV'),

  // canvases
  cvHist: document.getElementById('cvHist'),
  cvTrend: document.getElementById('cvTrend'),

  // tables
  tbl: document.getElementById('tbl'),
  topWorst: document.getElementById('topWorst'),
  topBest: document.getElementById('topBest'),
  ops: document.getElementById('ops'),

  // modal
  btnHelp: document.getElementById('btnHelp'),
  modalBack: document.getElementById('modalBack'),
  btnClose: document.getElementById('btnClose'),
};

/* ---------- State ---------- */
let FILES = [];
let ALL_ROWS = [];      // raw parsed objects from CSV(s)
let HEADERS = [];       // union headers

let M = null;           // mapping
let DATA = [];          // normalized records after mapping+QA (each: {cluster,makt,route,dir,dateISO,hour,win,dayType,durMin,plannedMin})
let DROPPED = {missing:0, invalid:0, parse:0, dateRange:0, excluded:0, outlier:0};

let EX_RANGES = [];     // list of {fromISO,toISO}
let LAST_TABLE = [];    // computed row summaries

/* ---------- Utility ---------- */
const pad2 = (n)=> String(n).padStart(2,'0');
const escapeHtml = (s)=> String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function showError(msg){ el.err.style.display='inline-flex'; el.err.textContent = msg; }
function hideError(){ el.err.style.display='none'; el.err.textContent=''; }
function showWarn(msg){ el.warn.style.display='inline-flex'; el.warn.textContent = msg; }
function hideWarn(){ el.warn.style.display='none'; el.warn.textContent=''; }
function setLoading(on, msg){
  el.loadState.style.display = on ? 'flex' : 'none';
  el.loadMsg.textContent = msg || '';
}
function updateDepState(){
  // Offline-first: always OK. Still show hint for preview limitations.
  el.depState.innerHTML = `
    <div><b>×¡×˜×˜×•×¡:</b> ×§×•×‘×¥ Offline-First. ××™×Ÿ ×ª×œ×•×ª ×‘-CDN. ×× â€œ×œ× ×¢×•×‘×“â€ â€” ×œ×¨×•×‘ ×–×” ×‘×’×œ×œ ×¤×ª×™×—×” ×‘-Preview ×©×—×•×¡× JavaScript.</div>
    <div class="smallNote">×¤×ª×¨×•×Ÿ: ×”×•×¨×“ ×œ××—×©×‘ ×•×¤×ª×— ×‘-Chrome/Edge (×œ× ×‘-Gmail/Drive Preview).</div>
  `;
}

/* CSV parsing (robust enough for typical exports) */
function detectDelimiter(headerLine){
  const cands=[',',';','\t','|'];
  let best=',', bestCount=-1;
  for(const c of cands){
    const cnt=(headerLine.split(c).length-1);
    if(cnt>bestCount){ best=c; bestCount=cnt; }
  }
  return best;
}
function splitCsvLine(line, delim){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else { inQ = !inQ; }
    } else if(ch === delim && !inQ){
      out.push(cur); cur='';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCsvText(text){
  text = String(text||'').replace(/^\uFEFF/,'');
  const lines = text.split(/\r\n|\n|\r/);
  // remove fully empty trailing lines
  const clean = lines.filter(l => l !== undefined && l !== null && String(l).trim().length>0);
  if(!clean.length) return [];
  const delim = detectDelimiter(clean[0]);
  const headers = splitCsvLine(clean[0], delim).map(h=>String(h||'').trim());
  const rows=[];
  for(let i=1;i<clean.length;i++){
    const cols = splitCsvLine(clean[i], delim);
    // skip if all empty
    if(!cols.some(c=>String(c||'').trim().length)) continue;
    const r={};
    for(let j=0;j<headers.length;j++){
      r[headers[j]] = (cols[j]===undefined ? '' : String(cols[j]).trim());
    }
    rows.push(r);
  }
  return rows;
}
function readFileText(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||''));
    fr.onerror = ()=>reject(fr.error || new Error('FileReader error'));
    fr.readAsText(file, 'utf-8');
  });
}
async function parseFiles(files){
  ALL_ROWS=[]; HEADERS=[];
  const fileArr = Array.from(files||[]);
  FILES = fileArr.map(f=>f.name);
  el.filesCount.textContent = String(FILES.length);
  el.filesList.innerHTML = FILES.length ? ("<b>× ×˜×¢× ×•:</b> " + FILES.map(escapeHtml).join(" â€¢ ")) : "";

  let raw=0;
  for(const f of fileArr){
    try{
      const txt = await readFileText(f);
      const rows = parseCsvText(txt);
      raw += rows.length;
      ALL_ROWS = ALL_ROWS.concat(rows);
      for(const r of rows){
        for(const k of Object.keys(r||{})){
          if(k && !HEADERS.includes(k)) HEADERS.push(k);
        }
      }
    }catch(e){
      console.error(e);
    }
  }
  el.rawCount.textContent = String(raw);
}

/* Mapping & parsing values */
const SYN = {
  date: ['date','Date','×ª××¨×™×š','TripSourceDate','service_date','TripDate','Date_'],
  time: ['departure_time','Time','×©×¢×”','TripSourceTime','DepartureTime','Planned_Start_Time','start_time','TripStartTime','hour'],
  dur:  ['actual_duration','Duration','Actual_Duration','ActualDuration','××©×š','TravelTime','duration','travel_time','ActualDurationSeconds','ActualDurationMinutes'],
  cluster:['cluster','Cluster','ClusterName','××©×›×•×œ','××©×›×•×œname','Depot','Region','cluster_name'],
  makt: ['makt','××§×˜','××§×´×˜','RouteMakt','LineMakt','MaktLine','RouteMakat'],
  route: ['route','Route','RouteId','RouteShortName','Line','line_id','×§×•','××¡×¤×¨ ×§×•','RouteNumber','LineNumber','route_num'],
  dir:  ['direction','Direction','×›×™×•×•×Ÿ','dir','DirectionId'],
  plan: ['planned_duration','PlannedDuration','planned','Planned_Time','ScheduleDuration','ScheduledDuration','PlannedDurationMin','planned_minutes'],
  wd:   ['WeekDay','weekday','day_of_week','DOW','×™×•× ×‘×©×‘×•×¢']
};
function bestHeader(headers, keys){
  const lower = headers.map(h=>String(h||'').toLowerCase());
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.indexOf(kk);
    if(idx>=0) return headers[idx];
  }
  // fuzzy contains
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.findIndex(h => h.includes(kk));
    if(idx>=0) return headers[idx];
  }
  return '';
}

