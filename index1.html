<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ (Offline-First)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0e1830;
      --text:#e6eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#10b981;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background: radial-gradient(900px 400px at 80% -20%, rgba(124,58,237,.30), transparent 55%),
                  radial-gradient(900px 400px at 10% 0%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    a{color:#bfa7ff}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:16px 16px;border:1px solid var(--line);border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
    }
    .title h1{margin:0;font-size:22px;letter-spacing:.2px}
    .title p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;color:var(--muted)
    }
    .pill b{color:var(--text)}
    .grid{display:grid;gap:12px}
    @media(min-width:980px){ .grid.cols2{grid-template-columns:1.2fr .8fr} }
    @media(min-width:980px){ .grid.cols3{grid-template-columns:1fr 1fr 1fr} }
    @media(min-width:980px){ .grid.cols4{grid-template-columns:repeat(4, 1fr)} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 16px 36px rgba(0,0,0,.20);
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      transition: transform .08s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(124,58,237,.35); border-color: rgba(124,58,237,.55)}
    .btn.green{background: rgba(34,197,94,.25); border-color: rgba(34,197,94,.45)}
    .btn.red{background: rgba(239,68,68,.22); border-color: rgba(239,68,68,.40)}
    .btn.small{padding:7px 10px;border-radius:12px;font-size:12px}
    .drop{
      padding:18px;
      border-radius:18px;
      border:2px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      text-align:center;
    }
    .drop.drag{border-color: rgba(124,58,237,.8); background: rgba(124,58,237,.10)}
    .drop p{margin:6px 0;color:var(--muted)}
    input, select{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      outline:none;
      min-height:38px;
    }
    input[type="date"]{color-scheme: dark;}
    input[type="range"]{width:220px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .field{min-width:170px}
    .mono{font-family:var(--mono)}
    .kpi{
      padding:12px;border-radius:18px;border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .kpi .v{font-size:22px;font-weight:900;line-height:1.1}
    .kpi .l{font-size:12px;color:var(--muted);margin-top:5px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;color:var(--muted)
    }
    .badge.good{background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.35); color:#bff7e7}
    .badge.bad{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.38); color:#ffd0d0}
    .badge.warn{background: rgba(245,158,11,.18); border-color: rgba(245,158,11,.35); color:#ffe6b3}
    .badge.purp{background: rgba(124,58,237,.20); border-color: rgba(124,58,237,.40); color:#e8dbff}
    .tableWrap{overflow:auto;max-height:440px;border-radius:16px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:right;white-space:nowrap}
    th{position:sticky;top:0;background: rgba(10,18,34,.96);backdrop-filter: blur(6px);z-index:1;color:#cfe0ff}
    tr:hover td{background: rgba(255,255,255,.03)}
    .twoCanv{display:grid;gap:12px}
    @media(min-width:980px){ .twoCanv{grid-template-columns:1fr 1fr} }
    canvas{width:100%;height:280px;background: rgba(255,255,255,.02);border:1px solid var(--line);border-radius:16px}
    .hr{height:1px;background: var(--line);margin:10px 0}
    .modalBack{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background: rgba(0,0,0,.55);z-index:9999;padding:16px;
    }
    .modal{
      width:min(980px, 100%);
      max-height: min(85vh, 900px);
      overflow:auto;
      background: #0b1428;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
    }
    .modal h3{margin:0 0 10px}
    .modal p{color:var(--muted);line-height:1.55}
    .modal ul{color:var(--muted);line-height:1.6}
    .modal .x{float:left}
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.6
    }
    .smallNote{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>××¢×¨×›×ª × ×™×ª×•×— ×–×× ×™ ×ª×§×Ÿ â€” Offlineâ€‘First ğŸšŒ</h1>
      <p>×˜×•×¢×Ÿ CSV ××§×•××™×ª (Drag&Drop ××• ×‘×—×™×¨×”), ×¡×™× ×•× ×™×, × ×™×§×•×™ ×—×¨×™×’×™×, ××—×•×–×•× ×™× ×“×™× ××™×™×, Topâ€‘10 ×‘×¢×™×™×ª×™×™×/××¦×˜×™×™× ×™×, ×•×™×™×¦×•×.</p>
    </div>
    <div class="row">
      <div class="pill"><span class="mono">v23</span> <b>×œ×œ× ×ª×œ×•×ª ×‘â€‘CDN</b></div>
      <button id="btnHelp" class="btn primary">××“×¨×™×š ×§×¦×¨</button>
    </div>
  </header>

  <div class="grid cols2" style="margin-top:12px">
    <div class="card">
      <h2>1) ×˜×¢×™× ×ª × ×ª×•× ×™×</h2>
      <div id="drop" class="drop">
        <div class="row" style="justify-content:center">
          <button id="btnPick" class="btn green">×‘×—×¨ ×§×‘×¦×™× (Multiple)</button>
          <button id="btnReset" class="btn red">××™×¤×•×¡</button>
        </div>
        <p>××¤×©×¨ ×œ×’×¨×•×¨ ×œ×›××Ÿ ×§×‘×¦×™ CSV (××—×“ ××• ×™×•×ª×¨). ×›×œ ×”×§×‘×¦×™× ×™×ª××—×“×•.</p>
        <p class="smallNote">×˜×™×¤: ××œ ×ª×¤×ª×— ××ª ×”×§×•×‘×¥ ×‘Ö¾Preview ×©×œ Gmail/Drive. ×ª×•×¨×™×“ ×œ××—×©×‘ ×•×ª×¤×ª×— ×‘â€‘Chrome/Edge.</p>
        <input id="file" type="file" accept=".csv,text/csv" multiple style="display:none"/>
      </div>

      <div id="loadState" class="row" style="margin-top:10px;display:none">
        <span class="badge purp mono">×˜×•×¢×Ÿâ€¦</span>
        <span id="loadMsg" class="muted">××¢×‘×“ × ×ª×•× ×™×â€¦</span>
      </div>

      <div id="depState" class="hint" style="margin-top:10px"></div>
      <div id="err" class="badge bad" style="display:none;margin-top:10px"></div>
      <div id="warn" class="badge warn" style="display:none;margin-top:10px"></div>

      <div class="hr"></div>
      <div class="row">
        <span class="badge">×§×‘×¦×™×: <b id="filesCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×’×•×œ××™×•×ª: <b id="rawCount">0</b></span>
        <span class="badge">×©×•×¨×•×ª ×ª×§×™× ×•×ª: <b id="okCount">0</b></span>
        <span class="badge">×—×¨×™×’×™× ×©× ×•×§×•: <b id="outCount">0</b></span>
      </div>
      <div id="filesList" class="hint" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>2) ××™×¤×•×™ ×¢××•×“×•×ª (Auto + Override)</h2>
      <div class="hint">×”××¢×¨×›×ª ×× ×¡×” ×œ×–×”×•×ª ×¢××•×“×•×ª ××•×˜×•××˜×™×ª. ×× ××©×”×• ×œ× ××¡×ª×“×¨ â€” ×‘×—×¨ ×™×“× ×™×ª.</div>

      <div class="grid cols3" style="margin-top:10px">
        <div class="field">
          <label>×ª××¨×™×š (date)</label>
          <select id="mDate"></select>
        </div>
        <div class="field">
          <label>×©×¢×ª ×™×¦×™××” (departure_time / hour)</label>
          <select id="mTime"></select>
        </div>
        <div class="field">
          <label>××©×š ×‘×¤×•×¢×œ (actual_duration)</label>
          <select id="mDur"></select>
        </div>

        <div class="field">
          <label>××©×›×•×œ (cluster)</label>
          <select id="mCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×• (makt)</label>
          <select id="mMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×• (route_num)</label>
          <select id="mRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ (direction)</label>
          <select id="mDir"></select>
        </div>
        <div class="field">
          <label>×ª×›× ×•×Ÿ (planned_duration) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mPlan"></select>
        </div>
        <div class="field">
          <label>WeekDay (1â€“7) â€” ××•×¤×¦×™×•× ×œ×™</label>
          <select id="mWD"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field">
          <label>×™×—×™×“×•×ª ××©×š</label>
          <select id="durUnit">
            <option value="auto">Auto</option>
            <option value="sec">×©× ×™×•×ª</option>
            <option value="min">×“×§×•×ª</option>
            <option value="hhmmss">HH:MM:SS</option>
            <option value="hhmm">HH:MM</option>
          </select>
        </div>
        <div class="field">
          <label>×¨×–×•×œ×•×¦×™×™×ª ×ª×§×Ÿ</label>
          <select id="gran">
            <option value="window">×—×œ×•×Ÿ ×–××Ÿ</option>
            <option value="hour">×©×¢×”</option>
          </select>
        </div>
        <div class="field">
          <label>× ×™×§×•×™ ×—×¨×™×’×™×</label>
          <select id="outMode">
            <option value="mad">Robust MAD</option>
            <option value="iqr">IQR</option>
            <option value="off">×œ×œ×</option>
          </select>
        </div>
        <div class="field">
          <label>×¡×£ ××™× ×™××•× ×“×’×™××•×ª (N)</label>
          <input id="minN" type="number" min="3" step="1" value="10"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnApplyMap" class="btn primary">×™×™×©× ××™×¤×•×™ + ×—×©×‘</button>
        <span class="hint">××—×¨×™ ×©×™× ×•×™ ××™×¤×•×™/×™×—×™×“×•×ª â€” ×œ×—×¥ â€œ×™×™×©×â€.</span>
      </div>
    </div>
  </div>

  <div id="main" style="display:none; margin-top:12px" class="grid">
    <div class="card">
      <h2>3) ×¡×™× ×•× ×™× + ×ª××¨×™×›×™×/×”×—×¨×’×•×ª</h2>
      <div class="grid cols3">
        <div class="field">
          <label>××©×›×•×œ</label>
          <select id="fCluster"></select>
        </div>
        <div class="field">
          <label>××§×´×˜ ×§×•</label>
          <select id="fMakt"></select>
        </div>
        <div class="field">
          <label>××¡×¤×¨ ×§×•</label>
          <select id="fRoute"></select>
        </div>

        <div class="field">
          <label>×›×™×•×•×Ÿ</label>
          <select id="fDir"></select>
        </div>
        <div class="field">
          <label>×¡×•×’ ×™×•×</label>
          <select id="fDay"></select>
        </div>
        <div class="field">
          <label>×—×œ×•×Ÿ ×–××Ÿ</label>
          <select id="fWin"></select>
        </div>

        <div class="field">
          <label>×©×¢×” ×¡×¤×¦×™×¤×™×ª</label>
          <select id="fHour"></select>
        </div>
        <div class="field">
          <label>×˜×•×•×— ×ª××¨×™×›×™× (×›×•×œ×œ)</label>
          <div class="row" style="gap:8px">
            <input id="fFrom" type="date"/>
            <input id="fTo" type="date"/>
          </div>
        </div>
        <div class="field">
          <label>×”×—×¨×’×ª ×˜×•×•×—×™ ×ª××¨×™×›×™× (×œ××©×œ ×”×¤×’× ×•×ª/×—×•×¨×£)</label>
          <div class="row" style="gap:8px">
            <input id="exFrom" type="date"/>
            <input id="exTo" type="date"/>
            <button id="btnAddEx" class="btn small">×”×•×¡×£</button>
          </div>
          <div id="exList" class="hint" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <div class="field" style="min-width:360px">
          <label>××“×™× ×™×•×ª ××—×•×–×•× ×™×</label>
          <select id="policy">
            <option value="dynamic">×“×™× ××™: ×©×™×=P90, ×©×¤×œ=P85 + ×”×ª×××•×ª ×œ×¤×™ CV/N</option>
            <option value="manual">×™×“× ×™: ××—×•×–×•×Ÿ ×§×‘×•×¢ ×œ×›×œ ×”××¦×‘×™×</option>
          </select>
        </div>
        <div class="field" id="manualBox" style="display:none">
          <label>××—×•×–×•×Ÿ ×™×“× ×™</label>
          <div class="row">
            <input id="pct" type="range" min="50" max="99" value="85"/>
            <span class="badge purp mono"><b id="pctTxt">P85</b></span>
          </div>
        </div>
        <button id="btnExport" class="btn green">×™×™×¦×•× CSV</button>
        <button id="btnExportJSON" class="btn">JSON</button>
        <button id="btnExportYAML" class="btn">YAML</button>
      </div>
    </div>

    <div class="grid cols4">
      <div class="kpi">
        <div class="v mono" id="kN">â€”</div>
        <div class="l">×“×’×™××•×ª (××—×¨×™ × ×™×§×•×™)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kMean">â€”</div>
        <div class="l">×××•×¦×¢ (×“×§×•×ª)</div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kRec">â€”</div>
        <div class="l">×ª×§×Ÿ ××•××œ×¥ <span class="badge purp mono" id="kPct">â€”</span></div>
      </div>
      <div class="kpi">
        <div class="v mono" id="kCV">â€”</div>
        <div class="l">CV (×©×•× ×•×ª ×™×—×¡×™×ª)</div>
      </div>
    </div>

    <div class="twoCanv">
      <div class="card">
        <h2>4) ×”×™×¡×˜×•×’×¨× â€” ×”×ª×¤×œ×’×•×ª ×–×× ×™ × ×¡×™×¢×”</h2>
        <canvas id="cvHist" width="900" height="280"></canvas>
        <div class="hint">×¦×™×¨ X = ×–××Ÿ × ×¡×™×¢×” (×“×§×•×ª), ×¦×™×¨ Y = ×›××” × ×¡×™×¢×•×ª × ×¤×œ×• ×‘×›×œ ×˜×•×•×—. ×”×§×• ×”×¡×’×•×œ = ×ª×§×Ÿ ××•××œ×¥.</div>
      </div>
      <div class="card">
        <h2>5) ××’××” ×œ×¤×™ ×©×¢×” â€” ×××•×¦×¢ ××•×œ ×ª×§×Ÿ</h2>
        <canvas id="cvTrend" width="900" height="280"></canvas>
        <div class="hint">××¦×™×’ ×××•×¦×¢ (×§×• ×‘×”×™×¨) ××•×œ ×ª×§×Ÿ (×¡×’×•×œ) ×œ×›×œ ×©×¢×”. ×× ××™×Ÿ × ×ª×•× ×™× ×‘×©×¢×” â€” ×–×” ×™×•×¤×™×¢ ×›×¨×™×§.</div>
      </div>
    </div>

    <div class="grid cols2">
      <div class="card">
        <h2>6) Topâ€‘10 â€œ×‘×¢×™×™×ª×™×™×â€ (×—×•×¡×¨ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th>Rec</th><th class="mono">×¤×¢×¨</th><th>Risk</th><th class="mono">×—×•×¡×¨</th>
              </tr>
            </thead>
            <tbody id="topWorst"></tbody>
          </table>
        </div>
        <div class="hint">â€œ×—×•×¡×¨â€ = (Rec âˆ’ Planned) ×›×©×—×™×•×‘×™. ×× ××™×Ÿ ×ª×›× ×•×Ÿ ×‘×§×‘×¦×™× â€” ×”×¨×©×™××” ×ª×™×©××¨ ×¨×™×§×”.</div>
      </div>

      <div class="card">
        <h2>7) Topâ€‘10 â€œ××¦×˜×™×™× ×™×â€ (×¢×•×“×£ ×ª×§×Ÿ) + Risk</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
                <th class="mono">N</th><th class="mono">Planned</th><th class="mono">CV</th>
                <th>Rec</th><th class="mono">×¤×¢×¨</th><th>Risk</th><th class="mono">×¢×•×“×£</th>
              </tr>
            </thead>
            <tbody id="topBest"></tbody>
          </table>
        </div>
        <div class="hint">â€œ×¢×•×“×£â€ = (Planned âˆ’ Rec) ×›×©×—×™×•×‘×™. ×–×” ××§×•× ×œ×—×¡×•×š ×ª×§×Ÿ ×‘×œ×™ ×œ×¤×’×•×¢ ×‘×××™× ×•×ª (×‘×–×”×™×¨×•×ª!).</div>
      </div>
    </div>

    <div class="card">
      <h2>8) ×˜×‘×œ×ª ×ª×§× ×™× ××•××œ×¦×™× (×œ×¤×™ ×”×¨×–×•×œ×•×¦×™×” ×©× ×‘×—×¨×”)</h2>
      <div class="row">
        <span class="badge">×”×¢×¨×”: ×¢××•×“×•×ª <b>Rec</b> + <b>Pct</b> ××¦×™×’×•×ª ××ª ×”×ª×§×Ÿ ×•×”××—×•×–×•×Ÿ ×©×‘×××ª ×”×•×¤×¢×œ (×“×™× ××™/×™×“× ×™).</span>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>××©×›×•×œ</th><th>××§×´×˜</th><th>×§×•</th><th>×›×™×•×•×Ÿ</th><th>×—×œ×•×Ÿ/×©×¢×”</th>
              <th class="mono">N (raw)</th><th class="mono">N (used)</th><th class="mono">Removed</th>
              <th class="mono">Mean</th><th class="mono">Median</th><th class="mono">STD</th><th class="mono">CV</th>
              <th class="mono">P85</th><th class="mono">P90</th><th class="mono">P95</th>
              <th class="mono">Planned</th><th class="mono">Gap</th>
              <th>Rec</th><th class="mono">Pct</th><th>Risk</th><th>×¡×˜×˜×•×¡</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>×”××œ×¦×•×ª ××•×¤×¨×˜×™×‘×™×•×ª ×œ××—×¨ ×‘×‘×•×§×¨</h2>
      <ul id="ops" class="muted" style="margin:8px 0 0 0; padding-right:18px"></ul>
      <div class="hint" style="margin-top:8px">×”×”××œ×¦×•×ª × ×‘× ×•×ª ××•×˜×•××˜×™×ª ××”×˜×‘×œ××•×ª: ××™×¤×” Risk ×’×‘×•×” + ×—×•×¡×¨ ×ª×§×Ÿ ×‘×©×™×/×©×¢×” ×¦×¤×•×¤×”.</div>
    </div>
  </div>

  <footer class="hint" style="margin:14px 4px 6px">
    ×§×•×‘×¥ ×™×—×™×“. ×¢×•×‘×“ ×’× ×‘×œ×™ ××™× ×˜×¨× ×˜. ×›×“×™ ×œ×”×¤×•×š ×œ×“×£ ××™× ×˜×¨× ×˜: ×”×¢×œ×” ×œâ€‘GitHub Pages / Netlify / SharePoint ×›×§×•×‘×¥ HTML ×¡×˜×˜×™.
  </footer>
</div>

<!-- Modal -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <button class="btn x" id="btnClose">×¡×’×•×¨ âœ•</button>
    <h3>××“×¨×™×š ×§×¦×¨ â€” ×‘×©×¤×” ×¤×©×•×˜×”</h3>

    <p><b>××” ×–×” â€œ×–××Ÿ ×ª×§×Ÿâ€ ×›××Ÿ?</b> ×–×” ×”×–××Ÿ ×©×× ×—× ×• ×¨×•×¦×™× ×œ×”×’×“×™×¨ ×‘×œ×•×´×– ×›×“×™ ×©×”× ×¡×™×¢×” ×ª×¢××•×“ ×‘×¨×•×‘ ×”××§×¨×™× ×‘×–××Ÿ ×•×œ× ×ª×™×™×¦×¨ ××™×—×•×¨×™×.</p>

    <ul>
      <li><b>Histogram (×”×™×¡×˜×•×’×¨×)</b>: ××¨××” ×›××” × ×¡×™×¢×•×ª ×”×™×• ×‘×›×œ ×˜×•×•×— ×©×œ ×“×§×•×ª. ×× ×™×© â€œ×–× ×‘ ×™×× ×™â€ ××¨×•×š â€” ×™×© ×”×¨×‘×” × ×¡×™×¢×•×ª ××™×˜×™×•×ª ×œ×¤×¢××™×.</li>
      <li><b>××—×•×–×•×Ÿ (P85/P90â€¦)</b>: ×œ×“×•×’××” P90 ××•××¨: 90% ××”× ×¡×™×¢×•×ª ×”×™×• ×§×¦×¨×•×ª ××• ×©×•×•×ª ×œ×–××Ÿ ×”×–×”. ×–×” ×–××Ÿ ×ª×§×Ÿ â€œ×©××¨× ×™â€ ×™×•×ª×¨ ××××•×¦×¢.</li>
      <li><b>Mean / Median</b>: ×××•×¦×¢ ××•×œ ×—×¦×™×•×Ÿ. ×× ×”×—×¦×™×•×Ÿ × ××•×š ××”×××•×¦×¢ â€” ×›× ×¨××” ×©×™×© ×—×¨×™×’×™× ×©××•×©×›×™× ×œ××¢×œ×”.</li>
      <li><b>STD</b>: ×¡×˜×™×™×ª ×ª×§×Ÿ â€” ×›××” ×”×–×× ×™× â€œ××ª×¤×–×¨×™×â€. ×’×‘×•×” = ×”×¨×‘×” ×©×•× ×•×ª.</li>
      <li><b>CV</b>: ×¡×˜×™×™×ª ×ª×§×Ÿ ×™×—×¡×™×ª ×œ×××•×¦×¢. ×–×” ××“×“ ××¦×•×™×Ÿ ×œ×”×©×•×•××” ×‘×™×Ÿ ×§×•×•×™× ××¨×•×›×™× ×•×§×¦×¨×™×. ×›×œ×œ ××¦×‘×¢: ××¢×œ ~0.25 = ×©×•× ×•×ª ×’×‘×•×”×”.</li>
      <li><b>Planned</b>: ×–××Ÿ ×”×ª×›× ×•×Ÿ ×©×™×© ×œ×š ×‘×§×•×‘×¥ (×× ×™×©). ×× ×—× ×• ××¦×™×’×™× ××•×ª×• ×›â€‘Median ×›×“×™ ×œ×”×™×•×ª ×™×¦×™×‘.</li>
      <li><b>Gap</b>: Rec âˆ’ Planned. <b>×—×™×•×‘×™</b> = ×—×¡×¨ ×ª×§×Ÿ (×ª×›× ×•×Ÿ ×§×¦×¨ ××“×™). <b>×©×œ×™×œ×™</b> = ×¢×•×“×£ ×ª×§×Ÿ.</li>
      <li><b>Risk</b>: ×¦×™×•×Ÿ 0â€“100 ×©××“×¨×’ ××™×¤×” ×”×›×™ â€œ×›×•××‘â€ ×œ×”×ª×¢×¨×‘. ××©×§×œ×œ: ×©×•× ×•×ª (CV), ×’×•×“×œ ×¤×¢×¨ ××•×œ ×ª×›× ×•×Ÿ, ×•×›××” ××¢×˜ × ×ª×•× ×™× ×™×©.</li>
    </ul>

    <p><b>××” ×œ×ª×§×Ÿ ×§×•×“×?</b> ×‘×“×¨×š ×›×œ×œ ××ª×—×™×œ×™× ××™×¤×” ×©×™×© <b>×—×•×¡×¨ ×ª×§×Ÿ</b> + <b>Risk ×’×‘×•×”</b> (×‘××™×•×—×“ ×‘×©×™×). ×©×•× ×•×ª ×’×‘×•×”×” ×œ×‘×“×” ×œ× ×ª××™×“ ××•××¨×ª ×©×¦×¨×™×š ×œ×”×•×¡×™×£ ×–××Ÿ â€” ×œ×¤×¢××™× ×–×” ×‘×¢×™×™×ª ×ª×¤×¢×•×œ/×¢×•××¡ × ×§×•×“×ª×™, ×•××– ×¦×¨×™×š ×˜×™×¤×•×œ ××—×¨ (×¤×™×§×•×—, × ×ª×´×¦, ×©×™× ×•×™ ×—×œ×•× ×•×ª).</p>

    <div class="hr"></div>
    <h3>FAQ ×§×¦×¨</h3>
    <p><b>1) ×œ××” ×™×© ×œ×™ â€œ×—×•×¡×¨ ×ª×§×Ÿâ€ ××‘×œ CV × ××•×š?</b> ×›× ×¨××” ×©×”×§×• ×¢×§×‘×™, ×¤×©×•×˜ ×”×ª×›× ×•×Ÿ ×§×¦×¨ ××“×™. ×§×œ ×œ×ª×§×Ÿ â€” ×œ×”×•×¡×™×£ ×“×§×•×ª ×‘×ª×§×•×¤×” ×”× ×›×•× ×” (×©×™×/×©×¢×”).</p>
    <p><b>2) ×œ××” ×™×© CV ×’×‘×•×” ××‘×œ Gap ×§×˜×Ÿ?</b> ×”×ª×›× ×•×Ÿ ××•×œ×™ ×‘×¡×“×¨ â€œ×‘×××•×¦×¢â€, ××‘×œ ×™×© ×™××™×/×©×¢×•×ª ×§×™×¦×•×Ÿ. ×¤×” ×›×“××™ ×œ×”×©×ª××© ×‘×”×—×¨×’×ª ×ª××¨×™×›×™×/×˜×•×•×—×™× ×•×œ×‘×“×•×§ ×× ×–×• ×ª×•×¤×¢×” ×§×‘×•×¢×” ××• ××™×¨×•×¢×™×.</p>
    <p><b>3) ×œ××” Topâ€‘10 ×¨×™×§?</b> ×›×™ ××™×Ÿ ×¢××•×“×ª ×ª×›× ×•×Ÿ ×‘×§×‘×¦×™× ××• ×©×œ× ×–×•×”×ª×”. ××¤×©×¨ ×¢×“×™×™×Ÿ ×œ×”××œ×™×¥ ×ª×§×Ÿ ×œ×¤×™ ××—×•×–×•× ×™×, ××‘×œ â€œ×—×•×¡×¨/×¢×•×“×£â€ ×¦×¨×™×š Planned.</p>
  </div>
</div>

<script>
/* =======================
   Offline-first JS (no CDN)
   ======================= */

/* ---------- DOM ---------- */
const el = {
  drop: document.getElementById('drop'),
  file: document.getElementById('file'),
  btnPick: document.getElementById('btnPick'),
  btnReset: document.getElementById('btnReset'),
  loadState: document.getElementById('loadState'),
  loadMsg: document.getElementById('loadMsg'),
  depState: document.getElementById('depState'),
  err: document.getElementById('err'),
  warn: document.getElementById('warn'),
  filesCount: document.getElementById('filesCount'),
  filesList: document.getElementById('filesList'),
  rawCount: document.getElementById('rawCount'),
  okCount: document.getElementById('okCount'),
  outCount: document.getElementById('outCount'),

  // mapping
  mDate: document.getElementById('mDate'),
  mTime: document.getElementById('mTime'),
  mDur: document.getElementById('mDur'),
  mCluster: document.getElementById('mCluster'),
  mMakt: document.getElementById('mMakt'),
  mRoute: document.getElementById('mRoute'),
  mDir: document.getElementById('mDir'),
  mPlan: document.getElementById('mPlan'),
  mWD: document.getElementById('mWD'),
  durUnit: document.getElementById('durUnit'),
  gran: document.getElementById('gran'),
  outMode: document.getElementById('outMode'),
  minN: document.getElementById('minN'),
  btnApplyMap: document.getElementById('btnApplyMap'),

  main: document.getElementById('main'),

  // filters
  fCluster: document.getElementById('fCluster'),
  fMakt: document.getElementById('fMakt'),
  fRoute: document.getElementById('fRoute'),
  fDir: document.getElementById('fDir'),
  fDay: document.getElementById('fDay'),
  fWin: document.getElementById('fWin'),
  fHour: document.getElementById('fHour'),
  fFrom: document.getElementById('fFrom'),
  fTo: document.getElementById('fTo'),

  exFrom: document.getElementById('exFrom'),
  exTo: document.getElementById('exTo'),
  btnAddEx: document.getElementById('btnAddEx'),
  exList: document.getElementById('exList'),

  policy: document.getElementById('policy'),
  manualBox: document.getElementById('manualBox'),
  pct: document.getElementById('pct'),
  pctTxt: document.getElementById('pctTxt'),

  btnExport: document.getElementById('btnExport'),
  btnExportJSON: document.getElementById('btnExportJSON'),
  btnExportYAML: document.getElementById('btnExportYAML'),

  // KPI
  kN: document.getElementById('kN'),
  kMean: document.getElementById('kMean'),
  kRec: document.getElementById('kRec'),
  kPct: document.getElementById('kPct'),
  kCV: document.getElementById('kCV'),

  // canvases
  cvHist: document.getElementById('cvHist'),
  cvTrend: document.getElementById('cvTrend'),

  // tables
  tbl: document.getElementById('tbl'),
  topWorst: document.getElementById('topWorst'),
  topBest: document.getElementById('topBest'),
  ops: document.getElementById('ops'),

  // modal
  btnHelp: document.getElementById('btnHelp'),
  modalBack: document.getElementById('modalBack'),
  btnClose: document.getElementById('btnClose'),
};

/* ---------- State ---------- */
let FILES = [];
let ALL_ROWS = [];      // raw parsed objects from CSV(s)
let HEADERS = [];       // union headers

let M = null;           // mapping
let DATA = [];          // normalized records after mapping+QA (each: {cluster,makt,route,dir,dateISO,hour,win,dayType,durMin,plannedMin})
let DROPPED = {missing:0, invalid:0, parse:0, dateRange:0, excluded:0, outlier:0};

let EX_RANGES = [];     // list of {fromISO,toISO}
let LAST_TABLE = [];    // computed row summaries

/* ---------- Utility ---------- */
const pad2 = (n)=> String(n).padStart(2,'0');
const escapeHtml = (s)=> String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function showError(msg){ el.err.style.display='inline-flex'; el.err.textContent = msg; }
function hideError(){ el.err.style.display='none'; el.err.textContent=''; }
function showWarn(msg){ el.warn.style.display='inline-flex'; el.warn.textContent = msg; }
function hideWarn(){ el.warn.style.display='none'; el.warn.textContent=''; }
function setLoading(on, msg){
  el.loadState.style.display = on ? 'flex' : 'none';
  el.loadMsg.textContent = msg || '';
}
function updateDepState(){
  // Offline-first: always OK. Still show hint for preview limitations.
  el.depState.innerHTML = `
    <div><b>×¡×˜×˜×•×¡:</b> ×§×•×‘×¥ Offlineâ€‘First. ××™×Ÿ ×ª×œ×•×ª ×‘â€‘CDN. ×× â€œ×œ× ×¢×•×‘×“â€ â€” ×œ×¨×•×‘ ×–×” ×‘×’×œ×œ ×¤×ª×™×—×” ×‘â€‘Preview ×©×—×•×¡× JavaScript.</div>
    <div class="smallNote">×¤×ª×¨×•×Ÿ: ×”×•×¨×“ ×œ××—×©×‘ ×•×¤×ª×— ×‘â€‘Chrome/Edge (×œ× ×‘â€‘Gmail/Drive Preview).</div>
  `;
}

/* CSV parsing (robust enough for typical exports) */
function detectDelimiter(headerLine){
  const cands=[',',';','\t','|'];
  let best=',', bestCount=-1;
  for(const c of cands){
    const cnt=(headerLine.split(c).length-1);
    if(cnt>bestCount){ best=c; bestCount=cnt; }
  }
  return best;
}
function splitCsvLine(line, delim){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){
      if(inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else { inQ = !inQ; }
    } else if(ch === delim && !inQ){
      out.push(cur); cur='';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}
function parseCsvText(text){
  text = String(text||'').replace(/^\uFEFF/,'');
  const lines = text.split(/\r\n|\n|\r/);
  // remove fully empty trailing lines
  const clean = lines.filter(l => l !== undefined && l !== null && String(l).trim().length>0);
  if(!clean.length) return [];
  const delim = detectDelimiter(clean[0]);
  const headers = splitCsvLine(clean[0], delim).map(h=>String(h||'').trim());
  const rows=[];
  for(let i=1;i<clean.length;i++){
    const cols = splitCsvLine(clean[i], delim);
    // skip if all empty
    if(!cols.some(c=>String(c||'').trim().length)) continue;
    const r={};
    for(let j=0;j<headers.length;j++){
      r[headers[j]] = (cols[j]===undefined ? '' : String(cols[j]).trim());
    }
    rows.push(r);
  }
  return rows;
}
function readFileText(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(String(fr.result||''));
    fr.onerror = ()=>reject(fr.error || new Error('FileReader error'));
    fr.readAsText(file, 'utf-8');
  });
}
async function parseFiles(files){
  ALL_ROWS=[]; HEADERS=[];
  const fileArr = Array.from(files||[]);
  FILES = fileArr.map(f=>f.name);
  el.filesCount.textContent = String(FILES.length);
  el.filesList.innerHTML = FILES.length ? ("<b>× ×˜×¢× ×•:</b> " + FILES.map(escapeHtml).join(" â€¢ ")) : "";

  let raw=0;
  for(const f of fileArr){
    try{
      const txt = await readFileText(f);
      const rows = parseCsvText(txt);
      raw += rows.length;
      ALL_ROWS = ALL_ROWS.concat(rows);
      for(const r of rows){
        for(const k of Object.keys(r||{})){
          if(k && !HEADERS.includes(k)) HEADERS.push(k);
        }
      }
    }catch(e){
      console.error(e);
    }
  }
  el.rawCount.textContent = String(raw);
}

/* Mapping & parsing values */
const SYN = {
  date: ['date','Date','×ª××¨×™×š','TripSourceDate','service_date','TripDate','Date_'],
  time: ['departure_time','Time','×©×¢×”','TripSourceTime','DepartureTime','Planned_Start_Time','start_time','TripStartTime','hour'],
  dur:  ['actual_duration','Duration','Actual_Duration','ActualDuration','××©×š','TravelTime','duration','travel_time','ActualDurationSeconds','ActualDurationMinutes'],
  cluster:['cluster','Cluster','ClusterName','××©×›×•×œ','××©×›×•×œname','Depot','Region','cluster_name'],
  makt: ['makt','××§×˜','××§×´×˜','RouteMakt','LineMakt','MaktLine','RouteMakat'],
  route: ['route','Route','RouteId','RouteShortName','Line','line_id','×§×•','××¡×¤×¨ ×§×•','RouteNumber','LineNumber','route_num'],
  dir:  ['direction','Direction','×›×™×•×•×Ÿ','dir','DirectionId'],
  plan: ['planned_duration','PlannedDuration','planned','Planned_Time','ScheduleDuration','ScheduledDuration','PlannedDurationMin','planned_minutes'],
  wd:   ['WeekDay','weekday','day_of_week','DOW','×™×•× ×‘×©×‘×•×¢']
};
function bestHeader(headers, keys){
  const lower = headers.map(h=>String(h||'').toLowerCase());
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.indexOf(kk);
    if(idx>=0) return headers[idx];
  }
  // fuzzy contains
  for(const k of keys){
    const kk = String(k).toLowerCase();
    const idx = lower.findIndex(h => h.includes(kk));
    if(idx>=0) return headers[idx];
  }
  return '';
}
function fillSelect(sel, headers, preferred){
  sel.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = 'â€” ×œ× ×§×™×™× â€”';
  sel.appendChild(opt0);
  for(const h of headers){
    const o=document.createElement('option');
    o.value=h; o.textContent=h;
    sel.appendChild(o);
  }
  if(preferred){
    sel.value = preferred || '';
  }
}
function parseDateAny(v){
  if(v===null || v===undefined) return null;
  const s = String(v).trim();
  if(!s) return null;

  // ISO yyyy-mm-dd
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m){
    const iso = `${m[1]}-${m[2]}-${m[3]}`;
    return iso;
  }
  // dd/mm/yyyy or dd.mm.yyyy
  m = s.match(/^(\d{1,2})[\/\.](\d{1,2})[\/\.](\d{2,4})/);
  if(m){
    const d = pad2(parseInt(m[1],10));
    const mo = pad2(parseInt(m[2],10));
    let y = parseInt(m[3],10);
    if(y<100) y = 2000 + y;
    return `${y}-${mo}-${d}`;
  }
  // yyyy/mm/dd
  m = s.match(/^(\d{4})[\/\.](\d{1,2})[\/\.](\d{1,2})/);
  if(m){
    const y = m[1];
    const mo = pad2(parseInt(m[2],10));
    const d = pad2(parseInt(m[3],10));
    return `${y}-${mo}-${d}`;
  }
  // last resort: Date.parse
  const t = Date.parse(s);
  if(!Number.isNaN(t)){
    const d = new Date(t);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  return null;
}
function parseHourAny(v){
  if(v===null || v===undefined) return null;
  const s = String(v).trim();
  if(!s) return null;
  // if it's a number 0-23
  if(/^\d{1,2}$/.test(s)){
    const h = parseInt(s,10);
    if(h>=0 && h<=23) return h;
  }
  // HH:MM[:SS]
  const m = s.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if(m){
    const h = parseInt(m[1],10);
    if(h>=0 && h<=23) return h;
  }
  // datetime "yyyy-mm-dd HH:MM"
  const m2 = s.match(/\s(\d{1,2}):(\d{2})/);
  if(m2){
    const h = parseInt(m2[1],10);
    if(h>=0 && h<=23) return h;
  }
  return null;
}
function parseDurationToMinutes(v, unitMode, autoHint){
  if(v===null || v===undefined) return null;
  const s0 = String(v).trim();
  if(!s0) return null;

  // normalize commas
  const s = s0.replace(',', '.');

  const toNum = ()=> {
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  };

  const parseHHMMSS = ()=>{
    const parts = s0.split(':').map(x=>x.trim());
    if(parts.length===3){
      const hh=Number(parts[0]), mm=Number(parts[1]), ss=Number(parts[2]);
      if([hh,mm,ss].every(Number.isFinite)) return hh*60 + mm + ss/60;
    }
    if(parts.length===2){
      const hh=Number(parts[0]), mm=Number(parts[1]);
      if([hh,mm].every(Number.isFinite)) return hh*60 + mm;
    }
    return null;
  };

  if(unitMode==='hhmmss' || unitMode==='hhmm') return parseHHMMSS();

  // auto: detect HH:MM
  if(unitMode==='auto' && s0.includes(':')){
    const hh = parseHHMMSS();
    if(hh!==null) return hh;
  }

  const n = toNum();
  if(n===null) return null;

  if(unitMode==='sec') return n/60.0;
  if(unitMode==='min') return n;

  // auto numeric: guess seconds if very large
  if(unitMode==='auto'){
    if(autoHint==='seconds') return n/60.0;
    if(autoHint==='minutes') return n;
    // heuristic
    if(n>600) return n/60.0;  // >10 hours in minutes is unlikely; better treat as seconds
    return n;
  }

  return n;
}

function timeWindow(h){
  if(h===null) return 'â€”';
  if(h>=6 && h<9) return '×©×™× ×‘×•×§×¨ (06â€“09)';
  if(h>=15 && h<19) return '×©×™× ×¢×¨×‘ (15â€“19)';
  if(h>=9 && h<15) return '×©×¤×œ (09â€“15)';
  return '×œ×™×œ×”/××—×¨';
}
function dayTypeFromISO(iso, wdVal){
  // Prefer provided weekday 1..7 if exists (1=Sun ? depends). We'll map conservatively:
  // If looks like 1..7 and Friday=6, Saturday=7 (common in Israel exports) -> use it.
  const wd = (wdVal===null || wdVal===undefined || wdVal==='') ? null : Number(wdVal);
  if(Number.isFinite(wd)){
    if(wd===6) return '×©×™×©×™';
    if(wd===7) return '×©×‘×ª';
    return '×—×•×œ';
  }
  if(!iso) return '×—×•×œ';
  const d = new Date(iso+'T00:00:00');
  const g = d.getDay(); // 0=Sun
  if(g===5) return '×©×™×©×™';
  if(g===6) return '×©×‘×ª';
  return '×—×•×œ';
}

/* Stats */
function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }
function median(arr){
  const a = arr.slice().sort((x,y)=>x-y);
  const n = a.length;
  if(!n) return null;
  const mid = Math.floor(n/2);
  return (n%2)? a[mid] : (a[mid-1]+a[mid])/2;
}
function percentile(arr, p){
  if(!arr.length) return null;
  const a = arr.slice().sort((x,y)=>x-y);
  const idx = (p/100)*(a.length-1);
  const lo = Math.floor(idx), hi = Math.ceil(idx);
  const w = idx-lo;
  if(hi===lo) return a[lo];
  return a[lo]*(1-w) + a[hi]*w;
}
function std(arr, m){
  const mu = (m!==undefined) ? m : mean(arr);
  const v = arr.reduce((s,x)=>s+(x-mu)*(x-mu),0)/arr.length;
  return Math.sqrt(v);
}
function removeOutliersMAD(values){
  // remove where |x-med| > 4.5 * MAD * 1.4826
  const med = median(values);
  const abs = values.map(v=>Math.abs(v-med));
  const mad = median(abs);
  if(mad===null || mad===0) return {kept:values.slice(), removed:0};
  const scale = 1.4826 * mad;
  const thr = 4.5 * scale;
  const kept = values.filter(v=>Math.abs(v-med) <= thr);
  return {kept, removed: values.length - kept.length};
}
function removeOutliersIQR(values){
  const q1 = percentile(values,25);
  const q3 = percentile(values,75);
  if(q1===null || q3===null) return {kept:values.slice(), removed:0};
  const iqr = q3-q1;
  if(iqr===0) return {kept:values.slice(), removed:0};
  const lo = q1 - 1.5*iqr;
  const hi = q3 + 1.5*iqr;
  const kept = values.filter(v=>v>=lo && v<=hi);
  return {kept, removed: values.length-kept.length};
}

/* Risk score (0..100) */
function riskScore(gapMinutes, cv, n){
  const gapAbs = (gapMinutes===null || gapMinutes===undefined) ? null : Math.abs(gapMinutes);
  const cvPart = Math.min(1, Math.max(0, (cv - 0.18) / (0.55 - 0.18)));      // 0..1
  const gapPart = (gapAbs===null) ? 0.35 : Math.min(1, gapAbs / 6.0);        // 0..1
  const nPart  = Math.min(1, Math.max(0, (12 - (n||0)) / 12));               // 0..1 (×¤×—×•×ª ×“×’×™××•×ª = ×™×•×ª×¨ ×¡×™×›×•×Ÿ)
  const score = 100 * (0.55*cvPart + 0.35*gapPart + 0.10*nPart);
  return Math.max(0, Math.min(100, Math.round(score)));
}

/* Policy engine */
function choosePercentile({winLabel, cv, n, policyMode, manualP}){
  if(policyMode==='manual') return manualP;

  const isPeak = (winLabel.startsWith('×©×™×'));
  let p = isPeak ? 90 : 85;

  if(n<12) p += 3;
  if(cv>=0.40) p += 5;
  else if(cv>=0.25) p += 3;
  else if(cv<=0.12) p -= 2;

  p = Math.max(70, Math.min(97, p));
  return p;
}

/* Drawing */
function clearCanvas(c){
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  // background grid
  ctx.fillStyle = 'rgba(255,255,255,0.02)';
  ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  for(let x=60; x<c.width; x+=120){
    ctx.beginPath(); ctx.moveTo(x,14); ctx.lineTo(x,c.height-34); ctx.stroke();
  }
  for(let y=40; y<c.height-40; y+=50){
    ctx.beginPath(); ctx.moveTo(50,y); ctx.lineTo(c.width-16,y); ctx.stroke();
  }
  return ctx;
}

function drawHistogram(values, rec){
  const c = el.cvHist;
  const ctx = clearCanvas(c);
  if(!values.length) {
    ctx.fillStyle='rgba(255,255,255,.75)';
    ctx.font='14px var(--font)';
    ctx.fillText('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”', 60, 60);
    return;
  }
  const vmin = Math.min(...values);
  const vmax = Math.max(...values);
  const bins = 24;
  const span = Math.max(0.001, (vmax - vmin));
  const step = span / bins;

  const counts = new Array(bins).fill(0);
  for(const v of values){
    let i = Math.floor((v - vmin) / step);
    if(i===bins) i=bins-1;
    if(i>=0 && i<bins) counts[i]++;
  }
  const maxC = Math.max(...counts);

  const W = c.width, H=c.height;
  const left=52, right=14, top=16, bottom=36;
  const innerW = W-left-right;
  const innerH = H-top-bottom;

  // axes labels
  ctx.fillStyle='rgba(255,255,255,.75)';
  ctx.font='12px var(--font)';
  ctx.fillText('×“×§×•×ª', W-60, H-12);
  ctx.fillText('×›××•×ª', 10, 26);

  // bars
  const barW = innerW / bins;
  for(let i=0;i<bins;i++){
    const h = (maxC===0) ? 0 : (counts[i]/maxC)*innerH;
    const x = left + i*barW + 2;
    const y = top + (innerH - h);
    ctx.fillStyle = 'rgba(124,58,237,0.55)';
    ctx.fillRect(x, y, Math.max(1, barW-4), h);
  }

  // rec line
  if(rec!==null && Number.isFinite(rec)){
    const x = left + ((rec - vmin)/span) * innerW;
    ctx.strokeStyle = 'rgba(34,197,94,0.95)';
    ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, top+innerH); ctx.stroke();
    ctx.fillStyle='rgba(34,197,94,0.95)';
    ctx.font='12px var(--font)';
    ctx.fillText(`×ª×§×Ÿ â‰ˆ ${Math.ceil(rec)} ×“×§×³`, Math.min(W-180, x+8), top+14);
  }

  // x ticks
  ctx.fillStyle='rgba(255,255,255,.55)';
  ctx.font='11px var(--font)';
  for(let t=0;t<=4;t++){
    const vv = vmin + (t/4)*span;
    const xx = left + (t/4)*innerW;
    ctx.fillText(vv.toFixed(0), xx-6, H-18);
  }
}

function drawTrend(rowsByHour){
  const c = el.cvTrend;
  const ctx = clearCanvas(c);

  const W=c.width,H=c.height;
  const left=52,right=14,top=16,bottom=36;
  const innerW=W-left-right, innerH=H-top-bottom;

  const xs = Array.from({length:24}, (_,i)=>i);
  const meanY = xs.map(h=>rowsByHour[h]?.mean ?? null);
  const recY  = xs.map(h=>rowsByHour[h]?.rec ?? null);

  const all = meanY.concat(recY).filter(v=>v!==null && Number.isFinite(v));
  if(!all.length){
    ctx.fillStyle='rgba(255,255,255,.75)';
    ctx.font='14px var(--font)';
    ctx.fillText('××™×Ÿ × ×ª×•× ×™ ×©×¢×•×ª ×œ×”×¦×’×”', 60, 60);
    return;
  }
  const ymin = Math.min(...all), ymax = Math.max(...all);
  const span = Math.max(0.001, ymax-ymin);

  // axes labels
  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.font='12px var(--font)';
  ctx.fillText('×©×¢×”', W-52, H-12);
  ctx.fillText('×“×§×•×ª', 10, 26);

  function mapX(h){ return left + (h/23)*innerW; }
  function mapY(v){ return top + (1 - (v-ymin)/span)*innerH; }

  // draw line function
  function drawLine(arr, stroke, width){
    ctx.strokeStyle=stroke; ctx.lineWidth=width; ctx.beginPath();
    let started=false;
    for(let i=0;i<24;i++){
      const v=arr[i];
      if(v===null || !Number.isFinite(v)){ started=false; continue; }
      const x=mapX(i), y=mapY(v);
      if(!started){ ctx.moveTo(x,y); started=true; }
      else ctx.lineTo(x,y);
    }
    ctx.stroke();
    // points
    for(let i=0;i<24;i++){
      const v=arr[i];
      if(v===null || !Number.isFinite(v)) continue;
      const x=mapX(i), y=mapY(v);
      ctx.fillStyle=stroke;
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    }
  }

  drawLine(meanY, 'rgba(160,185,240,0.9)', 2);
  drawLine(recY,  'rgba(124,58,237,0.95)', 3);

  // legend
  ctx.fillStyle='rgba(160,185,240,0.9)'; ctx.fillRect(left+6, top+6, 10, 10);
  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.fillText('×××•×¦×¢', left+22, top+15);
  ctx.fillStyle='rgba(124,58,237,0.95)'; ctx.fillRect(left+70, top+6, 10, 10);
  ctx.fillStyle='rgba(255,255,255,.75)'; ctx.fillText('×ª×§×Ÿ', left+86, top+15);

  // x ticks
  ctx.fillStyle='rgba(255,255,255,.55)'; ctx.font='11px var(--font)';
  for(let h=0;h<24;h+=3){
    ctx.fillText(String(h), mapX(h)-3, H-18);
  }
}

/* ---------- Build mapping UI ---------- */
function rebuildMappingUI(){
  const headers = HEADERS.slice().sort((a,b)=>a.localeCompare(b,'he'));
  fillSelect(el.mDate, headers, bestHeader(headers,SYN.date));
  fillSelect(el.mTime, headers, bestHeader(headers,SYN.time));
  fillSelect(el.mDur,  headers, bestHeader(headers,SYN.dur));
  fillSelect(el.mCluster, headers, bestHeader(headers,SYN.cluster));
  fillSelect(el.mMakt, headers, bestHeader(headers,SYN.makt));
  fillSelect(el.mRoute, headers, bestHeader(headers,SYN.route));
  fillSelect(el.mDir, headers, bestHeader(headers,SYN.dir));
  fillSelect(el.mPlan, headers, bestHeader(headers,SYN.plan));
  fillSelect(el.mWD, headers, bestHeader(headers,SYN.wd));
}

/* ---------- Normalize ---------- */
function applyMapping(){
  hideError(); hideWarn();
  DROPPED = {missing:0, invalid:0, parse:0, dateRange:0, excluded:0, outlier:0};
  DATA = [];
  LAST_TABLE = [];

  M = {
    date: el.mDate.value,
    time: el.mTime.value,
    dur:  el.mDur.value,
    cluster: el.mCluster.value,
    makt: el.mMakt.value,
    route: el.mRoute.value,
    dir: el.mDir.value,
    plan: el.mPlan.value,
    wd: el.mWD.value,
    unit: el.durUnit.value,
    gran: el.gran.value,
    outMode: el.outMode.value,
    minN: Math.max(3, parseInt(el.minN.value,10) || 10)
  };

  if(!M.date || !M.time || !M.dur){
    showError("×—×¡×¨ ××™×¤×•×™ ×—×•×‘×”: ×ª××¨×™×š + ×©×¢×” + ××©×š ×‘×¤×•×¢×œ.");
    return false;
  }

  // unit hint (auto)
  let autoHint = null;
  if(M.unit==='auto'){
    const sample = ALL_ROWS.slice(0, 200).map(r=>r?.[M.dur]).filter(v=>v!==undefined && v!==null && String(v).trim()!=='');
    const nums = sample.map(v=>{
      const s=String(v).trim();
      if(s.includes(':')) return null;
      const n = Number(String(v).replace(',','.'));
      return Number.isFinite(n)?n:null;
    }).filter(n=>n!==null);
    if(nums.length){
      const med = percentile(nums,50);
      // if median > 600 (10h minutes) probably seconds; if between 120..600 ambiguous but still often seconds
      if(med>600) autoHint='seconds';
      else if(med>200) autoHint='seconds';
      else autoHint='minutes';
    }
  }

  for(const r of ALL_ROWS){
    try{
      const dateISO = parseDateAny(r[M.date]);
      const hour = parseHourAny(r[M.time]);
      const durMin = parseDurationToMinutes(r[M.dur], M.unit, autoHint);

      if(!dateISO || hour===null || durMin===null){
        DROPPED.missing++; continue;
      }
      if(!(durMin>0) || durMin<1 || durMin>360){
        DROPPED.invalid++; continue;
      }

      const cluster = (M.cluster && r[M.cluster]!==undefined && r[M.cluster]!==null && String(r[M.cluster]).trim()!=='') ? String(r[M.cluster]).trim() : '×›×œ×œ×™';
      const makt = (M.makt && r[M.makt]!==undefined && r[M.makt]!==null && String(r[M.makt]).trim()!=='') ? String(r[M.makt]).trim() : 'â€”';
      const route = (M.route && r[M.route]!==undefined && r[M.route]!==null && String(r[M.route]).trim()!=='') ? String(r[M.route]).trim() : 'â€”';
      const dir = (M.dir && r[M.dir]!==undefined && r[M.dir]!==null && String(r[M.dir]).trim()!=='') ? String(r[M.dir]).trim() : 'â€”';
      const wdRaw = (M.wd ? r[M.wd] : null);
      const dayType = dayTypeFromISO(dateISO, wdRaw);
      const winLabel = timeWindow(hour);

      let plannedMin = null;
      if(M.plan){
        plannedMin = parseDurationToMinutes(r[M.plan], M.unit, autoHint);
        if(plannedMin!==null && (!Number.isFinite(plannedMin) || plannedMin<=0)) plannedMin=null;
      }

      DATA.push({cluster, makt, route, dir, dateISO, hour, dayType, winLabel, durMin, plannedMin});
    }catch(e){
      DROPPED.parse++;
    }
  }

  el.okCount.textContent = String(DATA.length);
  el.outCount.textContent = "0";

  if(DATA.length===0){
    showError("×œ× × ×•×¦×¨×• ×¨×©×•××•×ª ×ª×§×™× ×•×ª ××—×¨×™ ××™×¤×•×™. ×‘×“×•×§ ×™×—×™×“×•×ª (×©× ×™×•×ª/×“×§×•×ª) ××• ×¢××•×“×•×ª.");
    return false;
  }

  // populate filters from DATA
  populateFilters();
  el.main.style.display = 'grid';
  updateAll();

  return true;
}

/* ---------- Filters ---------- */
function uniq(arr){ return Array.from(new Set(arr)); }
function addOpt(sel, val, txt){
  const o=document.createElement('option');
  o.value=val; o.textContent=txt;
  sel.appendChild(o);
}
function populateFilters(){
  // Cluster
  const clusters = uniq(DATA.map(d=>d.cluster)).sort((a,b)=>a.localeCompare(b,'he'));
  el.fCluster.innerHTML='';
  addOpt(el.fCluster,'all','×›×œ ×”××©×›×•×œ×•×ª');
  clusters.forEach(c=>addOpt(el.fCluster,c,c));

  // Makt
  rebuildMaktsAndRoutes();

  // Direction
  const dirs = uniq(DATA.map(d=>d.dir)).sort();
  el.fDir.innerHTML='';
  addOpt(el.fDir,'all','×”×›×œ');
  dirs.forEach(x=>addOpt(el.fDir,x,x));

  // Day type
  el.fDay.innerHTML='';
  addOpt(el.fDay,'all','×”×›×œ');
  ['×—×•×œ','×©×™×©×™','×©×‘×ª'].forEach(x=>addOpt(el.fDay,x,x));

  // Window
  el.fWin.innerHTML='';
  addOpt(el.fWin,'all','×”×›×œ');
  uniq(DATA.map(d=>d.winLabel)).forEach(x=>addOpt(el.fWin,x,x));

  // Hour
  el.fHour.innerHTML='';
  addOpt(el.fHour,'all','×›×œ ×”×©×¢×•×ª');
  for(let h=0;h<24;h++) addOpt(el.fHour,String(h), `${pad2(h)}:00â€“${pad2(h)}:59`);

  // date defaults
  const dates = uniq(DATA.map(d=>d.dateISO)).sort();
  el.fFrom.value = dates[0] || '';
  el.fTo.value = dates[dates.length-1] || '';
}

function rebuildMaktsAndRoutes(){
  const c = el.fCluster.value;
  const scoped = (c==='all') ? DATA : DATA.filter(d=>d.cluster===c);

  const makts = uniq(scoped.map(d=>d.makt)).sort((a,b)=>a.localeCompare(b,'he'));
  const routes = uniq(scoped.map(d=>d.route)).sort((a,b)=>a.localeCompare(b,'he'));

  const keepM = el.fMakt.value;
  const keepR = el.fRoute.value;

  el.fMakt.innerHTML=''; addOpt(el.fMakt,'all','×”×›×œ');
  makts.forEach(x=>addOpt(el.fMakt,x,x));
  el.fRoute.innerHTML=''; addOpt(el.fRoute,'all','×”×›×œ');
  routes.forEach(x=>addOpt(el.fRoute,x,x));

  if(makts.includes(keepM)) el.fMakt.value = keepM; else el.fMakt.value='all';
  if(routes.includes(keepR)) el.fRoute.value = keepR; else el.fRoute.value='all';
}

function inRange(dateISO, fromISO, toISO){
  if(!fromISO && !toISO) return true;
  if(fromISO && dateISO < fromISO) return false;
  if(toISO && dateISO > toISO) return false;
  return true;
}
function isExcluded(dateISO){
  for(const r of EX_RANGES){
    if(dateISO>=r.fromISO && dateISO<=r.toISO) return true;
  }
  return false;
}

/* ---------- Compute & Render ---------- */
function updateAll(){
  hideError(); hideWarn();

  const fc = el.fCluster.value;
  const fm = el.fMakt.value;
  const fr = el.fRoute.value;
  const fd = el.fDir.value;
  const fday = el.fDay.value;
  const fwin = el.fWin.value;
  const fh = el.fHour.value;

  const from = el.fFrom.value || '';
  const to = el.fTo.value || '';

  let rows = DATA.filter(d=>{
    if(fc!=='all' && d.cluster!==fc) return false;
    if(fm!=='all' && d.makt!==fm) return false;
    if(fr!=='all' && d.route!==fr) return false;
    if(fd!=='all' && d.dir!==fd) return false;
    if(fday!=='all' && d.dayType!==fday) return false;
    if(fwin!=='all' && d.winLabel!==fwin) return false;
    if(fh!=='all' && d.hour!==Number(fh)) return false;

    if(!inRange(d.dateISO, from, to)) return false;
    if(isExcluded(d.dateISO)) return false;
    return true;
  });

  // KPI for selected slice
  const durs = rows.map(r=>r.durMin);
  const n = durs.length;

  if(n<1){
    el.kN.textContent='0';
    el.kMean.textContent='â€”';
    el.kRec.textContent='â€”';
    el.kPct.textContent='â€”';
    el.kCV.textContent='â€”';
    drawHistogram([], null);
    drawTrend({});
    el.tbl.innerHTML = `<tr><td colspan="21" class="muted">××™×Ÿ × ×ª×•× ×™× ×‘×”×ª×× ×œ×¡×™× ×•×Ÿ.</td></tr>`;
    el.topWorst.innerHTML = `<tr><td colspan="12" class="muted">××™×Ÿ × ×ª×•× ×™×.</td></tr>`;
    el.topBest.innerHTML = `<tr><td colspan="12" class="muted">××™×Ÿ × ×ª×•× ×™×.</td></tr>`;
    el.ops.innerHTML = '';
    return;
  }

  const mu = mean(durs);
  const sd = std(durs, mu);
  const cv = (mu>0) ? sd/mu : 0;

  // choose percentile for KPI (based on window label if a single window; else treat as 'mixed' and use dynamic base 88)
  const policyMode = el.policy.value;
  const manualP = parseInt(el.pct.value,10);
  const winLabel = (el.fWin.value!=='all') ? el.fWin.value : 'mixed';
  const pChosen = (winLabel==='mixed' && policyMode==='dynamic') ? 88 : choosePercentile({winLabel, cv, n, policyMode, manualP});
  const rec = percentile(durs, pChosen);

  el.kN.textContent = String(n);
  el.kMean.textContent = mu.toFixed(1);
  el.kRec.textContent = String(Math.ceil(rec));
  el.kPct.textContent = `P${pChosen}`;
  el.kCV.textContent = cv.toFixed(2);

  drawHistogram(durs, rec);

  // Build per-hour stats for trend (based on selected slice)
  const byHour = {};
  for(let h=0;h<24;h++){
    const hd = rows.filter(r=>r.hour===h).map(r=>r.durMin);
    if(hd.length){
      const m=mean(hd), s=std(hd,m), c=(m>0)?(s/m):0;
      const w = timeWindow(h);
      const p = choosePercentile({winLabel:w, cv:c, n:hd.length, policyMode, manualP});
      const r = percentile(hd, p);
      byHour[h] = {mean:m, rec:r};
    }
  }
  drawTrend(byHour);

  // Full table (grouped)
  computeTableAndTop(rows);
  renderOps();
}

function computeTableAndTop(rows){
  const gran = M?.gran || el.gran.value;
  const policyMode = el.policy.value;
  const manualP = parseInt(el.pct.value,10);

  // group key
  const groups = new Map();

  for(const r of rows){
    const label = (gran==='hour') ? `${pad2(r.hour)}:00` : r.winLabel;
    const key = `${r.cluster}||${r.makt}||${r.route}||${r.dir}||${label}`;
    if(!groups.has(key)){
      groups.set(key, {cluster:r.cluster, makt:r.makt, route:r.route, dir:r.dir, label, durs:[], plans:[]});
    }
    const g = groups.get(key);
    g.durs.push(r.durMin);
    if(r.plannedMin!==null && Number.isFinite(r.plannedMin)) g.plans.push(r.plannedMin);
  }

  const minN = Math.max(3, parseInt(el.minN.value,10) || 10);
  const outMode = el.outMode.value;

  const outRows = [];
  let outRemoved = 0;

  for(const g of groups.values()){
    const rawN = g.durs.length;
    let durs = g.durs.slice();

    // outlier cleaning per group
    let removed = 0;
    if(outMode==='mad'){
      const res = removeOutliersMAD(durs);
      durs = res.kept;
      removed = res.removed;
    } else if(outMode==='iqr'){
      const res = removeOutliersIQR(durs);
      durs = res.kept;
      removed = res.removed;
    }
    outRemoved += removed;

    if(durs.length < minN) continue;

    const mu = mean(durs);
    const med = median(durs);
    const sd = std(durs, mu);
    const cv = (mu>0) ? sd/mu : 0;

    const p85 = percentile(durs,85);
    const p90 = percentile(durs,90);
    const p95 = percentile(durs,95);

    // planned
    const plannedMed = (g.plans.length>=3) ? median(g.plans) : (g.plans.length? median(g.plans): null);

    // choose percentile dynamically
    const winLabel = (gran==='hour') ? timeWindow(parseInt(g.label,10)) : g.label;
    const pChosen = choosePercentile({winLabel, cv, n:durs.length, policyMode, manualP});
    const rec = percentile(durs, pChosen);

    const gap = (plannedMed===null) ? null : (rec - plannedMed);
    const risk = riskScore(gap, cv, durs.length);

    let status = 'âœ…';
    if(cv>=0.25) status='âš ï¸ ×©×•× ×•×ª';
    if(cv>=0.45) status='ğŸš¨ ×©×•× ×•×ª ×§×™×¦×•× ×™×ª';

    outRows.push({
      cluster:g.cluster, makt:g.makt, route:g.route, dir:g.dir, label:g.label,
      n_raw: rawN, n_used: durs.length, removed,
      mean:mu, median:med, std:sd, cv,
      p85, p90, p95,
      planned: plannedMed,
      gap,
      rec,
      pct: `P${pChosen}`,
      risk,
      status
    });
  }

  el.outCount.textContent = String(outRemoved);

  // sort table: by risk desc then shortage desc
  outRows.sort((a,b)=>{
    const ra=b.risk - a.risk;
    if(ra!==0) return ra;
    const ga = Math.abs((b.gap??0)) - Math.abs((a.gap??0));
    if(ga!==0) return ga;
    return String(a.makt).localeCompare(String(b.makt),'he');
  });

  LAST_TABLE = outRows.slice();

  // render main table
  if(!outRows.length){
    el.tbl.innerHTML = `<tr><td colspan="21" class="muted">××™×Ÿ ×§×‘×•×¦×•×ª ×©×¢×‘×¨×• ×¡×£ ××™× ×™××•× N ××—×¨×™ × ×™×§×•×™. ×”×•×¨×“ Minâ€‘N ××• ×”×¨×—×‘ ×¤×™×œ×˜×¨×™×.</td></tr>`;
  } else {
    el.tbl.innerHTML = outRows.map(r=>{
      const gapTxt = (r.gap===null) ? 'â€”' : (r.gap>0 ? ('+'+r.gap.toFixed(1)) : r.gap.toFixed(1));
      const gapCls = (r.gap===null) ? '' : (Math.abs(r.gap)>=3 ? (r.gap>0?'badge bad':'badge good') : 'badge');
      const riskCls = r.risk>=70 ? 'badge bad' : (r.risk>=40 ? 'badge warn' : 'badge good');
      const recCell = `
        <div class="row" style="gap:8px;justify-content:flex-start">
          <span class="mono" style="font-weight:900;color:#e8dbff">${Math.ceil(r.rec)}</span>
          <span class="badge purp mono">${escapeHtml(r.pct)}</span>
        </div>`;
      return `<tr>
        <td>${escapeHtml(r.cluster)}</td>
        <td class="mono" style="font-weight:900">${escapeHtml(r.makt)}</td>
        <td class="mono">${escapeHtml(r.route)}</td>
        <td class="mono">${escapeHtml(r.dir)}</td>
        <td>${escapeHtml(r.label)}</td>
        <td class="mono">${r.n_raw}</td>
        <td class="mono">${r.n_used}</td>
        <td class="mono">${r.removed}</td>
        <td class="mono">${r.mean.toFixed(1)}</td>
        <td class="mono">${r.median.toFixed(1)}</td>
        <td class="mono">${r.std.toFixed(1)}</td>
        <td class="mono">${r.cv.toFixed(2)}</td>
        <td class="mono">${r.p85.toFixed(1)}</td>
        <td class="mono">${r.p90.toFixed(1)}</td>
        <td class="mono">${r.p95.toFixed(1)}</td>
        <td class="mono">${(r.planned===null)?'â€”':r.planned.toFixed(1)}</td>
        <td><span class="${gapCls} mono">${gapTxt}</span></td>
        <td>${recCell}</td>
        <td class="mono">${escapeHtml(r.pct)}</td>
        <td><span class="${riskCls} mono">${r.risk}</span></td>
        <td>${escapeHtml(r.status)}</td>
      </tr>`;
    }).join('');
  }

  // top10 worst/best by shortage/excess (requires planned)
  const withPlan = outRows.filter(r=>r.planned!==null && Number.isFinite(r.planned));
  const worst = withPlan.filter(r=>r.gap!==null && r.gap>0.01).sort((a,b)=>(b.gap-a.gap) || (b.risk-a.risk)).slice(0,10);
  const best  = withPlan.filter(r=>r.gap!==null && r.gap<-0.01).sort((a,b)=>(a.gap-b.gap) || (b.risk-a.risk)).slice(0,10);

  function rowTop(r, mode){
    const gapTxt = (r.gap===null) ? 'â€”' : (r.gap>0 ? ('+'+r.gap.toFixed(1)) : r.gap.toFixed(1));
    const riskCls = r.risk>=70 ? 'badge bad' : (r.risk>=40 ? 'badge warn' : 'badge good');
    const cvTxt = r.cv.toFixed(2);
    const recCell = `<span class="mono" style="font-weight:900;color:#e8dbff">${Math.ceil(r.rec)}</span> <span class="badge purp mono">${escapeHtml(r.pct)}</span>`;
    const tail = (mode==='worst') ? (r.gap.toFixed(1)) : (Math.abs(r.gap).toFixed(1));
    const tailTxt = (mode==='worst') ? (`+${tail}`) : (`${tail}`);
    return `<tr>
      <td>${escapeHtml(r.cluster)}</td>
      <td class="mono" style="font-weight:900">${escapeHtml(r.makt)}</td>
      <td class="mono">${escapeHtml(r.route)}</td>
      <td class="mono">${escapeHtml(r.dir)}</td>
      <td>${escapeHtml(r.label)}</td>
      <td class="mono">${r.n_used}</td>
      <td class="mono">${r.planned.toFixed(1)}</td>
      <td class="mono">${cvTxt}</td>
      <td>${recCell}</td>
      <td class="mono">${gapTxt}</td>
      <td><span class="${riskCls} mono">${r.risk}</span></td>
      <td class="mono" style="font-weight:900;color:${mode==='worst' ? '#ffd0d0' : '#bff7e7'}">${tailTxt}</td>
    </tr>`;
  }

  if(!withPlan.length){
    el.topWorst.innerHTML = `<tr><td colspan="12" class="muted">××™×Ÿ Planned ××–×•×”×” ×‘×§×‘×¦×™× â€” Topâ€‘10 ×—×•×¡×¨/×¢×•×“×£ ×“×•×¨×© ×¢××•×“×ª ×ª×›× ×•×Ÿ.</td></tr>`;
    el.topBest.innerHTML = `<tr><td colspan="12" class="muted">××™×Ÿ Planned ××–×•×”×” ×‘×§×‘×¦×™× â€” Topâ€‘10 ×—×•×¡×¨/×¢×•×“×£ ×“×•×¨×© ×¢××•×“×ª ×ª×›× ×•×Ÿ.</td></tr>`;
  } else {
    el.topWorst.innerHTML = worst.length ? worst.map(r=>rowTop(r,'worst')).join('') : `<tr><td colspan="12" class="muted">××™×Ÿ ×—×•×¡×¨ ×ª×§×Ÿ ×‘××“×’× (Gap ×—×™×•×‘×™).</td></tr>`;
    el.topBest.innerHTML  = best.length  ? best.map(r=>rowTop(r,'best')).join('')  : `<tr><td colspan="12" class="muted">××™×Ÿ ×¢×•×“×£ ×ª×§×Ÿ ×‘××“×’× (Gap ×©×œ×™×œ×™).</td></tr>`;
  }
}

/* ---------- Ops recommendations ---------- */
function renderOps(){
  el.ops.innerHTML = '';
  if(!LAST_TABLE.length) return;

  // pick top 6 by risk
  const top = LAST_TABLE.slice().sort((a,b)=>b.risk-a.risk).slice(0,6);

  const items = [];
  const hasPlan = top.some(r=>r.planned!==null);

  for(const r of top){
    const isPeak = r.label.startsWith('×©×™×') || (r.label.includes(':') && timeWindow(parseInt(r.label,10)).startsWith('×©×™×'));
    const gap = r.gap;
    if(gap!==null && gap>1){
      items.push(`×”×’×“×œ ×ª×§×Ÿ ×‘×§×‘×•×¦×”: ××©×›×•×œ <b>${escapeHtml(r.cluster)}</b>, ××§×´×˜ <b>${escapeHtml(r.makt)}</b>, ×§×• <b>${escapeHtml(r.route)}</b>, ×›×™×•×•×Ÿ <b>${escapeHtml(r.dir)}</b>, ${escapeHtml(r.label)} â€” <b>×—×•×¡×¨</b> ${gap.toFixed(1)} ×“×§×³ (Risk ${r.risk}).`);
    } else if(gap!==null && gap<-1){
      items.push(`×‘×“×•×§ ××¤×©×¨×•×ª ×œ×¦××¦×•× ×ª×§×Ÿ ×‘×–×”×™×¨×•×ª: ××©×›×•×œ <b>${escapeHtml(r.cluster)}</b>, ××§×´×˜ <b>${escapeHtml(r.makt)}</b>, ×§×• <b>${escapeHtml(r.route)}</b>, ${escapeHtml(r.label)} â€” <b>×¢×•×“×£</b> ${Math.abs(gap).toFixed(1)} ×“×§×³ (Risk ${r.risk}).`);
    } else {
      items.push(`Risk ×’×‘×•×” ×‘×’×œ×œ ×©×•× ×•×ª/CV: ××©×›×•×œ <b>${escapeHtml(r.cluster)}</b>, ××§×´×˜ <b>${escapeHtml(r.makt)}</b>, ×§×• <b>${escapeHtml(r.route)}</b>, ${escapeHtml(r.label)} â€” CV ${r.cv.toFixed(2)}. ×©×§×•×œ ×˜×™×¤×•×œ ×ª×¤×¢×•×œ×™ (×¤×™×§×•×—/×¢×•××¡/×ª×©×ª×™×ª) ×•×œ× ×¨×§ ×“×§×•×ª.`);
    }

    if(isPeak){
      items.push(`×‘×©×™×: ×•×“× ×–××Ÿ ×”×ª××•×©×©×•×ª/Recovery × ×¤×¨×“ ×›×“×™ ×œ× â€œ×œ××›×•×œâ€ ×××™× ×•×ª ×‘×™×Ÿ × ×¡×™×¢×•×ª ×¨×¦×•×¤×•×ª ×‘×§×‘×•×¦×” ${escapeHtml(r.label)}.`);
    }
  }

  const uniqItems = Array.from(new Set(items)).slice(0,10);
  for(const it of uniqItems){
    const li=document.createElement('li');
    li.innerHTML = it;
    el.ops.appendChild(li);
  }

  if(!hasPlan){
    const li=document.createElement('li');
    li.innerHTML = `××™×Ÿ ×¢××•×“×ª <b>Planned</b> ××–×•×”×” â€” Topâ€‘10 ×—×•×¡×¨/×¢×•×“×£ ××ª×‘×¡×¡ ×¢×œ ×ª×›× ×•×Ÿ. ×¢×“×™×™×Ÿ ××¤×©×¨ ×œ×¢×‘×•×“ ×œ×¤×™ ××—×•×–×•× ×™× (Rec + Pct).`;
    el.ops.appendChild(li);
  }
}

/* ---------- Exclusion ranges ---------- */
function renderExList(){
  if(!EX_RANGES.length){
    el.exList.innerHTML = '<span class="muted">××™×Ÿ ×”×—×¨×’×•×ª.</span>';
    return;
  }
  el.exList.innerHTML = EX_RANGES.map((r,i)=>{
    return `<span class="badge mono">âŒ ${r.fromISO} â†’ ${r.toISO} <button class="btn small" data-ex="${i}" style="margin-right:8px">×”×¡×¨</button></span>`;
  }).join(' ');
  // bind remove buttons
  el.exList.querySelectorAll('button[data-ex]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const idx = parseInt(b.getAttribute('data-ex'),10);
      EX_RANGES.splice(idx,1);
      renderExList();
      updateAll();
    });
  });
}

function addExRange(){
  const a = el.exFrom.value, b = el.exTo.value;
  if(!a || !b){ showWarn("×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•× ×œ×”×—×¨×’×”."); return; }
  const fromISO = (a<=b) ? a : b;
  const toISO = (a<=b) ? b : a;
  EX_RANGES.push({fromISO, toISO});
  // merge overlaps
  EX_RANGES.sort((x,y)=>x.fromISO.localeCompare(y.fromISO));
  const merged=[];
  for(const r of EX_RANGES){
    if(!merged.length) merged.push({...r});
    else{
      const last = merged[merged.length-1];
      if(r.fromISO <= last.toISO){
        last.toISO = (r.toISO>last.toISO) ? r.toISO : last.toISO;
      }else merged.push({...r});
    }
  }
  EX_RANGES = merged;
  renderExList();
  updateAll();
}

/* ---------- Export ---------- */
function csvEscape(v){
  const s = (v===null || v===undefined) ? '' : String(v);
  return /[",\n\r]/.test(s) ? ('"'+s.replace(/"/g,'""')+'"') : s;
}
function toCSV(rows){
  if(!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const lines=[];
  lines.push(headers.map(csvEscape).join(','));
  for(const r of rows){
    lines.push(headers.map(h=>csvEscape(r[h])).join(','));
  }
  return lines.join('\r\n');
}
function downloadText(filename, text, mime){
  const blob = new Blob([text], {type: mime || 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}
function exportCSV(){
  if(!LAST_TABLE.length){ showWarn("××™×Ÿ ×ª×•×¦××•×ª ×œ×™×™×¦×•× (×”×˜×‘×œ×” ×¨×™×§×”)."); return; }
  const rows = LAST_TABLE.map(r=>({
    cluster:r.cluster, makt:r.makt, route:r.route, direction:r.dir, label:r.label,
    n_raw:r.n_raw, n_used:r.n_used, removed:r.removed,
    mean_minutes:r.mean.toFixed(3), median_minutes:r.median.toFixed(3), std_minutes:r.std.toFixed(3), cv:r.cv.toFixed(4),
    p85:r.p85.toFixed(3), p90:r.p90.toFixed(3), p95:r.p95.toFixed(3),
    planned_median:(r.planned===null?'':r.planned.toFixed(3)),
    gap_minutes:(r.gap===null?'':r.gap.toFixed(3)),
    rec_minutes:r.rec.toFixed(3),
    percentile:r.pct,
    risk:r.risk,
    status:r.status
  }));
  downloadText('recommended_standards.csv', toCSV(rows), 'text/csv;charset=utf-8');
}
function exportJSON(){
  if(!LAST_TABLE.length){ showWarn("××™×Ÿ ×ª×•×¦××•×ª ×œ×™×™×¦×•×."); return; }
  downloadText('recommended_standards.json', JSON.stringify(LAST_TABLE, null, 2), 'application/json;charset=utf-8');
}
function toYAML(rows){
  // Simple YAML (list of objects)
  const esc = (s)=> String(s??'').replace(/"/g,'\\"');
  let out = 'recommended_standards:\n';
  for(const r of rows){
    out += `  - cluster: "${esc(r.cluster)}"\n`;
    out += `    makt: "${esc(r.makt)}"\n`;
    out += `    route: "${esc(r.route)}"\n`;
    out += `    direction: "${esc(r.dir)}"\n`;
    out += `    label: "${esc(r.label)}"\n`;
    out += `    rec_minutes: ${Number(r.rec.toFixed(3))}\n`;
    out += `    percentile: "${esc(r.pct)}"\n`;
    out += `    n_used: ${r.n_used}\n`;
    out += `    cv: ${Number(r.cv.toFixed(4))}\n`;
    out += `    planned_median: ${r.planned===null ? 'null' : Number(r.planned.toFixed(3))}\n`;
    out += `    gap_minutes: ${r.gap===null ? 'null' : Number(r.gap.toFixed(3))}\n`;
    out += `    risk: ${r.risk}\n`;
  }
  return out;
}
function exportYAML(){
  if(!LAST_TABLE.length){ showWarn("××™×Ÿ ×ª×•×¦××•×ª ×œ×™×™×¦×•×."); return; }
  downloadText('recommended_standards.yaml', toYAML(LAST_TABLE), 'text/yaml;charset=utf-8');
}

/* ---------- Events ---------- */
el.btnPick.addEventListener('click', ()=> el.file.click());
el.file.addEventListener('change', async (e)=>{
  const files = e.target.files;
  if(!files || !files.length) return;

  setLoading(true, '×§×•×¨× ×§×‘×¦×™×â€¦');
  await parseFiles(files);
  setLoading(false, '');

  if(!ALL_ROWS.length){
    showError('×œ× ×”×¦×œ×—×ª×™ ×œ×§×¨×•× ×§×‘×¦×™×. ×‘×“×•×§ ×©×–×” CSV ×ª×§×™×Ÿ.');
    return;
  }
  rebuildMappingUI();
  showWarn('×‘×—×¨/×××ª ××™×¤×•×™ ×¢××•×“×•×ª ×•××– ×œ×—×¥ â€œ×™×™×©× ××™×¤×•×™ + ×—×©×‘â€.');
});
el.btnReset.addEventListener('click', ()=>{
  FILES=[]; ALL_ROWS=[]; HEADERS=[];
  DATA=[]; LAST_TABLE=[];
  EX_RANGES=[];
  el.filesCount.textContent='0';
  el.filesList.innerHTML='';
  el.rawCount.textContent='0';
  el.okCount.textContent='0';
  el.outCount.textContent='0';
  el.main.style.display='none';
  el.tbl.innerHTML='';
  el.topWorst.innerHTML='';
  el.topBest.innerHTML='';
  el.ops.innerHTML='';
  renderExList();
  hideError(); hideWarn();
});
el.drop.addEventListener('dragover', (e)=>{ e.preventDefault(); el.drop.classList.add('drag'); });
el.drop.addEventListener('dragleave', ()=> el.drop.classList.remove('drag'));
el.drop.addEventListener('drop', async (e)=>{
  e.preventDefault(); el.drop.classList.remove('drag');
  const files = e.dataTransfer.files;
  if(!files || !files.length) return;

  setLoading(true,'×§×•×¨× ×§×‘×¦×™×â€¦');
  await parseFiles(files);
  setLoading(false,'');

  if(!ALL_ROWS.length){
    showError('×œ× ×”×¦×œ×—×ª×™ ×œ×§×¨×•× ×§×‘×¦×™×. ×‘×“×•×§ ×©×–×” CSV ×ª×§×™×Ÿ.');
    return;
  }
  rebuildMappingUI();
  showWarn('×‘×—×¨/×××ª ××™×¤×•×™ ×¢××•×“×•×ª ×•××– ×œ×—×¥ â€œ×™×™×©× ××™×¤×•×™ + ×—×©×‘â€.');
});

el.btnApplyMap.addEventListener('click', ()=>{
  const ok = applyMapping();
  if(ok){
    hideWarn();
    renderExList();
    showWarn('×˜×™×¤: ×¢×›×©×™×• ××¤×©×¨ ×œ×¡× ×Ÿ ×ª××¨×™×›×™× ×•×œ×”×—×¨×™×’ ×˜×•×•×—×™× (×”×¤×’× ×•×ª/×—×•×¨×£).');
  }
});

[el.fCluster, el.fMakt, el.fRoute, el.fDir, el.fDay, el.fWin, el.fHour, el.fFrom, el.fTo].forEach(x=>{
  x.addEventListener('change', ()=>{
    if(x===el.fCluster){
      // reset dependent filters to avoid "stuck route"
      el.fMakt.value='all';
      el.fRoute.value='all';
      rebuildMaktsAndRoutes();
    }
    updateAll();
  });
});

el.btnAddEx.addEventListener('click', addExRange);

el.policy.addEventListener('change', ()=>{
  el.manualBox.style.display = (el.policy.value==='manual') ? 'block' : 'none';
  updateAll();
});
el.pct.addEventListener('input', ()=>{
  el.pctTxt.textContent = `P${el.pct.value}`;
  updateAll();
});

el.btnExport.addEventListener('click', exportCSV);
el.btnExportJSON.addEventListener('click', exportJSON);
el.btnExportYAML.addEventListener('click', exportYAML);

/* modal */
el.btnHelp.addEventListener('click', ()=>{
  el.modalBack.style.display='flex';
});
el.btnClose.addEventListener('click', ()=>{
  el.modalBack.style.display='none';
});
el.modalBack.addEventListener('click', (e)=>{
  if(e.target===el.modalBack) el.modalBack.style.display='none';
});

/* init */
updateDepState();
renderExList();
</script>
</body>
</html>
